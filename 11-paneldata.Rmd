# パネルデータ分析（作成中） {#paneldata}

**この章は現在作成中です（2025-11-28）**

本章では、パネルデータ分析の基礎について説明する。

内容に入る前に、右上のプロジェクトのボックスの横が、前章で作成したプロジェクトの名前（たとえば、seminar_sociology_r）になっているかどうかを確認しておこう。なっていない場合は、右上のボックスをクリックして、「Open Project...」を選択し、前章で作成したRprojファイル（たとえば、seminar_sociology_r.Rprojといったような名前になっている）を選んで、プロジェクトを切り替えよう。

```{r}
library(tidyverse)
library(gtsummary)
library(flextable)
library(haven)
library(modelsummary)
```

本章では新たに以下のパッケージを利用する。あらかじめインストールしておくこと。

```{r, eval = FALSE}
install.packages("fixest") # 固定効果モデルを推定するためのパッケージ
```

パッケージを読み込んでおく。

```{r}
library(fixest)
```

## パネルデータとは

同じ個体を複数の時点で観察したデータを指して**パネルデータ**とよぶ。たとえば、同一の個人に対して同一の項目を尋ねる調査を複数時点にわたって繰り返し尋ねると、同一個人のとる値が時点間でどのように変化していくのかを明らかにすることができる。パネルデータを用いることによって、個体の変化、あるいは変化の効果を明らかにすることができる。

### wide形式とlong形式

パネルデータを記録する場合の形式として、wide形式とlong形式という2つの形式がある。

wide形式では、1つの行が1つの個体を表し、各時点の観察値が別々の列に格納される。たとえば、4回の調査を行って、N人の個人から、賃金（時給）に関するデータを繰り返し集めたとしよう。このようにして賃金にそれぞれwage1, wage2, wage3, wage4という名前をつけて、下記のように記録したとする。

| id  | birthyear | wage1 | wage2 | wage3 | wage4 |
|-----|-----------|-------|-------|-------|-------|
| 1   | 1980      | 1200  | 1250  | 1260  | 1300  |
| 2   | 1966      | 2000  | 2300  | 1600  | NA    |
| 3   | 2005      | 1100  | NA    | NA    | NA    |
| ... |           |       |       |       |       |
| N   | 1992      | 3000  | 3000  | 3000  | 3300  |

: Wide形式データの架空例（1つの行が1つの個体）

idは個々人に付与されるID、birthyearは出生年を表す。たとえばid = 1の個人は1980年生まれで、1回目の調査では時給1200円、2回目の調査では時給1250円、3回目の調査では時給1260円、4回目の調査では時給1300円である。

なお、調査によって回答を収集する場合、一度回答してくれた人がその後もずっと調査に回答してくれるとは限らない。たとえばid = 2の個人は1966年生まれで、1, 2, 3回目の調査には回答してくれたが、4回目の調査には回答せず、したがって4回目調査時点の時給はわからない。同じように、id = 3の個人は2005年生まれで、1回目の調査では回答したものの、その後は回答が得られなかった。

このように1つの行が1つの個体を表すwide形式に対して、long形式は、1つの行が1回分の**観察 observation**を表す。先ほどのデータをlong形式に変換した場合には、次のようになる。

| id  | time | birthyear | wage |
|-----|------|-----------|------|
| 1   | 1    | 1980      | 1200 |
| 1   | 2    | 1980      | 1250 |
| 1   | 3    | 1980      | 1260 |
| 1   | 4    | 1980      | 1300 |
| 2   | 1    | 1966      | 2000 |
| 2   | 2    | 1966      | 2300 |
| 2   | 3    | 1966      | 1600 |
| 3   | 1    | 2005      | 1100 |
| ... |      |           |      |
| N   | 1    | 1992      | 3000 |
| N   | 2    | 1992      | 3000 |
| N   | 3    | 1992      | 3000 |
| N   | 4    | 1992      | 3300 |

: Long形式データの架空例（1つの行が1つの観察）

timeは調査回を表す変数である。たとえばID = 1の個人のtime = 1時点の時給は1200円、time = 2時点の時給は1250円、といった具合である。先ほどとは異なり、回答回数に応じて同一個人が複数回データに現れるという構造となっている。つまり、1つの行は1つの回答（観察）になっているということである。

観察回数が少ない個人はそれだけデータに現れる行数も少なくなる。たとえばid = 2の個人は3回分の回答しか得られていないため、long形式データでは3行だけ現れることになるし、id = 3の個人は1行だけ現れることになる。

パネルデータ分析を行う場合には、ほとんどの場合、long形式のデータを用いることになる。したがって、もし分析に使用するデータがlong形式となっていなかった場合には、long形式のデータを自身で準備する必要がある。

### 時間可変と時間不変

先ほどの例でみた賃金のように、時点によって値が変化する変数のことを**時間可変（または時変）time-varying**の変数という。他方、出生年のように、時点によって値が変化しない変数のことを**時間不変（または時不変）time-invariant**の変数という。

調査の行われ方によって、何が時間可変で何が時間不変かは変わってくる。たとえば最終学歴の場合、10代や20代の人を調査している場合にはより上の段階の学校に通うことで最終学歴が変化しうるため、最終学歴は時間可変の変数となりうる。一方、（日本の場合）30--50代で再度学校に通うことはあまり多くないため、最終学歴は時間不変の変数となりうる。また、本質的には時間可変であったとしても、調査で繰り返し尋ねられていない（たとえば最初の調査でのみ学歴を尋ね、それ以降の調査では尋ねない）場合には学歴の変化を捕捉できず、したがって時間不変とせざるを得ない場合もある。

### サンプルデータ

アメリカ労働統計局が実施しているNational Longitudinal Survey of Youth（NLSY）のデモデータ（統計ソフトStataのサンプルデータとしてよく使われる）を利用する。このデータには、1969年時点で14歳から26歳の女性が含まれている。

```{r}
nls <- read_dta("https://www.stata-press.com/data/r9/nlswork.dta")
```

```{r}
nls %>% glimpse()
```

```{r}
nls %>% 
  select(idcode, age, ln_wage) %>% 
  head(n = 20)
```

## パネルデータの特徴記述



## Pooled OLS

$$
\begin{equation}
Y_{it} = \alpha + \underbrace{\beta_1 X_{1it} + \cdots + \beta_k X_{kit}}_{\text 時間可変の変数とその係数} + \underbrace{\gamma_1 Z_{1t} + \cdots + \gamma_l Z_{ki}}_{\text 時間不変の変数とその係数} + e_{it} 
(\#eq:pols)
\end{equation}
$$

## 固定効果モデル（Fixed effect model）

いま、残差$e_{it}$を$e_{it} = u_i + \varepsilon_{it}$というふうに個人間残差$u_i$と個人内残差$\varepsilon_{it}$に分けることにする。すると、 \@ref(eq:pols)は次のように書き換えられる。

$$
\begin{equation}
Y_{it} = \alpha + \beta_1 X_{1it} + \cdots + \beta_k X_{kit} + \gamma_1 Z_{1t} + \cdots + \gamma_l Z_{ki} + \underbrace{u_i}_{\text 個人間残差} + \underbrace{\varepsilon_{it}}_{\text 個人内残差} 
(\#eq:fe1)
\end{equation}
$$

ここで個人間残差$u_i$は各個人の残差の平均値を表す。これは一人ひとりに固有の値であり、いわばid = 1の個体特有の時間不変の効果、id = 2の個人特有の時間不変の効果……、id = Nの個人特有の時間不変の効果を表している。いいかえると、id = 1であれば1、それ以外であれば0をとるダミー変数、id = 2であれば1、それ以外であれば0をとるダミー変数……というふうに考えるとよい。

この場合、時間不変の変数$Z_{1i}, \cdots, Z_{ki}$は$u_i$と完全な共線性を持つことになる（idが分かれば、必ずその人の時間不変の変数の値も分かるという従属関係が生じる）ため、これらは推定から除外されることになる。したがって、\@ref(eq:fe1)は次のように表される。

$$
\begin{equation}
Y_{it} = \alpha + \beta_1 X_{1it} + \cdots + \beta_k X_{kit} + u_i + \varepsilon_{it} 
(\#eq:fe2)
\end{equation}
$$

さらに、id = 1, 2, ..., NまでN個のダミー変数を含めると考えるならば、切片も除外されることとなる。すなわち、

$$
\begin{equation}
Y_{it} = \beta_1 X_{1it} + \cdots + \beta_k X_{kit} + u_i + \varepsilon_{it} 
(\#eq:fe)
\end{equation}
$$

このように書くことができる。このように、個体特有の時間不変の要因を統制したうえで、個体内の変動と従属変数との関連を明らかにするモデルを、**固定効果モデル（Fixed-effects model）**とよぶ。

また、$i$の単位が個人のときには、$u_i$を個人固定効果とよぶ。$i$が学校ならば$u_i$は学校固定効果、$i$が都道府県ならば$u_i$は都道府県固定効果、というふうによぶことになる。

固定効果モデルの強みは、独立変数の個体内変動と従属変数との関連を明らかにすることができるという点にある。たとえば、「非正規雇用で働いていると、正規雇用で働いている場合とくらべて幸福度がが悪化するだろうか？」という問いを立てたとする[^11-paneldata-1]。もちろん、正規雇用で働いている人もいれば非正規雇用で働いている人もいる。正規雇用で働くか非正規雇用で働くかには、性別や学卒時の経済状況などといった比較的観察しやすい属性の他にも、出身家庭の豊かさ、出身大学の選抜度、パーソナリティなどといった観察しにくい属性も影響すると考えられる。固定効果モデルを用いると、仮に調査で聴取されていなかったとしても、こうした時間によって変わらない特徴をすべて統制することができる。これによって、因果効果に近づくことができるというのがメリットである。

[^11-paneldata-1]: Wang, Jia, and James M. Raymo. 2021. "Nonstandard Employment, Gender, and Subjective Well-Being in Japan." *Journal of Marriage and Family* 83(3):845–64.

### 二方向固定効果モデル（Two-way fixed effects model）

$$
\begin{equation}
Y_{it} = \beta_1 X_{1it} + \cdots + \beta_k X_{kit} + u_i + \tau_t + \varepsilon_{it} 
(\#eq:twfe)
\end{equation}
$$

### 推定方法

```{r}
model_ols <- lm(data = nls, ln_wage ~ age + union + race + collgrad)
model_fe <- feols(data = nls, ln_wage ~ age + union + race + collgrad | idcode)
modelsummary(list(model_ols, model_fe), stars = TRUE)
```

1回しか回答していないケースは除外される：

> 665 fixed-effect singletons were removed (665 observations).

### クラスター・ロバスト標準誤差

```{r, message = FALSE}
model1 <- feols(data = nls, ln_wage ~ age + union + race + collgrad | idcode)

model2 <- feols(data = nls, ln_wage ~ age + union + race + collgrad | idcode,
                panel.id = "idcode", vcov = "cluster")
modelsummary(list(model1, model2), stars = TRUE)
```

### 固定効果モデルの注意点

固定効果モデルは因果効果の推定にとっての万能薬ではない[^11-paneldata-2]。とくに最も重要と思われるのは、 時間可変の要因については何ら解決策を与えるものではないということである。たとえば先の例の場合、病気によって正規雇用から非正規雇用に転換することになり、同時に、メンタルヘルスが悪化した人がいたとする。この場合には、病気が雇用形態の変化とメンタルヘルスの悪化の両方をもたらしたのであり、雇用形態が変わることによってメンタルヘルスが悪化したわけではない。すなわち、病気という時間可変の交絡要因が存在するということである。この点は、適切な時間可変の要因を統制することで問題を緩和することができる。

[^11-paneldata-2]: たとえば、大久保将貴，「パネルデータ分析における固定効果モデルの取扱説明書」『社会科学研究』72(2): 55--68．

また、時間不変の個人属性が独立変数や従属変数の変化に対して影響するという可能性もある。典型的な例が男性の結婚と賃金との関連である。男性は、結婚すると結婚していないときと比べて賃金が高い傾向がある[^11-paneldata-3]。これは、パネルデータと固定効果モデルを使った分析でも繰り返し確認されてきた[^11-paneldata-4]。しかしながら、賃金の伸び方は個人によって異なり、かつ、それが結婚するかどうかにも影響すると考えられる（たとえば、将来も賃金が高くなっていくと期待できる人と、将来もさほど高くならないと思われる人であれば、前者のほうがより結婚しやすそうである）。上記の固定効果モデルはこのような個人によって異なるトレンドを統制していないため、結婚と賃金の間に正の関連が見られたとしても、それは見かけ上の効果に過ぎないかもしれない[^11-paneldata-5]。

[^11-paneldata-3]: Waite, Linda J. 1995. "Does Marriage Matter?" *Demography* 32(4):483–507.

[^11-paneldata-4]: Killewald, Alexandra, and Margaret Gough. 2013. "Does Specialization Explain Marriage Penalties and Premiums?" *American Sociological Review* 78(3):477–502.

[^11-paneldata-5]: この可能性を指摘した研究としてたとえばKillewald, Alexandra, and Ian Lundberg. 2017. "New Evidence Against a Causal Marriage Wage Premium." *Demography* 54:1007–28.、Ludwig, Volker, and Josef Brüderl. 2018. "Is There a Male Marital Wage Premium? New Evidence from the United States." *American Sociological Review* 83(4):744–70.など。

固定効果モデルはパネルデータを活かした分析として最も基礎的かつ強力な方法なので活用すべきだが、あくまでも選択肢の一つであって万能薬ではない。この方法を使うことで何が言えて何が言えないのかを理解しておくことが重要といえる。
