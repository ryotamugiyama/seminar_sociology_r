[["index.html", "社会調査データ分析のためのRの手引き まえがき", " 社会調査データ分析のためのRの手引き Ryota Mugiyama (Department of Political Studies, Gakushuin University) 2021-10-28 まえがき 本資料は学習院大学法学部政治学科で開講される「社会学演習」の授業で使用する補足資料です。Rでのデータ加工や分析方法について、授業のなかで出た疑問点などをストックしていくことで、くり返し使える辞書的な位置づけを目指しています。 本資料では説明のためのサンプルデータとしてOECDが実施しているPIAAC (Programme for the International Assessment of Adult Competencies)の日本版データを利用しています。データは上記ウェブサイトから誰でもダウンロード可能です。このデータから、以下の条件に該当する対象者を抽出したデータを使っています。 25-64歳 armed forces以外の職業に従事し、かつ職業（ISCO 1-digit）が無回答でない 最終学歴を回答している 本資料は上記データをもとに順次コードを実行して結果を照合する、というタイプの教科書ではありません。たとえば変数名などは説明にとってわかりやすいようにもともとのデータから変えたりしています。あくまでも、コードなどを参考にして、自分のデータに適用してもらう、ということを目的にしています。 Rの基礎などについてはたくさんの優れた書籍やウェブサイトがあるのでそれらを参考にしてください。資料末尾に、参考書籍やウェブサイトへのリンクを載せています。 この資料はまったくの未完成で、内容は不定期に更新されます。 "],["import.html", "Chapter 1 データの読み込み", " Chapter 1 データの読み込み "],["handling.html", "Chapter 2 データの加工 2.1 サンプルの限定 2.2 変数の作成 2.3 変数の操作化についてのtips", " Chapter 2 データの加工 2.1 サンプルの限定 2.1.1 条件に合う行のみ抽出：filter() 2.2 変数の作成 2.2.1 新たな変数を作成：mutate() 2.2.2 条件の指定：if_else() 2.2.3 複数条件の指定：case_when() 2.2.4 カテゴリ変数へ変換：factor() 2.2.5 必要な列のみ抽出：select() 2.3 変数の操作化についてのtips 2.3.1 カテゴリをまとめる たとえば、親の職業（階級）によって、対象者の学歴がどの程度異なるのかを知りたいとする。このとき、学歴を「中学」「高校」「短大高専」「大学大学院」という4つのカテゴリで定義しているとする。この場合には、たとえば「大学大学院」を1、それ以外を0とすることで、大学以上か大学未満か、という2値のカテゴリにする。 一つひとつのカテゴリに該当する人数が少ないときや、議論を単純化したいときに有効な方法といえる。 2.3.2 均等な順序を仮定して連続変数とする ある程度均等な順序があると仮定できるならば、数値として扱うことを考えてみるとよい。たとえば、性別によって、仕事への満足度が異なるかどうかを知りたいとする。このとき、仕事への満足度は、「全体的にみて、あなたは現在の仕事にどの程度満足していますか」という質問に対して、「非常に満足」「満足」「どちらでもない」「不満」「非常に不満」という5つの選択肢から1つを選択する形式で尋ねられているとする。このときには、「非常に満足」に5、「満足」に4、「どちらでもない」に3、「不満」に2、「非常に不満」に1を振ることで、連続変数に見立てることができる。もちろん、「非常に満足」と「満足」、「満足」と「どちらでもない」の間隔が同じ1であるというのはあくまで仮定であり本当は違うかもしれないということには注意が必要だが、解釈はわかりやすくなるというメリットがある。 選択肢 調査票上の番号 数値化例 非常に満足 1 5 満足 2 4 どちらでもない 3 3 不満 4 2 非常に不満 5 1 なお、こうした扱いが認められるかどうかは扱う変数によって異なるので、先行研究での定義を参考にするとよい。たとえば今回のような仕事への満足度についてはおおむねこのような処理は認められているが、「中学」に1、「高校」に2、「短大高専」に3、「大学大学院」に4を振る、というような処理はあまり認められていない。しかしながら、受けた教育年数として、「中学」に9、「高校」に12、「短大高専」に14、「大学」に16、「大学院」に18（など）といった値を振ることはある程度認められている。このあたりは先行研究の操作化を参考にしつつ、最終的には自分たちの関心によって決めるとよいだろう。 2.3.3 カテゴリ変数の区間の中点をとって連続変数とする なんらかの区間をとって尋ねられている場合、その区間の中点をとって、連続変数とみなす。たとえば、日本家族社会学会が行っている2008年全国家族調査（NFRJ08）では、「あなたご自身…は、次にあげる…家事を現在どのくらいの頻度で行っていますか」という質問項目で、たとえば「食事の用意」について、以下のような選択肢で家事頻度を尋ねている。 選択肢 調査票上の番号 数値化例 ほぼ毎日（週6〜7回） 1 6.5 1週間に4〜5回 2 4.5 1週間に2〜3回 3 2.5 1週間に1回くらい 4 1 ほとんど行わない 5 0 このような場合、週6〜7回という区間の中点をとって6.5、週4〜5回という区間の中点をとって4.5、、etcとすることで、1週間当たりの家事頻度を表す連続変数と見立てることができる。 こうした扱いがどの程度許容されるかについては、先行研究での定義を参照するとよい。 年収などもこうした区間で扱われることがあるが、この場合は中点を定義できない選択肢が設けられていることがある（例：2050万円以上）。こうした場合の扱いについては別途書く（工事中） "],["descriptives.html", "Chapter 3 1変数の集計", " Chapter 3 1変数の集計 "],["tabulate.html", "Chapter 4 2変数の分析 4.1 平均値の比較 4.2 分布の比較 4.3 クロス集計 4.4 クロス集計表を図示する 4.5 散布図 4.6 値が細かくない連続変数を扱う", " Chapter 4 2変数の分析 従属変数 独立変数 カテゴリ変数 連続変数 カテゴリ変数 クロス集計 平均値の比較・分布の比較 連続変数 — 散布図 4.1 平均値の比較 4.1.1 基本 性別ごとに賃金の値を比較したいとする。このようなときには、平均値の比較を行う。 piaac %&gt;% group_by(gender) %&gt;% # genderの値ごとに集計すると宣言 summarize(mean = mean(wage)) ## # A tibble: 2 x 2 ## gender mean ## &lt;fct&gt; &lt;dbl&gt; ## 1 女性 NA ## 2 男性 NA どちらもNAになってしまった。集計する変数（この場合はwage）にNAが含まれている場合には、平均値が計算できず、NAとなってしまう。NAを除いて平均値を計算するときには、あらかじめwageがNAの行を除外しておくとよい。 piaac %&gt;% filter(is.na(wage) == FALSE) %&gt;% # is.na(wage)で、wageの値がNAならTRUE, NAでないならFALSEを返す group_by(gender) %&gt;% summarize(mean = mean(wage)) ## # A tibble: 2 x 2 ## gender mean ## &lt;fct&gt; &lt;dbl&gt; ## 1 女性 1328. ## 2 男性 2196. 平均値だけでなく、標準偏差と各カテゴリの人数をチェックしておくとよいだろう。 piaac %&gt;% filter(is.na(wage) == FALSE) %&gt;% group_by(gender) %&gt;% summarize(mean = mean(wage), sd = sd(wage), n = n()) # n()で行の数を計算 ## # A tibble: 2 x 4 ## gender mean sd n ## &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; ## 1 女性 1328. 813. 1387 ## 2 男性 2196. 1351. 1495 4.1.2 棒グラフによる可視化 平均値の違いを視覚的にみたいときには、棒グラフを作るのがよい。先ほどのようにカテゴリごとに平均値を計算したうえで、geom_col()で棒グラフを作ることができる。 piaac %&gt;% filter(is.na(wage) == FALSE) %&gt;% group_by(gender) %&gt;% summarize(mean = mean(wage)) %&gt;% ggplot(aes(x = gender, y = mean)) + geom_col() + labs(x = &quot;性別&quot;, y = &quot;平均賃金&quot;) 4.1.3 複数カテゴリの組み合わせ 複数のカテゴリ変数を組み合わせて平均値を比較したいということもあるだろう。このような場合も、基本は同じ。group_by()の部分に複数の変数を指定することで、カテゴリを組合わせた集計ができる。 piaac %&gt;% filter(is.na(wage) == FALSE) %&gt;% filter(is.na(educ) == FALSE) %&gt;% group_by(gender, educ) %&gt;% summarize(mean = mean(wage), n = n()) ## `summarise()` has grouped output by &#39;gender&#39;. You can override using the `.groups` argument. ## # A tibble: 8 x 4 ## # Groups: gender [2] ## gender educ mean n ## &lt;fct&gt; &lt;fct&gt; &lt;dbl&gt; &lt;int&gt; ## 1 女性 中学 984. 105 ## 2 女性 高校 1129. 511 ## 3 女性 短大高専 1379. 500 ## 4 女性 大学大学院 1741. 271 ## 5 男性 中学 1800. 142 ## 6 男性 高校 1916. 504 ## 7 男性 短大高専 1936. 222 ## 8 男性 大学大学院 2603. 627 棒グラフを作ることももちろんできる。いくつかのパターンを示しておく。 meandata &lt;- piaac %&gt;% filter(is.na(wage) == FALSE) %&gt;% filter(is.na(educ) == FALSE) %&gt;% group_by(gender, educ) %&gt;% summarize(mean = mean(wage)) #いったん名前をつけて保存しておく ## `summarise()` has grouped output by &#39;gender&#39;. You can override using the `.groups` argument. 学歴で色分けするパターン： meandata %&gt;% ggplot(aes(x = gender, y = mean, fill = educ)) + geom_col(position = &quot;dodge&quot;) + labs(x = &quot;性別&quot;, y = &quot;平均賃金&quot;) 性別で色分けするパターン： meandata %&gt;% ggplot(aes(x = educ, y = mean, fill = gender)) + geom_col(position = &quot;dodge&quot;) + labs(x = &quot;学歴&quot;, y = &quot;平均賃金&quot;) 性別でグラフを分割するパターン： meandata %&gt;% ggplot(aes(x = educ, y = mean)) + geom_col() + labs(x = &quot;学歴&quot;, y = &quot;平均賃金&quot;) + facet_wrap(~gender) 4.2 分布の比較 複数のヒストグラムを重ねるときには、geom_histogram()のなかでposition = \"identity\"と指定する。また、ヒストグラムが重なると片方が見えなくなってしまうので、alpha = 0.5などと指定することで、透明度をつける。alpha = 1がデフォルトで、0に近づくほど透明度が高くなる。 piaac %&gt;% ggplot(aes(x = wage, fill = gender)) + geom_histogram(position = &quot;identity&quot;, alpha = 0.5) + labs(fill = &quot;&quot;) ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. カテゴリごとに人数が異なる場合、少し比較が難しいかもしれない。このような場合は縦軸を度数ではなく密度（density）にするとよい。 piaac %&gt;% ggplot(aes(x = wage, y = ..density.., fill = gender)) + geom_histogram(position = &quot;identity&quot;, alpha = 0.5) + labs(fill = &quot;&quot;) ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. カテゴリの数が2つならいいが、たくさんの場合には見にくくなってしまう。そのような場合にはfacet_wrap()をつかって図を分けるのがよいだろう。 piaac %&gt;% ggplot(aes(x = wage, y = ..density..)) + geom_histogram() + facet_wrap(~occupation) ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. 4.3 クロス集計 4.3.1 基本 親の学歴によって本人の学歴の分布がどの程度異なるのかを知りたいとする。このようなときには、クロス集計表を作成する。 piaac %&gt;% with(table(parenteduc, educ)) ## educ ## parenteduc 中学 高校 短大高専 大学大学院 ## 親：初等教育 166 430 151 130 ## 親：中等教育 103 559 391 394 ## 親：高等教育 25 178 273 530 行%を計算することで、より親の学歴ごとの内訳がわかりやすくなる。 piaac %&gt;% with(table(parenteduc, educ)) %&gt;% prop.table(margin = 1) ## educ ## parenteduc 中学 高校 短大高専 大学大学院 ## 親：初等教育 0.18928164 0.49030787 0.17217788 0.14823261 ## 親：中等教育 0.07118176 0.38631652 0.27021424 0.27228749 ## 親：高等教育 0.02485089 0.17693837 0.27137177 0.52683897 親の学歴が高いほど、本人の学歴も高いことがわかる。 4.3.2 きれいなクロス表をつくる - gtsummary::tbl_cross() とはいえ、このクロス表はあまり見やすいものとはいえない。度数（人数）と行%がいずれも表示され、かつ、周辺度数（行合計と列合計）を表示するグラフは作れないだろうか。 このようなときに、gtsummaryパッケージに含まれているgtsummary::tbl_cross()関数が役に立つ。 install.packages(&quot;gtsummary&quot;) #未インストールの場合はインストール library(gtsummary) 行%を表記する場合は、tbl_cross(data = xx, row = 行にする変数, column = 列にする変数, percent = \"row\")と書く。 piaac %&gt;% tbl_cross(parenteduc, educ, percent = &quot;row&quot;) html { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif; } #ydgabwknrs .gt_table { display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; } #ydgabwknrs .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #ydgabwknrs .gt_title { color: #333333; font-size: 125%; font-weight: initial; padding-top: 4px; padding-bottom: 4px; border-bottom-color: #FFFFFF; border-bottom-width: 0; } #ydgabwknrs .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 0; padding-bottom: 6px; border-top-color: #FFFFFF; border-top-width: 0; } #ydgabwknrs .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #ydgabwknrs .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #ydgabwknrs .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; } #ydgabwknrs .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; } #ydgabwknrs .gt_column_spanner_outer:first-child { padding-left: 0; } #ydgabwknrs .gt_column_spanner_outer:last-child { padding-right: 0; } #ydgabwknrs .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 5px; overflow-x: hidden; display: inline-block; width: 100%; } #ydgabwknrs .gt_group_heading { padding: 8px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; } #ydgabwknrs .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: middle; } #ydgabwknrs .gt_from_md > :first-child { margin-top: 0; } #ydgabwknrs .gt_from_md > :last-child { margin-bottom: 0; } #ydgabwknrs .gt_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; } #ydgabwknrs .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 12px; } #ydgabwknrs .gt_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #ydgabwknrs .gt_first_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; } #ydgabwknrs .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #ydgabwknrs .gt_first_grand_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; } #ydgabwknrs .gt_striped { background-color: rgba(128, 128, 128, 0.05); } #ydgabwknrs .gt_table_body { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #ydgabwknrs .gt_footnotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #ydgabwknrs .gt_footnote { margin: 0px; font-size: 90%; padding: 4px; } #ydgabwknrs .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #ydgabwknrs .gt_sourcenote { font-size: 90%; padding: 4px; } #ydgabwknrs .gt_left { text-align: left; } #ydgabwknrs .gt_center { text-align: center; } #ydgabwknrs .gt_right { text-align: right; font-variant-numeric: tabular-nums; } #ydgabwknrs .gt_font_normal { font-weight: normal; } #ydgabwknrs .gt_font_bold { font-weight: bold; } #ydgabwknrs .gt_font_italic { font-style: italic; } #ydgabwknrs .gt_super { font-size: 65%; } #ydgabwknrs .gt_footnote_marks { font-style: italic; font-weight: normal; font-size: 65%; } Characteristic educ Total 中学 高校 短大高専 大学大学院 parenteduc 親：初等教育 166 (19%) 430 (49%) 151 (17%) 130 (15%) 877 (100%) 親：中等教育 103 (7.1%) 559 (39%) 391 (27%) 394 (27%) 1,447 (100%) 親：高等教育 25 (2.5%) 178 (18%) 273 (27%) 530 (53%) 1,006 (100%) Unknown 22 (25%) 44 (49%) 12 (13%) 11 (12%) 89 (100%) Total 316 (9.2%) 1,211 (35%) 827 (24%) 1,065 (31%) 3,419 (100%) 値が度数、括弧内が行%を意味している。with(table())のときと違って、NAのデータは自動的に除外されず、「Unknown」という行や列が追加される。NAのデータを除外したいときには、以下のようにする。 piaac %&gt;% tbl_cross(parenteduc, educ, percent = &quot;row&quot;, missing = &quot;no&quot;) ## FALSE observations with missing data have been removed. html { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif; } #auujvnjgio .gt_table { display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; } #auujvnjgio .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #auujvnjgio .gt_title { color: #333333; font-size: 125%; font-weight: initial; padding-top: 4px; padding-bottom: 4px; border-bottom-color: #FFFFFF; border-bottom-width: 0; } #auujvnjgio .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 0; padding-bottom: 6px; border-top-color: #FFFFFF; border-top-width: 0; } #auujvnjgio .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #auujvnjgio .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #auujvnjgio .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; } #auujvnjgio .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; } #auujvnjgio .gt_column_spanner_outer:first-child { padding-left: 0; } #auujvnjgio .gt_column_spanner_outer:last-child { padding-right: 0; } #auujvnjgio .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 5px; overflow-x: hidden; display: inline-block; width: 100%; } #auujvnjgio .gt_group_heading { padding: 8px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; } #auujvnjgio .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: middle; } #auujvnjgio .gt_from_md > :first-child { margin-top: 0; } #auujvnjgio .gt_from_md > :last-child { margin-bottom: 0; } #auujvnjgio .gt_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; } #auujvnjgio .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 12px; } #auujvnjgio .gt_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #auujvnjgio .gt_first_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; } #auujvnjgio .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #auujvnjgio .gt_first_grand_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; } #auujvnjgio .gt_striped { background-color: rgba(128, 128, 128, 0.05); } #auujvnjgio .gt_table_body { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #auujvnjgio .gt_footnotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #auujvnjgio .gt_footnote { margin: 0px; font-size: 90%; padding: 4px; } #auujvnjgio .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #auujvnjgio .gt_sourcenote { font-size: 90%; padding: 4px; } #auujvnjgio .gt_left { text-align: left; } #auujvnjgio .gt_center { text-align: center; } #auujvnjgio .gt_right { text-align: right; font-variant-numeric: tabular-nums; } #auujvnjgio .gt_font_normal { font-weight: normal; } #auujvnjgio .gt_font_bold { font-weight: bold; } #auujvnjgio .gt_font_italic { font-style: italic; } #auujvnjgio .gt_super { font-size: 65%; } #auujvnjgio .gt_footnote_marks { font-style: italic; font-weight: normal; font-size: 65%; } Characteristic educ Total 中学 高校 短大高専 大学大学院 parenteduc 親：初等教育 166 (19%) 430 (49%) 151 (17%) 130 (15%) 877 (100%) 親：中等教育 103 (7.1%) 559 (39%) 391 (27%) 394 (27%) 1,447 (100%) 親：高等教育 25 (2.5%) 178 (18%) 273 (27%) 530 (53%) 1,006 (100%) Total 294 (8.8%) 1,167 (35%) 815 (24%) 1,054 (32%) 3,330 (100%) 4.4 クロス集計表を図示する クロス集計は数値が多いので、図で表されているとわかりやすいかもしれない。このようなときには、with(table())で作成した数値をデータフレームとすることで、比較的簡単に図をつくることができる。 table &lt;- piaac %&gt;% with(table(parenteduc, educ)) %&gt;% prop.table(margin = 1) %&gt;% as.data.frame() # データフレーム形式に変換 table #中身を確認。 ## parenteduc educ Freq ## 1 親：初等教育 中学 0.18928164 ## 2 親：中等教育 中学 0.07118176 ## 3 親：高等教育 中学 0.02485089 ## 4 親：初等教育 高校 0.49030787 ## 5 親：中等教育 高校 0.38631652 ## 6 親：高等教育 高校 0.17693837 ## 7 親：初等教育 短大高専 0.17217788 ## 8 親：中等教育 短大高専 0.27021424 ## 9 親：高等教育 短大高専 0.27137177 ## 10 親：初等教育 大学大学院 0.14823261 ## 11 親：中等教育 大学大学院 0.27228749 ## 12 親：高等教育 大学大学院 0.52683897 table %&gt;% ggplot(aes(y = Freq, x = parenteduc, fill = educ)) + geom_col() + labs(x = &quot;&quot;, y = &quot;割合&quot;, fill = &quot;本人学歴&quot;) 積み上げ棒グラフは各カテゴリの大きさがわかりにくいので、ばらして始点をそろえるほうが見やすいかもしれない。 table %&gt;% ggplot(aes(y = Freq, x = parenteduc, fill = educ)) + geom_col(position = &quot;dodge&quot;) + labs(x = &quot;&quot;, y = &quot;割合&quot;, fill = &quot;本人学歴&quot;) + theme(legend.position = &quot;bottom&quot;) 4.5 散布図 4.5.1 散布図をみる 連続変数どうしの関係をみたいときには、散布図を使う。散布図を書くときには、geom_point()を使う。サンプルサイズが大きい場合には点がかぶってしまうので、かぶっている箇所がわかりやすいよう、透明度を指定するとよいだろう。 piaac %&gt;% ggplot(aes(x = age, y = wage)) + geom_point(alpha = 0.2) 散布図の傾向を表すような直線を引くと、関係がよりわかりやすいだろう。 piaac %&gt;% ggplot(aes(x = age, y = wage)) + geom_point(alpha = 0.2) + geom_smooth(method = &quot;lm&quot;, se = FALSE) ## `geom_smooth()` using formula &#39;y ~ x&#39; geom_smooth()というのは、2つの変数の関連の傾向を示す線を描く関数。カッコ内で、どのような線を引くのかを指定する。 method = \"lm\"という部分は、回帰分析により推定される直線を引くという指定を表している。何も書かない場合には、method = \"loess\"（局所回帰）による線が描かれる。 se = FALSEの部分では、係数の標準誤差から計算される95%信頼区間を書かないという指定を表している。何も書かない場合には、信頼区間がプロットされる。 4.5.2 カテゴリごとに散布図を分ける たとえば男性と女性で別々に散布図を書きたいということがあるだろう。このような場合には、facet_wrap()を使うか、color =を指定する。 piaac %&gt;% ggplot(aes(x = age, y = wage)) + geom_point(alpha = 0.2) + geom_smooth(method = &quot;lm&quot;, se = FALSE) + facet_wrap(~gender) ## `geom_smooth()` using formula &#39;y ~ x&#39; piaac %&gt;% ggplot(aes(x = age, y = wage, color = gender)) + geom_point(alpha = 0.2) + geom_smooth(method = &quot;lm&quot;, se = FALSE) ## `geom_smooth()` using formula &#39;y ~ x&#39; 4.5.3 相関係数 相関係数は以下のように定義される： \\[ r = \\frac{\\textrm{Cov}(x, y)}{\\textrm{Sd}(x)\\textrm{Sd}(y)} = \\frac{\\frac{1}{N} \\sum_{i = 1}^N(x_i - \\overline{x})(y_i - \\overline{y})}{\\sqrt{\\frac{1}{N} \\sum_{i = 1}^N(x_i - \\overline{x})^2}\\sqrt{\\frac{1}{N} \\sum_{i = 1}^N(y_i - \\overline{y})^2}} \\] 相関係数はsummarize()コマンドで計算できる。NAが含まれている場合にはやはり計算結果もNAになってしまうので、前もってNAの行がないかどうかチェックしておく。 piaac %&gt;% filter(is.na(wage) == FALSE) %&gt;% summarize(cor = cor(age, wage)) ## # A tibble: 1 x 1 ## cor ## &lt;dbl&gt; ## 1 0.134 4.6 値が細かくない連続変数を扱う 値が細かくない連続変数を扱う場合、散布図があまり可視化の役に立たないことがある。例えば、健康状態について尋ねた質問の選択肢に次のように値を与え、高いほど健康であることを示すようにした変数（health）があるとする。 選択肢 調査票上の番号 数値化例 極めて優れている 1 5 大変良い 2 4 良い 3 3 どちらともいえない 4 2 悪い 5 1 年齢が高いほど健康状態が悪くなるというのはよく知られているので、年齢を横軸、健康状態を縦軸にとった散布図を書くと右下に点が集まるはずだと思ったが、散布図を書いてみると、点が重なってしまってなんだかよくわからない散布図になってしまう。 piaac %&gt;% ggplot(aes(x = age, y = health)) + geom_point(alpha = 0.2) このような場合はどうしたらよいだろうか？解決策の1つは、平均値の比較のときのように、横軸の変数の値ごとに健康状態の平均値を計算し、それをプロットすることだ。 piaac %&gt;% group_by(age) %&gt;% summarize(mean = mean(health)) %&gt;% ggplot(aes(x = age, y = mean)) + geom_point() ただ、この図では人数が少ない年齢層も多い年齢層も同じ大きさの点で描かれてしまっていることが少し不満かもしれない。点の大きさを考慮したい場合には、バブル・プロットを使う。aestheticsのところでsize =を指定することで、点の大きさを変えることができる。 piaac %&gt;% group_by(age) %&gt;% summarize(mean = mean(health), n = n()) %&gt;% ggplot(aes(x = age, y = mean, size = n)) + geom_point(alpha = 0.5) "],["regression-basic.html", "Chapter 5 回帰分析の基礎 5.1 説明 5.2 最小二乗法（OLS）（工事中） 5.3 独立変数がカテゴリ変数の場合 5.4 従属変数が2値のカテゴリ変数（0/1）の場合 5.5 非線形の関連 5.6 結果をきれいに表示する", " Chapter 5 回帰分析の基礎 5.1 説明 年齢が高いほど賃金（時給換算）が高いという傾向があるかどうかを知りたいとする。このとき、年齢を横軸、賃金を縦軸とする散布図を書いてみる。 piaac %&gt;% ggplot(aes(x = age, y = wage)) + geom_point(alpha = 0.2) なんとなく、年齢が高いほど賃金が高い傾向があるようにみえる。この関係を1つの直線で要約するとしたらどのようになるだろう？この直線を示したのが次の図になる。 piaac %&gt;% ggplot(aes(x = age, y = wage)) + geom_point(alpha = 0.2) + geom_smooth(method = &quot;lm&quot;, se = FALSE) ## `geom_smooth()` using formula &#39;y ~ x&#39; このように、従属変数と独立変数の関係を\\(y = f(x)\\)というような関数で表現する分析方法を指して、回帰分析 regression analysis/regression model という。今回の式の場合は、次のようなかたちになる。とくに今回のような場合を線形回帰分析 Linear regressionということもある。 \\[ y = \\beta_0 + \\beta_1x \\] 今の例の場合は、\\(y\\)は賃金、\\(x\\)は年齢である。\\(\\beta_k\\)のことを係数 coefficient といい、なかでもとくに\\(\\beta_0\\)のことを切片 intercept、\\(\\beta_1\\)のことを傾き slope という。傾きは、\\(x\\)が1単位高いときに\\(y\\)がどれだけ高いかを表す。 ここで関心があるのは傾きの値である。これが正であれば、\\(x\\)が高いほど\\(y\\)は高いという正の関係を表すし、負であれば、\\(x\\)が高いほど\\(y\\)は低いという負の関係を表す。絶対値が大きいほど、\\(x\\) 1単位の変化に対して \\(y\\)がより大きく変わるということを表すので、たんに正か負かというだけでなく、その値も重要。 今回の場合は係数はどうなるだろうか？線形回帰分析を推定するときのコマンドがlm()である。lm(data = xx, formula = )という書き方になる。formula =の部分は省略しても大丈夫。 lm(data = piaac, formula = wage ~ age) ## ## Call: ## lm(formula = wage ~ age, data = piaac) ## ## Coefficients: ## (Intercept) age ## 1124.92 14.86 (Intercept)の部分が切片\\(\\beta_0\\)、ageの部分がageの傾き\\(\\beta_1\\)にそれぞれ対応する。したがって、賃金と年齢の関係は以下の式のように表されるということを意味する： \\[ y = 1134.39 + 14.71x \\] では、推定された係数というのが偶然ではなく、母集団においても確かに正であるということができるだろうか。そのことを確認するための結果をみるために、いったん、名前をつけて結果を保存する。 reg_res &lt;- lm(data = piaac, wage ~ age) 名前をつけた結果は、summary()でよびだすことができる： summary(reg_res) ## ## Call: ## lm(formula = wage ~ age, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -1631.2 -807.8 -301.9 449.7 8048.3 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 1124.918 92.519 12.159 &lt; 2e-16 *** ## age 14.860 2.043 7.273 4.5e-13 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 1195 on 2880 degrees of freedom ## (537 observations deleted due to missingness) ## Multiple R-squared: 0.01804, Adjusted R-squared: 0.0177 ## F-statistic: 52.9 on 1 and 2880 DF, p-value: 4.497e-13 1列目のEstimateの列には、先ほどみたように係数の値が表示される。2列目のStd. Errorの列が標準誤差 standard errorを表し、係数のばらつきを示している。4列めのPr(&gt;|t|)の列がp値 p-valueを表している。p値は「もし母集団において係数が0であるという帰無仮説が正しいとしたときに、今回のような係数の値となる確率」を表しており、この値が十分に低いのなら、帰無仮説を棄却して、たしかに母集団においても係数は0でなさそうだ（正あるいは負だ）、ということを自信をもって主張できるということになる。 ageの行をのp値を確認すると、6.19e-13となっている。つまり、母集団において年齢の係数が0であるとしたときに、今回のような係数の値（14.706）が得られる確率は0.0000000000000619だ、ということである。 この確率がどれくらい低ければ自信をもって「関係がある」と言えるのかということだが、慣習的には、0.05という基準が使われている。Rでは、0.05よりも小さければ（正確には0.01 ≤ p &lt; 0.05）、p値の横に*という印がつく。同じようにして、0.01よりも小さければ（0.001 ≤ p &lt; 0.01）**、0.001よりも小さければ（p &lt; 0.001）、***という印がつく。 5.2 最小二乗法（OLS）（工事中） もちろん、上記の回帰式は散布図をみて直観でえいやっと式の値を決めたのではなく、全体の傾向をもっともよく要約するような係数を推定している。その係数の推定方法を最小二乗法 ordinary least square, OLSという。 5.3 独立変数がカテゴリ変数の場合 5.3.1 2値のカテゴリ 線形回帰分析では、連続変数だけではなく、カテゴリ変数も扱うことができる。その例としてまず、性別によって賃金がどの程度異なるのかを知りたいとする。このとき、（無理やり）散布図を書くと、次のようになる。分布がわかりやすいように、バイオリン・プロットを重ねて示している。 piaac %&gt;% ggplot(aes(x = gender, y = wage)) + geom_violin() + geom_point(alpha = 0.2) 図からわかる通り、男性と比べると女性の賃金が低いことがわかる。平均値を計算して棒グラフにしてみると、その差は歴然である。 piaac %&gt;% group_by(gender) %&gt;% summarize(mean_wage = mean(wage, na.rm = TRUE)) %&gt;% ggplot(aes(x = gender, y = mean_wage)) + geom_col() + geom_text(aes(label = round(mean_wage, digit = 1)), vjust = -1) + ylim(0, 2500) ここで得られた男性の平均値と女性の平均値をそれぞれ散布図に書き入れてみたのが次の図である。実線が男性の平均値、点線が女性の平均値を表している。 piaac %&gt;% ggplot(aes(x = gender, y = wage)) + geom_violin() + geom_point(alpha = 0.2) + geom_hline(yintercept = 2196.5) + geom_hline(yintercept = 1327.8, lty = 2) いま、男性であれば1、女性であれば0をとる変数\\(x\\)を考えよう。このように、カテゴリ変数のカテゴリを区別するために便宜的に0/1の値を振った変数のことを、ダミー変数 dummy variableという。このとき、性別による賃金の違いを表す回帰式は次のようになる： \\[ y = \\beta_0 + \\beta_1x \\] 回帰式のかたちは先ほどと同じとなる。傾き\\(\\beta_1\\)は、女性（0）とくらべて男性（1）がどの程度賃金が高いのかを示している。実際、この係数を推定してみよう。 piaac &lt;- piaac %&gt;% mutate(male_d = case_when( gender == &quot;男性&quot; ~ 1, gender == &quot;女性&quot; ~ 0 )) piaac %&gt;% select(gender, male_d) %&gt;% sample_n(size = 6) # どのような値になっているかをチェック。 ## # A tibble: 6 x 2 ## gender male_d ## &lt;fct&gt; &lt;dbl&gt; ## 1 男性 1 ## 2 男性 1 ## 3 女性 0 ## 4 男性 1 ## 5 男性 1 ## 6 女性 0 reg_res &lt;- lm(data = piaac, wage ~ male_d) summary(reg_res) ## ## Call: ## lm(formula = wage ~ male_d, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -1888.3 -610.1 -327.6 368.1 8672.4 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 1327.59 30.21 43.95 &lt;2e-16 *** ## male_d 868.43 41.94 20.71 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 1125 on 2880 degrees of freedom ## (537 observations deleted due to missingness) ## Multiple R-squared: 0.1296, Adjusted R-squared: 0.1293 ## F-statistic: 428.7 on 1 and 2880 DF, p-value: &lt; 2.2e-16 male_dというのが、性別が男性のときに1、女性のときに0をとる変数である。この係数が868.7、切片（Intercept）が1327.8ということだから、推定された式はつぎのとおりとなる。 \\[ y = 1327.8 + 868.7x \\] 傾きの値は、女性と比べて男性の賃金は868.7円高いということを意味している。 この868.7という値は、2つのカテゴリ（この場合は男性・女性）、先ほど棒グラフに示した男性の平均値と女性の平均値の差に一致していることを確認しよう。傾きの値は、2つのカテゴリの平均値の差に一致する。 5.3.2 3値以上のカテゴリ カテゴリが3値以上の場合はどうだろう？これも、基本的には同じふうに考えることができる。 piaac %&gt;% filter(is.na(educ) == FALSE) %&gt;% ggplot(aes(x = educ, y = wage)) + geom_violin() + geom_point(alpha = 0.2) 中学卒を基準として、高校、短大高専、大学大学院卒だとどれくらい賃金が高いのかを推定することになる。 piaac &lt;- piaac %&gt;% mutate(educ_d2 = if_else(educ == &quot;高校&quot;, 1, 0)) %&gt;% mutate(educ_d3 = if_else(educ == &quot;短大高専&quot;, 1, 0)) %&gt;% mutate(educ_d4 = if_else(educ == &quot;大学大学院&quot;, 1, 0)) piaac %&gt;% select(educ, educ_d2, educ_d3, educ_d4) %&gt;% sample_n(size = 10) #それぞれどのような値となっているかチェック。 ## # A tibble: 10 x 4 ## educ educ_d2 educ_d3 educ_d4 ## &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 高校 1 0 0 ## 2 大学大学院 0 0 1 ## 3 高校 1 0 0 ## 4 短大高専 0 1 0 ## 5 高校 1 0 0 ## 6 短大高専 0 1 0 ## 7 大学大学院 0 0 1 ## 8 大学大学院 0 0 1 ## 9 短大高専 0 1 0 ## 10 短大高専 0 1 0 reg_res &lt;- lm(data = piaac, wage ~ educ_d2 + educ_d3 + educ_d4) summary(reg_res) ## ## Call: ## lm(formula = wage ~ educ_d2 + educ_d3 + educ_d4, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -2035.1 -692.6 -316.9 390.7 8450.0 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 1453.13 72.82 19.954 &lt;2e-16 *** ## educ_d2 66.61 81.20 0.820 0.412 ## educ_d3 96.89 84.37 1.149 0.251 ## educ_d4 889.67 82.23 10.819 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 1145 on 2878 degrees of freedom ## (537 observations deleted due to missingness) ## Multiple R-squared: 0.09976, Adjusted R-squared: 0.09882 ## F-statistic: 106.3 on 3 and 2878 DF, p-value: &lt; 2.2e-16 それぞれの係数は、基準カテゴリ（今回なら中学卒）と比べて、それぞれどれくらい賃金が高いのかを表している。標準誤差やp値のみかたについてはどれも同じ。 5.3.3 変数がfactorであれば自動でカテゴリとして投入される 独立変数の型がカテゴリの場合には、Rが自動で先ほどのようなダミー変数を勝手に作って投入してくれる。 reg_res &lt;- lm(data = piaac, wage ~ educ) summary(reg_res) ## ## Call: ## lm(formula = wage ~ educ, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -2035.1 -692.6 -316.9 390.7 8450.0 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 1453.13 72.82 19.954 &lt;2e-16 *** ## educ高校 66.61 81.20 0.820 0.412 ## educ短大高専 96.89 84.37 1.149 0.251 ## educ大学大学院 889.67 82.23 10.819 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 1145 on 2878 degrees of freedom ## (537 observations deleted due to missingness) ## Multiple R-squared: 0.09976, Adjusted R-squared: 0.09882 ## F-statistic: 106.3 on 3 and 2878 DF, p-value: &lt; 2.2e-16 ただし、基準カテゴリは一番最初（アルファベットが早い順、漢字の場合はよくわからない）のものが勝手に選ばれるので、たとえば高校を基準にしてその他を比較したい、と思ったときには、自分でカテゴリの順序を変更しておく必要がある。 piaac &lt;- piaac %&gt;% mutate(educ_reorder = factor(educ, levels = c(&quot;高校&quot;, &quot;中学&quot;, &quot;短大高専&quot;, &quot;大学大学院&quot;), labels = c(&quot;高校&quot;, &quot;中学&quot;, &quot;短大高専&quot;, &quot;大学大学院&quot;))) reg_res &lt;- lm(data = piaac, wage ~ educ_reorder) summary(reg_res) ## ## Call: ## lm(formula = wage ~ educ_reorder, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -2035.1 -692.6 -316.9 390.7 8450.0 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 1519.75 35.92 42.304 &lt;2e-16 *** ## educ_reorder中学 -66.61 81.20 -0.820 0.412 ## educ_reorder短大高専 30.28 55.72 0.543 0.587 ## educ_reorder大学大学院 823.06 52.43 15.697 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 1145 on 2878 degrees of freedom ## (537 observations deleted due to missingness) ## Multiple R-squared: 0.09976, Adjusted R-squared: 0.09882 ## F-statistic: 106.3 on 3 and 2878 DF, p-value: &lt; 2.2e-16 5.4 従属変数が2値のカテゴリ変数（0/1）の場合 たとえば、性別によってこの1年間に職場での訓練（OJTとよぶ）を受ける率が異なっているかどうかを知りたいとする。これも今までと同じように回帰分析の枠組みで扱うことができる。 まず、OJTを受けたならば1、受けていないならば0を取る変数があるとする。この値の平均をとれば、OJTを受けた人の割合に一致する。たとえば以下の2つを比較してみよう。 piaac %&gt;% tbl_cross(gender, ojt, percent = &quot;row&quot;) html { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif; } #fottzlywfy .gt_table { display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; } #fottzlywfy .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #fottzlywfy .gt_title { color: #333333; font-size: 125%; font-weight: initial; padding-top: 4px; padding-bottom: 4px; border-bottom-color: #FFFFFF; border-bottom-width: 0; } #fottzlywfy .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 0; padding-bottom: 6px; border-top-color: #FFFFFF; border-top-width: 0; } #fottzlywfy .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #fottzlywfy .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #fottzlywfy .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; } #fottzlywfy .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; } #fottzlywfy .gt_column_spanner_outer:first-child { padding-left: 0; } #fottzlywfy .gt_column_spanner_outer:last-child { padding-right: 0; } #fottzlywfy .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 5px; overflow-x: hidden; display: inline-block; width: 100%; } #fottzlywfy .gt_group_heading { padding: 8px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; } #fottzlywfy .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: middle; } #fottzlywfy .gt_from_md > :first-child { margin-top: 0; } #fottzlywfy .gt_from_md > :last-child { margin-bottom: 0; } #fottzlywfy .gt_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; } #fottzlywfy .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 12px; } #fottzlywfy .gt_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #fottzlywfy .gt_first_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; } #fottzlywfy .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #fottzlywfy .gt_first_grand_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; } #fottzlywfy .gt_striped { background-color: rgba(128, 128, 128, 0.05); } #fottzlywfy .gt_table_body { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #fottzlywfy .gt_footnotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #fottzlywfy .gt_footnote { margin: 0px; font-size: 90%; padding: 4px; } #fottzlywfy .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #fottzlywfy .gt_sourcenote { font-size: 90%; padding: 4px; } #fottzlywfy .gt_left { text-align: left; } #fottzlywfy .gt_center { text-align: center; } #fottzlywfy .gt_right { text-align: right; font-variant-numeric: tabular-nums; } #fottzlywfy .gt_font_normal { font-weight: normal; } #fottzlywfy .gt_font_bold { font-weight: bold; } #fottzlywfy .gt_font_italic { font-style: italic; } #fottzlywfy .gt_super { font-size: 65%; } #fottzlywfy .gt_footnote_marks { font-style: italic; font-weight: normal; font-size: 65%; } Characteristic ojt Total 0 1 gender 女性 1,092 (69%) 488 (31%) 1,580 (100%) 男性 1,150 (63%) 689 (37%) 1,839 (100%) Total 2,242 (66%) 1,177 (34%) 3,419 (100%) ついで、性別ごとにojtの平均値を計算し、図に書いてみる。 piaac %&gt;% group_by(gender) %&gt;% summarize(mean_ojt = mean(ojt, na.rm = TRUE)) %&gt;% ggplot(aes(x = gender, y = mean_ojt)) + geom_col() + geom_text(aes(label = round(mean_ojt, digit = 3)), vjust = -1) + ylim(0, 0.4) ここで示された値は、上記クロス表の「1」のほうに示されている行%、すなわち「OJTを受けた人の割合」に一致している。 では、回帰式を推定してみよう。 reg_res &lt;- lm(data = piaac, ojt ~ gender) summary(reg_res) ## ## Call: ## lm(formula = ojt ~ gender, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -0.3747 -0.3747 -0.3089 0.6253 0.6911 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 0.30886 0.01193 25.894 &lt; 2e-16 *** ## gender男性 0.06580 0.01626 4.046 5.33e-05 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 0.4741 on 3417 degrees of freedom ## Multiple R-squared: 0.004767, Adjusted R-squared: 0.004476 ## F-statistic: 16.37 on 1 and 3417 DF, p-value: 5.332e-05 「gender男性」と書かれている行が、女性と比べて男性が6.6%ポイントOJTを受ける割合が高いのかを示している）。この値が、ちょうど先ほどの棒グラフの男性と女性の割合（平均値）の差に一致していることを確認しよう。係数の見方も、標準誤差も、p値も、すべて今までの回帰分析と一緒。 もちろん、年齢などの連続変数を独立変数（X）として使うこともできる。 5.4.1 （発展）ロバスト標準誤差 上記のように従属変数が2値の場合の線形回帰分析のことを線形確率モデル linear probability modelと呼ぶことがある。線形確率モデルの場合は、誤差が正規分布するという仮定に反し、普通の標準誤差は誤った値になってしまうことが知られている。そこで、こうした不均一分散の問題に対処するために、ロバスト標準誤差を用いることが推奨されている。 ここではロバスト標準誤差のことについては説明しないし、授業でも使う必要はないが、推定の仕方だけ書いておく。estimatr::lm_robust()で、ロバスト標準誤差を得ることができる。使い方はこのページにくわしい。 install.packages(&quot;estimatr&quot;) #未インストールの場合のみ library(estimatr) reg_res &lt;- lm_robust(data = piaac, ojt ~ gender) summary(reg_res) ## ## Call: ## lm_robust(formula = ojt ~ gender, data = piaac) ## ## Standard error type: HC2 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper DF ## (Intercept) 0.3089 0.01163 26.56 1.676e-141 0.28606 0.33166 3417 ## gender男性 0.0658 0.01621 4.06 5.018e-05 0.03402 0.09758 3417 ## ## Multiple R-squared: 0.004767 , Adjusted R-squared: 0.004476 ## F-statistic: 16.48 on 1 and 3417 DF, p-value: 5.018e-05 5.5 非線形の関連 5.5.1 対数変換 piaac &lt;- piaac %&gt;% mutate(logwage = log(wage)) 2つの変数の分布を比較してみよう。 piaac %&gt;% ggplot(aes(x = wage)) + geom_histogram() ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. piaac %&gt;% ggplot(aes(x = logwage)) + geom_histogram() ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. reg_res &lt;- lm(data = piaac, logwage ~ age) summary(reg_res) ## ## Call: ## lm(formula = logwage ~ age, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -1.59633 -0.46971 -0.03937 0.39219 1.91365 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 7.1331862 0.0434355 164.225 &lt; 2e-16 *** ## age 0.0040713 0.0009592 4.245 2.26e-05 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 0.561 on 2880 degrees of freedom ## (537 observations deleted due to missingness) ## Multiple R-squared: 0.006217, Adjusted R-squared: 0.005872 ## F-statistic: 18.02 on 1 and 2880 DF, p-value: 2.259e-05 なお、対数変換した変数を新たに作成しなくても、次のように書くことで、回帰分析のコード中で対数変換を行う事ができる。以下でも同じ結果を得ることができる（結果は省略）。 lm(data = piaac, log(wage) ~ age) piaac %&gt;% ggplot(aes(x = age, y = logwage)) + geom_point(alpha = 0.2) + geom_smooth(method = &quot;lm&quot;, se = FALSE) ## `geom_smooth()` using formula &#39;y ~ x&#39; 5.5.2 2乗項 piaac &lt;- piaac %&gt;% mutate(age_sq = age^2) piaac %&gt;% ggplot(aes(x = age, y = age_sq)) + geom_point() reg_res &lt;- lm(data = piaac, logwage ~ age + age_sq) summary(reg_res) ## ## Call: ## lm(formula = logwage ~ age + age_sq, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -1.67879 -0.45201 -0.02961 0.37393 1.99303 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 5.687e+00 1.759e-01 32.324 &lt;2e-16 *** ## age 7.312e-02 8.203e-03 8.913 &lt;2e-16 *** ## age_sq -7.749e-04 9.144e-05 -8.474 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 0.5542 on 2879 degrees of freedom ## (537 observations deleted due to missingness) ## Multiple R-squared: 0.0304, Adjusted R-squared: 0.02973 ## F-statistic: 45.13 on 2 and 2879 DF, p-value: &lt; 2.2e-16 このときの散布図と回帰式は次のようになる。 piaac %&gt;% ggplot(aes(x = age, y = logwage)) + geom_point(alpha = 0.2) + geom_smooth(method = &quot;lm&quot;, formula = y ~ poly(x, 2), se = FALSE) 2乗した変数を別に作らなくても、回帰分析のコード中で2乗した変数を作成することができる。（結果は省略） lm(data = piaac, log(wage) ~ age + I(age^2)) 5.6 結果をきれいに表示する 先ほどの回気分析の結果をもう少しきれいに表示したいと思うかもしれない。これまで、こうしたときにはtexregやstargazerなどといったパッケージが使われてきたが、最近はmodelsummaryというパッケージが開発され、これがなかなか良さそうという情報をキャッチしたので、使ってみよう（2021-10-27現在）。 はじめて使う場合はinstall.packages()。 install.packages(&quot;modelsummary&quot;) #未インストールの場合のみ library(modelsummary) では、実際に使ってみよう。msummary(list(model))（modelという部分には、すでに保存しておいた回帰分析の結果を入れる）というのが最低限のコマンド。 reg_res &lt;- lm(data = piaac, log(wage) ~ age + I(age^2)) msummary(list(reg_res)) Model 1 (Intercept) 5.687 (0.176) age 0.073 (0.008) I(age^2) −0.001 (0.000) Num.Obs. 2882 R2 0.030 R2 Adj. 0.030 AIC 4781.8 BIC 4805.7 Log.Lik. −2386.921 F 45.131 よく論文でみる感じのきれいな見た目になる。とはいえ、まだたとえば変数名が何を指しているかなどは改善の余地がある。オプションを色々指定することで、よりわかりやすい表が作れる。 msummary(list(reg_res), stars = TRUE, # 有意水準を示す印をつける coef_rename = c(&quot;(Intercept)&quot; = &quot;切片&quot;, &quot;age&quot; = &quot;年齢&quot;, &quot;I(age^2)&quot; = &quot;年齢2乗&quot;), # 各変数に名前をつける gof_omit = &quot;R2 Adj.|AIC|BIC|Log.Lik.|F&quot;) # 不要な統計量を削除する Model 1 切片 5.687*** (0.176) 年齢 0.073*** (0.008) 年齢2乗 −0.001*** (0.000) Num.Obs. 2882 R2 0.030 + p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001 いい感じの表ができた！ "],["regression-advanced.html", "Chapter 6 重回帰分析の活用 6.1 交絡要因の統制 6.2 結果の比較と解釈 6.3 最小二乗法（OLS）（工事中） 6.4 媒介分析／要因分解 6.5 重回帰分析の実際", " Chapter 6 重回帰分析の活用 library(tidyverse) library(modelsummary) 6.1 交絡要因の統制 いま、高い学校段階を終えたこと（学歴）がどれくらい賃金を高めるのかを知りたいとする。もっともシンプルな方法が、前回みたように（単）回帰分析で学歴ごとに賃金を比較するという方法だ。 しかしこの方法では、学歴の効果を知るには不十分かもしれない。というのも、データには25歳から64歳まで幅広い年齢の対象者が含まれており、また男性も女性も含まれている。学歴別に書いた次の散布図を見てみよう： piaac %&gt;% filter(is.na(educ) == FALSE) %&gt;% ggplot(aes(x = age, y = logwage, color = gender)) + geom_point(alpha = 0.3) + facet_wrap(~educ) + labs(color = &quot;&quot;) 高学歴化が進んだ影響で、中学卒の人には年齢の高い（古い年の生まれの）人が多く、短大高専や大学卒の人には年齢の低い人が多い。年齢が高くなるにつれて賃金が高くなるという傾向があるから、たんに学歴ごとに平均値をとったときには、このような年齢分布の違いは、中学卒の見かけの賃金を高く、短大高専卒や大学卒の見かけの賃金を低く見せるだろう。 性別も重要だ。たとえば短大高専卒では男性よりも女性が多く、大学卒では女性よりも男性が多い。男性のほうが（さまざまな理由によって）女性よりも賃金高い傾向があるから、このような性別分布の違いは、短大高専卒の見かけの賃金を低く、大学卒の見かけの賃金を高く見せるだろう。 以上のような分布の違いを一定としたうえで（統制 controlして、ともいう）学歴と賃金の関係をみることができたなら、「学歴はどの程度賃金を高める効果を持つのか」という問いの答えに近づくことができる。重回帰分析は、こうしたモチベーションに答えるための方法だ。 このときのモチベーションを図にすると、次のようなかたちになる。 Xを学歴、Yを賃金、Zを性別や年齢と考えよう。知りたいのは学歴が賃金に与える効果（X -&gt; Y）だが、その背後にはXにもYにも影響する要因Z（Z -&gt; X、Z -&gt; Y）が存在する。そのため、学歴が賃金に与える効果をみたいのならば、Zを一定とする必要がある。このように、XとYの両者に影響する要因を交絡要因 confounderとよぶ。 一般に、重回帰分析の式は次のように書ける。 \\[ y = \\beta_0 + \\beta_1x_1 + \\beta_2x_2 + \\cdots + \\beta_kx_k \\] 係数\\(\\beta_1\\)は、他の変数\\(x_2, \\cdots, x_k\\)を一定としたうえで、\\(x_1\\)が1単位高いと\\(y\\)がどれだけ高いのかを示す。表記上xとzを使い分けたりということはしないが、先に述べたように、複数の変数を使うときの回帰分析では、関心のある変数xと、統制したい変数zというふうに別々の役割があるということが多い。 6.2 結果の比較と解釈 性別や年齢といった交絡要因を考慮しない単回帰分析と、重回帰分析を比較してみよう。 reg_res1 &lt;- lm(data = piaac, logwage ~ educ) reg_res2 &lt;- lm(data = piaac, logwage ~ educ + gender + age + I(age^2)) msummary(list(reg_res1, reg_res2), stars = TRUE, coef_rename = c(&quot;(Intercept)&quot; = &quot;切片&quot;, &quot;educ高校&quot; = &quot;高校（vs. 中学）&quot;, &quot;educ短大高専&quot; = &quot;短大高専（vs. 中学）&quot;, &quot;educ大学大学院&quot; = &quot;大学大学院（vs. 中学）&quot;, &quot;gender男性&quot; = &quot;男性（vs. 女性）&quot;, &quot;age&quot; = &quot;年齢&quot;, &quot;I(age^2)&quot; = &quot;年齢2乗&quot;), gof_omit = &quot;R2 Adj.|AIC|BIC|Log.Lik.|F&quot;) Model 1 Model 2 切片 7.107*** 5.123*** (0.034) (0.152) 高校（vs. 中学） 0.071+ 0.102** (0.037) (0.034) 短大高専（vs. 中学） 0.099* 0.224*** (0.039) (0.036) 大学大学院（vs. 中学） 0.499*** 0.463*** (0.038) (0.035) 男性（vs. 女性） 0.431*** (0.018) 年齢 0.075*** (0.007) 年齢2乗 −0.001*** (0.000) Num.Obs. 2882 2882 R2 0.125 0.296 + p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001 Model 1とModel 2とでは、学歴の係数が違っていることがわかる。Model 1では、中学卒の人とくらべて高校卒では0.074（約7.4%ポイント）、短大高専卒（約9.7%ポイント）、大学大学院卒では0.497（約49.7%ポイント）、賃金が高いことがわかる。 一方で性別と年齢を一定としたModel 2では、学歴の係数は大きく異なっている。とくに、短大高専卒の係数に注目してみよう。Model 1と比べるとその係数はかなり大きくなっている。先にみたように、高学歴の人には（平均的にみて賃金が低い）若い人が多く、また短大高専卒には（平均的にみて賃金が低い）女性が多かった。これらの影響のために、中学卒との見かけの賃金の差（Model 1）は小さめに見えていた。しかし、これら性別と年齢の影響を除く（一定とする）ことによって、短大高専を卒業することによる賃金上昇をより正確に捉えることができるようになったといえる。その他の学歴についても、Model 1と比べると、学歴が賃金を高める効果の推定に近づいているといえる。 もちろん、性別や年齢だけではなくほかにもさまざまな要因が絡んでくるから、これだけでは学歴が賃金に与える効果を完璧に正しく推定しているというわけではない。しかし、このように要因を統制することで、学歴が賃金を高める効果の推定値に近づいていくことができる。 6.3 最小二乗法（OLS）（工事中） 重回帰分析の係数はやはり最小二乗法によって推定される。 6.4 媒介分析／要因分解 6.4.1 モチベーション 女性は男性と比べて賃金が低い（男女間賃金格差）。たとえばその原因には、(1) 女性が男性よりも教育水準（学歴）が低い、(2) 女性が男性よりもスキルレベル（ここでは、PIAACの試験で測定された数的思考力のスコアとする）が低い、ということがありえるだろう。このような原因を調べるというときにも、重回帰分析を活用することができる。 性別をX、賃金をY、学歴およびスキルレベルをMとすると、ここでのアイデアは次のような図に表すことができる。 性別が賃金に与える効果は、(1) 女性の教育水準やスキルレベルが低く、したがって賃金も低い（X -&gt; M -&gt; Y）という部分と、(2) 教育水準やスキルレベルを一定としてもなお女性のほうが賃金が低い（X -&gt; Y | M）という部分とに分けることができる。このようにして、XとYの中間にある要因を考えることでグループ間の差や独立変数の効果を分けていくことを指して、媒介分析 mediation analysisや要因分解decompositionなどという。 piaac &lt;- piaac %&gt;% mutate(female_d = if_else(gender == &quot;女性&quot;, 1, 0)) reg_res1 &lt;- lm(data = piaac, logwage ~ female_d) reg_res2 &lt;- lm(data = piaac, logwage ~ female_d + educ) reg_res3 &lt;- lm(data = piaac, logwage ~ female_d + educ + numeracy) msummary(list(reg_res1, reg_res2, reg_res3), stars = TRUE, coef_rename = c(&quot;(Intercept)&quot; = &quot;切片&quot;, &quot;female_d&quot; = &quot;女性（vs. 男性）&quot;, &quot;educ高校&quot; = &quot;高校（vs. 中学）&quot;, &quot;educ短大高専&quot; = &quot;短大高専（vs. 中学）&quot;, &quot;educ大学大学院&quot; = &quot;大学大学院（vs. 中学）&quot;, &quot;numeracy&quot; = &quot;数的思考力&quot;), gof_omit = &quot;R2 Adj.|AIC|BIC|Log.Lik.|F&quot;) Model 1 Model 2 Model 3 切片 7.542*** 7.288*** 6.687*** (0.013) (0.032) (0.068) 女性（vs. 男性） −0.477*** −0.425*** −0.407*** (0.019) (0.019) (0.019) 高校（vs. 中学） 0.105** 0.031 (0.035) (0.035) 短大高専（vs. 中学） 0.213*** 0.116** (0.036) (0.037) 大学大学院（vs. 中学） 0.446*** 0.280*** (0.035) (0.038) 数的思考力 0.002*** (0.000) Num.Obs. 2882 2882 2882 R2 0.179 0.255 0.280 + p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001 Model 1では女性は男性に比して-0.477（約-48%）賃金が低いということがわかる。 Model 2では、学歴を追加している。学歴の係数は正であり、学歴が高いほど、賃金は高い傾向があるといえる。学歴を一定とすると、女性の係数は-0.425（約-43%）となり、これはModel 1の女性の係数よりも小さい。すなわち、女性の賃金が低いことの一部は、学歴が低いために賃金が低い、ということによって生じているということがわかる。 Model 3ではさらに数的思考力を追加している。数的思考力の係数は正であり、数的思考力のスコアが高いほど、賃金が高い傾向があるといえる。学歴と数的思考力を一定とすると、女性の係数は-0.407（約-41%）となり、やはりModel 1の女性の係数よりも小さい。すなわち、女性の賃金が低いことの一部は、学歴が低いために賃金が低いこと、数的思考力スコアが低いために賃金が低いことによって生じているということがわかる。しかしながら、これらの個人属性を一定としてもなお、男女間には非常に大きな賃金格差が存在する。 6.4.2 （発展）係数変化の可視化 女性の係数を図にして表すことによって、それぞれの要因を追加したときの係数の違いを視覚的に把握しやすくなる。broomパッケージを使うことで、回帰分析の推定結果から係数や信頼区間に関する値を抽出し、それを使って図を作成することができる。 install.packages(&quot;broom&quot;) #未インストールの場合のみ library(broom) m1 &lt;- tidy(reg_res1, conf.int = TRUE) %&gt;% mutate(model = &quot;Model 1&quot;) m2 &lt;- tidy(reg_res2, conf.int = TRUE) %&gt;% mutate(model = &quot;Model 2&quot;) m3 &lt;- tidy(reg_res3, conf.int = TRUE) %&gt;% mutate(model = &quot;Model 3&quot;) m1 %&gt;% bind_rows(m2, m3) %&gt;% filter(term == &quot;female_d&quot;) %&gt;% ggplot(aes(x = model, y = estimate)) + geom_point() + geom_pointrange(aes(ymax = conf.high, ymin = conf.low)) + geom_text(aes(label = round(estimate, digit = 3)), hjust = 1.2) + ylim(-.6, 0) + geom_hline(yintercept = 0, lty = 2) + labs(x = &quot;&quot;, y = &quot;対数賃金の男女差&quot;, caption = &quot;注：Model 1は性別のみ、Model 2は学歴を統制、Model 3はさらに数的思考力を統制。&quot;) 6.5 重回帰分析の実際 実際の論文では、交絡要因の統制と媒介分析の両方を考慮しながら分析されることが多い。すなわち、次のような図になる。 たとえば、学歴が高いと賃金が高い（X -&gt; Y）のはなぜなのか知りたいとする。その原因の1つとして、学歴が高いとよりスキルレベルが高い（賃金の高い）職業につくことができるから（X -&gt; M -&gt; Y）、ということが考えられる。実際、学歴別に職業（ISCO 1-digit, 軍隊は除く）の分布を比べてみると、学歴が高いほど管理職や専門職といったスキルレベルの高い職業に就いている傾向があることがわかる。 piaac %&gt;% tbl_cross(educ, occupation, percent = &quot;row&quot;) html { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif; } #geeusckjfl .gt_table { display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; } #geeusckjfl .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #geeusckjfl .gt_title { color: #333333; font-size: 125%; font-weight: initial; padding-top: 4px; padding-bottom: 4px; border-bottom-color: #FFFFFF; border-bottom-width: 0; } #geeusckjfl .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 0; padding-bottom: 6px; border-top-color: #FFFFFF; border-top-width: 0; } #geeusckjfl .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #geeusckjfl .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #geeusckjfl .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; } #geeusckjfl .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; } #geeusckjfl .gt_column_spanner_outer:first-child { padding-left: 0; } #geeusckjfl .gt_column_spanner_outer:last-child { padding-right: 0; } #geeusckjfl .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 5px; overflow-x: hidden; display: inline-block; width: 100%; } #geeusckjfl .gt_group_heading { padding: 8px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; } #geeusckjfl .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: middle; } #geeusckjfl .gt_from_md > :first-child { margin-top: 0; } #geeusckjfl .gt_from_md > :last-child { margin-bottom: 0; } #geeusckjfl .gt_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; } #geeusckjfl .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 12px; } #geeusckjfl .gt_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #geeusckjfl .gt_first_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; } #geeusckjfl .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #geeusckjfl .gt_first_grand_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; } #geeusckjfl .gt_striped { background-color: rgba(128, 128, 128, 0.05); } #geeusckjfl .gt_table_body { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #geeusckjfl .gt_footnotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #geeusckjfl .gt_footnote { margin: 0px; font-size: 90%; padding: 4px; } #geeusckjfl .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #geeusckjfl .gt_sourcenote { font-size: 90%; padding: 4px; } #geeusckjfl .gt_left { text-align: left; } #geeusckjfl .gt_center { text-align: center; } #geeusckjfl .gt_right { text-align: right; font-variant-numeric: tabular-nums; } #geeusckjfl .gt_font_normal { font-weight: normal; } #geeusckjfl .gt_font_bold { font-weight: bold; } #geeusckjfl .gt_font_italic { font-style: italic; } #geeusckjfl .gt_super { font-size: 65%; } #geeusckjfl .gt_footnote_marks { font-style: italic; font-weight: normal; font-size: 65%; } Characteristic occupation Total 管理職 専門職 技術職・准専門職 事務補助 サービス・販売 農林漁業 技能工 設備・機械運転・組立 単純作業 educ 中学 8 (2.5%) 4 (1.3%) 15 (4.7%) 20 (6.3%) 68 (22%) 18 (5.7%) 84 (27%) 52 (16%) 47 (15%) 316 (100%) 高校 57 (4.7%) 41 (3.4%) 152 (13%) 209 (17%) 332 (27%) 33 (2.7%) 159 (13%) 147 (12%) 81 (6.7%) 1,211 (100%) 短大高専 34 (4.1%) 155 (19%) 138 (17%) 138 (17%) 212 (26%) 11 (1.3%) 78 (9.4%) 28 (3.4%) 33 (4.0%) 827 (100%) 大学大学院 150 (14%) 331 (31%) 238 (22%) 144 (14%) 120 (11%) 10 (0.9%) 38 (3.6%) 22 (2.1%) 12 (1.1%) 1,065 (100%) Total 249 (7.3%) 531 (16%) 543 (16%) 511 (15%) 732 (21%) 72 (2.1%) 359 (11%) 249 (7.3%) 173 (5.1%) 3,419 (100%) 先に確認したように、学歴と賃金の間には性別や年齢といった交絡要因が存在する（Z -&gt; X, Z -&gt; Y）。なので、あらかじめこれらを統制しておいたうえで、学歴による賃金の差が職業の違いによってどの程度説明されるのかというのをみる必要がある。 実際の分析結果は次のようになる。 reg_res1 &lt;- lm(data = piaac, logwage ~ educ + gender + age + I(age^2)) reg_res2 &lt;- lm(data = piaac, logwage ~ educ + gender + age + I(age^2) + occupation) msummary(list(reg_res1, reg_res2), stars = TRUE, coef_rename = c(&quot;(Intercept)&quot; = &quot;切片&quot;, &quot;gender男性&quot; = &quot;男性（vs. 女性）&quot;, &quot;educ高校&quot; = &quot;高校（vs. 中学）&quot;, &quot;educ短大高専&quot; = &quot;短大高専（vs. 中学）&quot;, &quot;educ大学大学院&quot; = &quot;大学大学院（vs. 中学）&quot;, &quot;age&quot; = &quot;年齢&quot;, &quot;I(age^2)&quot; = &quot;年齢2乗&quot;, &quot;occupation専門職&quot; = &quot;専門職（vs. 管理職）&quot;, &quot;occupation技術職・准専門職&quot; = &quot;技術職・准専門職（vs. 管理職）&quot;, &quot;occupation事務補助&quot; = &quot;事務補助（vs. 管理職）&quot;, &quot;occupationサービス・販売&quot; = &quot;サービス・販売（vs. 管理職）&quot;, &quot;occupation農林漁業&quot; = &quot;農林漁業（vs. 管理職）&quot;, &quot;occupation技能工&quot; = &quot;技能工（vs. 管理職）&quot;, &quot;occupation設備・機械運転・組立&quot; = &quot;設備・機械運転・組立（vs. 管理職）&quot;, &quot;occupation単純作業&quot; = &quot;単純作業（vs. 管理職）&quot;), gof_omit = &quot;R2 Adj.|AIC|BIC|Log.Lik.|F&quot;) Model 1 Model 2 切片 5.123*** 6.218*** (0.152) (0.150) 高校（vs. 中学） 0.102** 0.034 (0.034) (0.032) 短大高専（vs. 中学） 0.224*** 0.060+ (0.036) (0.035) 大学大学院（vs. 中学） 0.463*** 0.191*** (0.035) (0.035) 男性（vs. 女性） 0.431*** 0.356*** (0.018) (0.019) 年齢 0.075*** 0.056*** (0.007) (0.007) 年齢2乗 −0.001*** −0.001*** (0.000) (0.000) 専門職（vs. 管理職） −0.190*** (0.037) 技術職・准専門職（vs. 管理職） −0.343*** (0.036) 事務補助（vs. 管理職） −0.502*** (0.038) サービス・販売（vs. 管理職） −0.661*** (0.037) 農林漁業（vs. 管理職） −0.726*** (0.088) 技能工（vs. 管理職） −0.577*** (0.041) 設備・機械運転・組立（vs. 管理職） −0.593*** (0.043) 単純作業（vs. 管理職） −0.747*** (0.049) Num.Obs. 2882 2882 R2 0.296 0.405 + p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001 年齢と性別を統制したうえでの学歴の係数が、職業を考慮することによってどの程度変わるのかをみる。これをみると、Model 1と比べて、職業を一定としたModel 2では学歴の係数がかなり小さくなる。学歴が高いと賃金が高いという関連のかなりの部分が、職業分布の違いによって生じているようだということを、2つのモデルの学歴の係数の違いから読み取ることができる。 "],["domain.html", "Chapter 7 社会学のデータ分析でよくある処理 7.1 SSM職業小分類を大分類にまとめる 7.2 EGP階級分類を作成する 7.3 旧制学歴と新制学歴の対応 7.4 出身階層（親学歴）の測定 7.5 年収と労働時間から時間給を作成する", " Chapter 7 社会学のデータ分析でよくある処理 日本の社会学・社会階層研究業界を念頭においたときのデータ分析でよくある処理についてランダムにまとめます。ただし内容は作成者（麦山）の経験と感覚によるもので、業界で標準的な手続きなのかどうかはわかりません。 7.1 SSM職業小分類を大分類にまとめる いくつかの調査では、調査対象者に仕事の内容を自由記述で尋ね、その回答をもとに、職業名を割り当てているものがある。このときに使われる職業分類が1995年SSM職業小分類と呼ばれるものである。1995年SSM職業章分類は約200の小分類からなり、それぞれの職業に番号が振られている。この番号を振った調査を以下に列挙する。 調査名 調査年 現職職業小分類 初職職業小分類 15歳時父親職業小分類 15歳時母親職業小分類 社会階層と社会移動調査（SSM） 1995 有 有 有（「主な仕事」） 有（「主な仕事」） 2005 有 有 有 有 2015 有 有 有 有 日本版総合的社会調査（JGSS） 2000 有 有 有 2001 有 有 有 2002 有 有 有 2003 有 有 2005 有 有 有 2006 有 有 有 2008 有 有 有 2010 有 有 有 2012 有 有 有 2015 有 有 有 東大社研パネル調査（JLPS） 2007-2020 有 有 有 有 ふつうはこうした200個近い分類をそのまま分析に使うということはなく、少数のカテゴリにまとめて使う。カテゴリへのまとめ方はいくつも種類があるが、ここでは代表的なものとして「SSM職業大分類」と「国勢調査職業分類」の2つを準備する。 7.2 EGP階級分類を作成する 7.3 旧制学歴と新制学歴の対応 旧制学歴 新制学歴 統合学歴（5分類） 統合学歴（4分類） 統合学歴（3分類） 旧制尋常小学校 新制中学校 中学 中学 初等教育 旧制高等小学校 新制中学校 中学 中学 初等教育 旧制中学校・高等女学校 新制高校 高校 高校 中等教育 旧制実業学校 新制高校 高校 高校 中等教育 - 専修学校高等課程* 高校 高校 中等教育 - 専門学校（専修学校専門課程）* 専門学校 高校 高等教育** 旧制師範学校 新制短大・高専 短大高専 短大高専 高等教育 旧制高校・専門学校・高等師範学校 新制短大・高専 短大高専 短大高専 高等教育 旧制大学 新制大学 大学大学院 大学大学院 高等教育 旧制大学 新制大学院 大学大学院 大学大学院 高等教育 *専修学校高等課程は中学卒業者を対象として職業教育を実施する機関。専修学校専門課程は高校卒業者を対象として職業教育を実施する機関で、ふつう「専門学校」というときにはこちらを指すことが多い。調査票の選択肢に「専門学校」が設けられていた場合も、対象者はおそらくこちらを想定していると思われる。 **国際標準教育分類（ISCED2011）では専門学校はレベル5（Short-cycle tertiary education）とされており、高等教育相当とされている。 7.4 出身階層（親学歴）の測定 7.5 年収と労働時間から時間給を作成する "],["reference.html", "Chapter 8 参考文献・ウェブサイト", " Chapter 8 参考文献・ウェブサイト Rはtidyverseパッケージの普及以前と以後で（望ましいとされる）文法が大きく変わっているため、tidyverseの使用を前提としたものを使うことを強くおすすめする。また、良書ではあるのだけれど、機械学習など社会学の関心とはやや離れた内容を念頭に置いたものも多く、ぴったりの書籍は少ない。こうしたなかで、日本語で読める書籍としては、以下の2冊がとくにおすすめできる。 浅野正彦・矢内勇生，『Rによる計量政治学入門』オーム社． 松村優哉・湯谷啓明・紀ノ定保礼・前田和寛，『改訂2版 Rユーザのための RStudio［実践］入門：tidyverseによるモダンな分析フローの世界』技術評論社． そのほか、ありがたいことに、ウェブページで解説を公開してくれている先生方もおられる。以下に挙げたウェブページはいずれもとてもすばらしく、参考になる。 矢内勇生先生のウェブページ：RとRStudioのインストール方法の解説 森知晴先生のウェブページ：卒業論文のためのR入門 宋財泫・矢内勇生先生のウェブページ：私たちのR：ベストプラクティスの探求 "]]
