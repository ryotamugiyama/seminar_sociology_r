[["index.html", "Rによる社会調査データ分析の手引き まえがき", " Rによる社会調査データ分析の手引き 麦山 亮太（学習院大学法学部政治学科）/ Ryota Mugiyama (Department of Political Studies, Gakushuin University) Last update: 2022-10-25 まえがき 本資料は麦山が担当する学習院大学法学部政治学科「社会学演習（社会的不平等に関する実証研究）」、同大学院政治学研究科「統計解析I」「公共秩序の数理モデル（社会調査データの計量分析）」の授業で使用する資料です。その他の授業でも活用することがあります。授業では適宜口頭で説明を補いながら使うことを想定しているため説明を簡単に済ませているところもありますが、どなたでも参照できるかと思います。分かりやすさを重視しているため、厳密性には欠けるところがあるかもしれません。 タイトルに示されているとおり、本資料の目的はとくに社会調査の個票データを分析するうえで必要となるR/RStudioの使い方、そしてその前後に研究計画の立て方と論文のまとめかたを置き、一通り社会調査データの分析のための作法を整理して記したものです。扱っている内容は左記の目次のとおりです。スマートフォンで見ている場合には上部にある4本線のアイコンをクリックすることで目次をみることができます。 本資料は、麦山の専門分野である社会学、とりわけ社会階層研究を念頭に置き、かつ既存の社会調査データを利用することを念頭において作成しています。そのため、分野が異なる、扱うデータの形式が異なるといった場合には適宜距離を取って参照してください。 （発展）と書いてある節または項は発展的な内容を扱っているため、必ずしもチェックする必要はありませんが、読んでおくと勉強になるかもしれません。 本資料は（いつまでも）ベータ版で、今後授業などを通じて少しずつアップデートしていく予定です。アップデートは予告なしに行います。もし本資料をご利用いただいた方で、誤り、改善点、要望、感想、その他もっとこうしたほうがよいといった点などについてコメントいただける方は、こちらのフォームからコメントをお寄せください。主として自分の授業のための資料ですので、すべての要望に答えることはできませんが、改善のための参考にさせていただきます。フォームから質問をもらっても回答はできません。 今後追加するかもしれないトピック（2022/7/6追記） Kitagawa-Blinder-Oaxaca decomposition 交互作用 ロジットモデルと平均限界効果 Difference-in-Differences/Fixed-effects model "],["plan.html", "Chapter 1 研究計画を立てる 1.1 研究計画とは 1.2 研究背景 1.3 研究目的・問い 1.4 方法 1.5 参考文献 1.6 使用する調査データの選定 1.7 先行研究を探す", " Chapter 1 研究計画を立てる 本章では、データ分析に着手し、論文をまとめるための大前提となる研究計画の立て方を説明する。 1.1 研究計画とは 何も考えずにただデータを分析し始めても、よい論文を書くのは難しい。実際にデータを開いて分析を始める前に十分に計画を練っておくことで、有意義な論文を書くことにつながる。そこで後期が始まるまでに、グループごとに研究計画書を作成してもらう。研究計画書では以下のような内容を書く。分量としてはだいたい3–5ページくらい（参考文献リスト含む）。ここで書いた研究計画書を最初のたたき台として、データ分析を行い、期末レポートを執筆する。 研究計画書は、以下の4つの要素からなる： 研究背景 研究目的・問い 方法 参考文献 これら研究計画に書いた内容は、たんに計画を立てるというだけでなく、これを土台にして（膨らませて）論文にしていくものでもある。研究計画は次のような役割を果たす： 何を明らかにするのか（問い）を明確にする：問いは、何をどのように分析するのかについての指針を与えてくれる。問いが明確であるほど、やるべきことはクリアになる。 先行研究で解かれていない謎を明確にする：先行研究を整理することで、先行研究で解かれていない点や、矛盾している点、先行研究のやり方では十分に明らかにできていないことが見えてくる。 問いがなぜ重要なのかを明確にする：先行研究で解かれていないことやまだ明らかになっていないことがあるのは、もしかするとそれらがあまり重要ではないからかもしれない。問いがなぜ重要なのか、何が問うに値する重要な問いなのかをあらかじめきちんと考えておけば、あまり重要ではない問いに時間を浪費せずにすむ。 よく練られた研究計画であればあるほど、論文を書くときの苦労は少なくなり、よい論文につながる可能性は高くなる。たとえば自分で調査をしたり実験をしたりしてデータを集めるときに研究計画が重要であることは言うまでもない。しかしながら、たとえこの授業のように自分でデータを集めないのだとしても、上記の効用はとても大きく、研究計画の作成には時間をかける価値がある。以下、上記の要素一つひとつについてくわしくみていく。 1.2 研究背景 研究背景は、次の2–4段落からなる。 1.2.1 問題背景（1段落程度） 研究で扱いたい問題が社会問題としてand/or社会学的に重要であることを述べる。 社会問題として重要、というのは、平等、人権、健康、持続可能性などなど、人間社会において重要とされている価値に照らして、その重要性を主張するものである。一見個人的な問題であっても社会問題と関わりをもつことは多いので1、必ずしも世の中で「社会問題」だと言われている必要はない。どのようなトピックであっても、それがなぜ社会問題として重要であるのかを考える必要がある。また、その問題の重要性や規模感を示す根拠として公的統計の値などを提示することもある。 社会学的に重要、というのは、社会学で伝統的に扱われてきた問題に照らして、その重要性を主張するものである。不平等に関係する社会学の伝統的な問題としては、世代間社会移動、教育機会の不平等、労働市場におけるジェンダー不平等、家族形成のパターン、夫婦間の無償労働の分担（権力関係）などが挙げられる。伝統的に扱われてきた問題はそれだけその重要性が認められており、したがって扱うトピックが重要であることを示す根拠にもなる。 もちろん、「自分が関心を持った」というのは最初のモチベーションとして大事だが、「自分が関心をもった」というだけでは、他の人にとっては説得的できない。他の人にとって関心をもってもらえるような理由を述べることが大事である。 1.2.2 先行研究の整理（1–3段落程度） 先に述べた問題に関連して、先行研究がこれまでに何を明らかにし、何を明らかにしていないのか、あるいは先行研究に存在する限界点を提示する。 調べた先行研究を1つひとつすべて羅列するわけではなく、それらをまとめた全体像を意識する。 先行研究の検討を通じて、（重要であるにもかかわらず）明らかになっていないこと・課題が何かを示す。この箇所こそが、自分たちの研究で解く「問い」になる。研究のオリジナリティを示すためには、十分に先行研究を読み込み、整理しなければならない。 1.3 研究目的・問い 研究目的・問いは、次の1–3段落程度からなる。 1.3.1 研究目的・問い（1–2段落程度） 研究目的（問い）を提示する。「xxxを明らかにする」「どの程度yyyなのか？」など、何をやるのかが明確な問いを提示する。 社会調査データを使った分析で取り組まれる問いには、大きく分けて2種類の問いがある。 記述的問い：実態を明らかにすることを目的とする問い。すでに明らかになっている実態をさらに掘り下げてみていくことも含まれる。 説明的問い：実態が明らかになっていることを（ある程度）前提として、それがなぜ生じるのかを明らかにすることを目的とする問い。 問いを立てるときには、先行研究をよく読んで、問いを「絞る」ことが大切になる。たとえば、「なぜジェンダー格差があるのか？」というのは、問いの形ではあるけれども、それだけではあまりに大きすぎ、かつ漠然としているため、到底1つの論文で答えることはできず、分析の焦点もぼやけてしまう。そこで、答えることができる問いへと焦点を絞っていくことが大事になる。 問いを絞るときには、次のような要素を考えるとよい。 誰を対象とするのか？：国、時代、年齢、就業状態、など どのような集団どうしを比較するのか？：男性と女性、ひとり親世帯出身者とふたり親世帯出身者、大卒者と非大卒者、既婚者と未婚者、時代、など 何の変数を比較するのか？：教育達成、賃金、幸福度、友人の有無、など 1.3.2 仮説（1段落程度、あれば） 上記の問いに対する仮説を提示する。1つでもよいし、複数（最大で4つほど）あってもよい。このとき、ただ仮説だけを書くのではなく、そのような仮説が導かれる根拠（なぜそのように考えられるのか？）についても書く。 仮説は、「男性は女性と比べて近所との付き合いが少ない」「所得が高いほど、政府による所得の再分配に反対しやすい」といったように、比較の視点が入っており、かつ、検証可能なものであるとよい。 1.4 方法 1.4.1 データ 何の調査データを使用するのかを書く。またその調査データがどのような人を対象としており、いつ、どのような方法で調査が実施されたのか、どのような質問項目を聴取しているのかについて書く。 1.4.2 分析対象 実際に分析する対象（母集団）について書く。たいていの社会調査データは広い母集団を対象としているので、そこから分析対象を絞ることが多い。何歳から何歳までか。男性も女性も含むか、どちらかだけか。働いている人か、働いていない人も含むか、結婚している人か、など。 データや分析対象が先に設定した問いときちんと対応しているかをよく確認する。たとえば、「親の労働時間が長いと子どものメンタルヘルスは悪化するのではないか？」という問いを立てたとする。このような場合であれば、子どもを分析対象とする必要があり、大人（成人）を対象とした調査では答えることが難しい。また、子どもを対象とした調査だとしても、親の労働時間を尋ねていない調査であったとしたら、やはりこの問いには答えることができない。 1.4.3 使用する変数 従属変数、独立変数、あるいは統制変数について、使用予定の変数を書く。また、変数の名前だけでなく、どのように値を加工するかについても書くと良い。たとえばJGSSの場合は次のように書く。 子どもへの教育費支出（SZEXED：世帯支出 - 教育費）。回答区間の中央値をとって、連続変数に変換する。 本人の最終学歴（XXLSTSCH：最終学校（本人））。中学、高校、短大高専、大学の4カテゴリにまとめる。 1.4.4 分析方法 クロス集計、散布図、平均値の比較、回帰分析、など、使用予定の分析手法について書く。また、どのように分析するのか（何の変数と何の変数のクロス集計を作成するのか？など）についても書けるとよい。 1.5 参考文献 研究計画書で引用した文献（書籍、論文、ウェブサイト等）について書く。読んだけれども引用はしていない文献は含めない。書籍・論文を含め少なくとも10本以上は引用するのが望ましい。実際には読んだけれど引用しないという文献もあるので、数十本は目を通すことになる。 後で述べるとおり文献の質は玉石混交であり、また研究には「流れ」があるため、手当り次第にインターネットを検索して文献を羅列してもあまりよい先行研究のサーベイにはならない。先行研究の探し方については後述する。 1.6 使用する調査データの選定 1.6.1 個票データとは何か たとえば「学歴が高い人ほど平均年収が高い」といった仮説や、「学歴が高い人ほど子どもがいる割合が高い」といった仮説を検証したいとする。このような仮説を検証する場合には、一人ひとりについて（1）学歴、（2）年収、そして（3）子どもがいるかどうか、についての情報を得ることが必要である。このように、一人ひとりについてさまざまな情報を（アンケートなどによって）聴取し、その回答を集めたデータを個票データと呼ぶ。たとえば今回の場合は、以下の［A］のような回答を格納した個票データが得られたとしよう。 ［A］個票データ ID 最終学歴 個人年収 子どもの有無 1 大学 500 1（あり） 2 中学 300 1（あり） 3 高校 500 0（なし） ︙ ︙ ︙ ︙ 99 大学 700 1（あり） 100 高校 400 0（なし） たんに個票データをじっと眺めてみても、それだけでは傾向は見えてこない（おもしろいかもしれないが）。このような個票データから先に立てた問いに答えるためには、学歴ごとに、年収の平均値や、子どもがいる人の割合を計算する必要がある。このように計算を行って得られたのが、以下の［B］の集計データである。研究者はこのような個票データをもとにさまざまな集計を行って、属性間の傾向の違いを検討したりしており、実際に論文に示されたり、政府の白書などで示されたり、e-Statに掲載されたりしているのは、［B］のように加工されたあとの結果である。 ［B］集計データ 最終学歴 個人年収の平均 子どもがいる割合 中学 319 0.8 高校 424 0.85 大学 566 0.91 自分の関心にもとづいて、先行研究ではまだわかっていない独自の仮説を検証したいとき、多くの場合は［A］の個票データを手に入れる必要がある。もちろん、このような個票データを取得することは簡単ではない。そのへんを歩いている人にアンケートを配ってみたり、SNSでGoogleFormに回答するよう呼びかけて集めたとしても、知りたい対象からランダムに選ばれたデータになるとは到底言えないし、回答する人も大変である。 そこで、過去の研究者や研究機関などが実施した質の高い調査を二次利用することで、新しく調査を行ったり、回答の負担をかけることなく、自分独自の問いに答え、社会の実態を明らかにすることができる。 1.6.2 JGSS このような個票データを使おうと思った場合、まずは、大阪商業大学JGSS研究センターが実施している、日本版総合的社会調査（Japan General Social Survey, JGSS）のデータを使うことを考えてみるとよい。JGSSでは調査年ごとに非常に多様な質問項目が設けられているので、大抵の問題関心に沿った分析が可能である。 まず、どのような調査がされているのかを確認してみよう。調査対象者は？調査の形式は？どのような調査票？調査の詳細は、こちらに記されている。 次に、関心に合う項目を探してみよう。項目はこちらから調べることができる。 関心に合う項目を見つけたら、その項目が何年の調査で尋ねられているか確認しよう。2022/6/3時点では2000–2018年のデータが使用できる。 JGSSは20–89歳という幅広い年齢層を対象としているため、たとえば5000人の有効回答があったとしても、分析対象者を限定していくと、対象人数は少なくなり、分析が難しいことがある。このような場合には、複数時点の調査データを合併して分析する（もしくは後述のように別のデータを使う）という方法がある2。ただし、関心のある変数がどの時点にも含まれているかどうかをよく確認すること。 居住都道府県に関する情報は2006年まで、地域ブロック（北海道・東北、関東、中部、近畿、中国・四国、九州の6区分）に関する情報は2010年までのデータにしか含まれていないことに注意。詳しくはこちらを参照のこと。 1.6.3 JGSS以外の日本の社会調査 JGSSでは自分たちの関心にあった研究が難しいという場合もあるかもしれない。その場合には、別のデータセットの使用を考えてみよう。東京大学社会科学研究所附属社会調査・データアーカイブ研究センターが提供するデータアーカイブでは、研究用に個票データを貸し出している。ここから、データを探してみよう。 データ検索システムにアクセスし、「教育目的利用」の欄を「利用可」に設定し、適当な単語などを入れて検索すると、条件に該当する調査データの一覧が表示される3。 ただし、調査の質はさまざまなので注意したい。気になるデータがあれば、教員に聞くこと。個人的におすすめできる調査データ、および過去の授業で使われた実績のある調査データは次のとおり。 調査名 実施者 実施年 社会階層と社会移動全国調査（SSM調査） SSM調査管理委員会 1955年から10年ごと 全国家族調査（NFRJ） 日本家族社会学会 1998, 2001, 2003, 2008–2012年、2018年（未公開） 東大社研・若年壮年パネル調査（JLPS） 東京大学社会科学研究所 2007年から毎年 全国就業実態パネル調査（JPSED） リクルートワークス研究所 2016年から毎年 子どもの生活と学びに関する親子調査 ベネッセ教育総合研究所 2015年から毎年 日本人の意識調査 NHK放送文化研究所世論調査部 1973年から5年ごと 親と子の生活意識に関する調査 内閣府子ども若者・子育て施策総合推進室 2011年 そのほか、上記のページから入手することはできないが利用可能でかつ定評のある調査データもある。いくつか上げておく。ただし、いずれもパネル調査データなので、分析にはそれなりのスキルが必要になる。 調査名 実施者 実施年 詳細へのリンク 消費生活に関するパネル調査（JPSC） 慶應義塾大学パネルデータ設計・解析センター 1993年から毎年 https://www.pdrc.keio.ac.jp/paneldata/datasets/jpsc/ 日本家計パネル調査（JHPS/KHPS） 同上 2004年から毎年 https://www.pdrc.keio.ac.jp/paneldata/datasets/jhpskhps/ 日本子どもパネル調査 同上 2010年から2014年まで毎年、以降2年に一度 https://www.pdrc.keio.ac.jp/paneldata/datasets/jcps/ 1.6.4 日本以外の社会調査データ もちろん、日本以外の国を対象とした調査データを分析してもよい。中国・韓国・台湾であれば、JGSS同様、大阪商業大学JGSS研究センターが実施しているEast Asian Social Survey（EASS）を使うことを考えてみるとよい。数年に一度、テーマを変えながら毎年実施されている。 その他の国であれば、たとえばICPSRやGESISといった国際的なデータアーカイブから調査データを探すことができる。ICPSRのデータであれば、学部生でも、学内のネットワークからアクセスできる。 また、OECDが実施しているPISA（Programme for International Student Assessment）やPIAAC（Programme for the International Assessment of Adult Competencies）といった国際比較調査も、誰でも利用可能なようにデータが公開されている。本資料でもPIAACの日本版データを例として使用している。 残念ながら、既存の調査で尋ねられていない項目や、既存の調査で尋ねられているものの、それと組み合わせるための項目が尋ねられていないような問いの場合は、研究することができない。たとえば、「性別適合手術を受けて身体の性別を男性から女性に変えた人は、手術前と比べて賃金が低下するのか？」という問い4を立てたとする。しかしながら、管見の限り日本でこの問いを検証可能なデータは存在しないため、この授業では検証することはできない。このように、データによって検証不可能な場合は、それと関連する別の問いへと問いを「ずらす」ことで、検証可能な問いを立てる必要がある。 1.7 先行研究を探す 分析以前の段階でたくさんの先行研究を読み、先行研究で何が明らかになっていないのかを明確にすればするほど、何をすべきかが明確になり、データ分析や論文執筆がスムーズに進むようになる。研究の質は、分析内容それ自体よりもむしろ、先行研究との違いを正確に見出しているかどうかに大きく左右される。それゆえ、先行研究を探すことはとても重要である。もちろん、こうした作業はデータ分析を始めてからもさらに進めていくことになる。 ただたんにGoogleで検索にかけてても、良い論文にたどり着くことは難しい。たとえばGoogle Scholarを使って論文を探すというのは基礎演習などで教わったかもしれない。しかし、世の中には数え切れないくらいたくさんの論文があり、かつ、論文の質も玉石混交である。さらに、研究には「流れ」があり、手当たり次第に参考文献を並べたとしても、貢献すべき先行研究群（literature）を設定することは難しい。 そこで、文献を探し先行研究群を設定するにあたって、一般的な方針をいくつか紹介しておく。 1.7.1 査読つき論文 まずは、査読付きの学術雑誌に掲載された論文を優先的に探して読むとよい。査読とは、論文が掲載される前に匿名の審査員によって審査し、修正を要求することを指す。査読を通っていることは、その論文が一定以上の質が担保されていることを意味する。例えば『◯◯大学紀要』のような雑誌は査読がないことが多い。もちろん、目が肥えてくれば査読の有無にかかわらず良い論文を判断できるようになる（わからない場合は教員に聞くこと）が、それまではまず査読を通った論文を優先して読むとよい。 日本語で書かれた社会学に関連する査読付き論文を掲載している学術雑誌としては、たとえば以下のようなものがある5。 社会学評論 家族社会学研究 教育社会学研究 日本労働研究雑誌 理論と方法 人口学研究 ソシオロジ フォーラム現代社会学 年報社会学論集 社会学年報 1.7.2 研究の流れをつかむ ある程度よい論文を見つけたら、次はその論文で参考文献として引用されている論文、もしくはその論文を参考文献として引用している論文（被引用論文、という）を読んでいくことをおすすめする。ある論文が参考にしている論文は当然重要な論文である可能性が高い。また読んだ論文にその後インパクトがあったのであれば、別の論文にも引用されているはずである。被引用論文は論文それ自体にはもちろん書いていないが、Google Scholarで探すことができる。 このように、ある論文の参考文献と被引用論文を示した一例が次の図である。この図はConnected papersというページで作ることができる。図の真ん中にあるTorche, 2011は、それ以前の多くの先行研究を引用している（主に左側に配置）。そしてその後多くの研究がTorche, 2011を引用していることがわかる（主に右側に配置）。このように、ある研究から影響のある論文へとたどっていくことで、研究の流れが見えるようになってくる。このような研究の流れのなかに自分の研究を位置づけることができたならば、その研究のインパクトはますます大きくなる。 Torche, Florencia. 2011. “Is a College Degree Still the Great Equalizer? Intergenerational Mobility across Levels of Schooling in the United States.” American Journal of Sociology 117(3):763–807. の引用ネットワーク 出所）https://www.connectedpapers.com/ （2022年2月1日作成） 分野がある程度発展している場合には、レビュー論文といって、当該領域に関する論文をまとめて、何がわかっていて何がわかってないのかを示した論文がある場合がある6。こうしたレビュー論文は、先行研究を探したりテーマを絞り込んだりするのに役に立つ。 1.7.3 書籍 日本語圏の社会学業界では書籍文化が強く、重要な論文がしばしば雑誌論文としてではなく書籍として出版されていることも多い。しかし、やはり手当たり次第に書籍を読んだところで、みるべき先行研究群を見つけ出すのは簡単ではない（少し経験を積めば判別できるようになるが）。大雑把に言って、研究として信頼できるに足る書籍は、次のような特徴を備えている。 先に述べたような査読付き論文で引用されている。 大学図書館または（比較的最近の書籍であれば）学内の書店の書棚に置かれている。 参考文献リストが記載されており、少なくない参考文献が参照されている。 もちろん、これらの条件を満たしていればすべて信頼に足るというわけではないが、amazonでキーワード検索して出てくる書籍を手当たり次第に読むとか、主に一般書だけを扱っている書店に行くとかよりは、信頼に足る書籍に出会える見込みは高い。 1.7.4 英語論文 英語が読める（読もうという意欲がある）のであれば、英語論文も探せるととてもよい。競争も激しく、査読も厳しいため、日本語論文よりも内容的に優れたものに出会える可能性は多い。同じテーマであっても、日本国内の数倍〜数十倍は蓄積があることがほとんどである。ただし英語論文については、大学内のネットワークからでないとアクセスできないことが多いので注意。 社会学における代表的な英文雑誌には以下のようなものがある。 American Sociological Review American Journal of Sociology Annual Review of Sociology7 Social Forces European Sociological Review Sociology of Education Journal of Marriage and Family Demography Research in Social Stratification and Mobility "],["preparation.html", "Chapter 2 RとRStudioの下準備 2.1 RとRStudioのインストール方法 2.2 データ分析のワークフロー 2.3 プロジェクトの作成 2.4 基本的な操作 2.5 Rの基礎（準備中）", " Chapter 2 RとRStudioの下準備 2.1 RとRStudioのインストール方法 矢内勇生先生のページを参照して、RおよびRStudioをインストールしてください。体感では、お使いのPCの環境的な問題によりインストールでつまづく人が10人に1–2人くらいの割合でいるので、つまづくのはよくあることです。なので、つまづいたら教員に質問しましょう。 Macの人は38ページまで、Windowsの人は102ページまでやれば準備完了です。 MacとWindowsの人どちらも：「RStudioのカスタマイズ」（Macの人は39ページ以降、Windowsの人は103ページ以降）は、やらなくても問題ありません。 Windowsの人向け：p.27–35の「対処法その3」は（よっぽどパソコンに詳しい人でない限り）危険な操作なのでおすすめしません。 Windowsの人向け：p.58–66の「プログラミング用フォントのインストール」は飛ばしても問題ありません。 基本的には上記の資料のとおりにやればうまくいくと思いますが、何やらエラーが出る場合には2020年の別の授業経験をもとに書いた以下の記事が参考になるかもしれません。 2.2 データ分析のワークフロー データ分析のワークフローをおおまかに示すと、次のようなものになる。 プロジェクトフォルダを作成する（この章で解説） データを取得する（→データの読み込み） データを開く（→データの読み込み） データを加工する（→データの加工） 変数の作成 サンプルの限定 加工したデータの保存 データを分析する 基礎集計（→1変量の集計） 2変量の関連分析（→2変量の集計、回帰分析の基礎） 他の要因を統制した分析（→回帰分析の活用） 分析結果を出力する 誤りや改善点、アイデアを見つけ、再度データを加工する（4に戻る、4から7をn回繰り返す） 最終的な分析結果を論文にまとめる 出版された論文を読むと、エレガントな分析結果がはじめからスムーズに提示されているような印象を受けるかもしれない。しかしながら、実際はそのようにスムーズに分析が進むことはない。舞台裏では（必ずしもきれいとはいえない）データを加工し、分析し、間違いをみつけては再度データを加工して分析し、他の人からコメントをもらったりして再度データを加工したり分析して……といったふうに何度もPDCAが行われている。なので、データ分析の過程で行きつ戻りつすることはむしろふつうのことだと思ったほうがよい。 PDCAの過程では、「研究計画を立てる」で作成したような研究計画を修正したりすることがある。それ自体は必ずしも悪いことではない。しかし、計画なしに手当たり次第に分析してしまっては、自分が何をやっているのかわからなくなってしまう。自分が何をしたいのか、自分が今何をしているのか（上記のどの段階にいるのか）を意識しながら、データを加工したり分析したりすることが重要になる。 2.3 プロジェクトの作成 2.3.1 RStudioを開いてみよう RStudioを開いたときの見た目 特に設定を変えていないならば、はじめてRStudioを開くと次のような画面になっている。それぞれ以下のように対応している。 左のウインドウ：コマンドを入力して、結果が出力されるウインドウ 右上のウインドウ：読み込まれているオブジェクトを表示するウインドウ 右下のウインドウ：ファイルの一覧をみたり、グラフが表示されたり、ヘルプファイルを表示されたりするウインドウ 2.3.2 授業用のフォルダを作ろう この授業のために使う資料やコードなどをまとめておくためのフォルダを作っておくとよい。適宜、自分のわかりやすい箇所を選ぶとよい。 Windowsの場合：「OneDrive」→「ドキュメント」の下などに作成すると、自動でバックアップを取ってくれるのでおすすめ。 Macの場合：「iCloud Drive」→「書類」の下などがおすすめ。 いずれも、Cloudの容量の上限に達しているとエラーが出るので注意。写真や動画ファイルなどは容量が大きいのでCloudの容量を拡張したり別のサービスを使って、そちらに移しておくとよい。 2.3.3 ファイルパスと作業ディレクトリ コンピュータ上のさまざまなファイルを置いた場所を指してフォルダ、あるいはディレクトリという。コンピュータ上のファイルは基本的にフォルダの中に入れて管理する。 このフォルダにはそれぞれ住所がついている。この住所を指して、ファイルパス、またはたんにパスという。たとえば自分がこの資料を作成しているフォルダのファイルパスは、“User/mugi/…（中略）…/seminar_sociology_r”である。 ファイルパスというのが何かをつかむため、現実世界の住所について考えてみよう。たとえば、学習院大学目白キャンパスの住所は「東京都豊島区目白1-5-1」である。この住所は、前から順番に読んでいって、より小さい単位を指す（東京都のなかにある豊島区、豊島区のなかにある目白、目白のなかにある1丁目……というふうに）。ファイルパスはまさにこの「東京都豊島区目白1-5-1」のような住所であり、フォルダのありかを示す役割を果たす。 RStudioが作業場所だと認識している場所を指して、作業ディレクトリという。この作業ディレクトリのファイルパスは、左下の画面の上部に記載されている。分析などを行う際には、このファイルパスが自分の意図している場所と一致しているかどうかを確認する必要がある。 2.3.4 プロジェクト作成の手順 先ほど作成した授業用フォルダのなかに、データを置いたりコードを置いたりするためのフォルダを作って、そこが作業ディレクトリだとRStudioに教えてあげたい。このようなときに便利な昨日が、「プロジェクト」である。この機能を利用することで、プロジェクトを作成した場所が作業ディレクトリであることをRに教えてあげることができる。新たな研究をはじめるときには、必ずプロジェクトを作成するようにする。 プロジェクトの新規作成手順は次のとおり。 “File” &gt; “New Project”、または右上の”Project”の箱を選択 &gt; “New Project” “New Directory”を選択 “New Project”を選択 Directory nameに作業ディレクトリの名前をつけて（ここでは「seminar_sociology_r」とする）、“Browse”から新しいフォルダを作る場所（先ほどの授業用フォルダ）を選択 指定した場所に、“seminar_sociology_r.Rproj”というファイルが入ったフォルダができる 右上の表示が（まだ何もプロジェクトを開いていない場合には）「Project: None」から「seminar_sociology_r」に変わっていることを確認する。 すでに作成済みのフォルダを作業用フォルダとして指定したい場合には、次のような手順で行う。 “File” &gt; “New Project”、または右上の”Project” &gt; “New Project” “Existing Directory”を選択 “New Project”を選択 “Browse”から作業用フォルダとして指定したいフォルダを選択 右上の表示が（まだ何もプロジェクトを開いていない場合には）「Project: None」から作業用フォルダとして指定したフォルダの名前に変わっていることを確認する。 Project: (None)の状態 Projectを開いた状態 フォルダ内に作成されるRprojファイル 2.4 基本的な操作 RStudioを開いたときの見た目（再掲） プロジェクトが作成できたら、ためしに左のウインドウに以下のコードを書いて、Enterを押してみよう。計算結果が表示される。 1 + 2 ## [1] 3 2.4.1 スクリプトファイル 実際には上記のような1行ですむコードを書くわけではもちろんなく、色々とコードを書いて、データを加工したり分析をしたりしていく。そうなってくると、コードはコードとしてまとめて書くことのできる場所があると嬉しいだろう。このような用途で使うのが、スクリプトファイルである。以下の手順で新規のスクリプトファイルを開くことができる。 左上の白い四角にプラス（+）マークのついたアイコンをクリック 「R script」を選択 すると、RStudioの左上に次のような場所が現れる： この左上のスクリプトファイルにコードを書き、実行したい行にカーソルを合わせて、スクリプト右上の「Run」をクリックすると、命令が実行され、結果が左下のConsoleに出力される。実行したい箇所をドラッグした状態で実行すれば、複数の命令をまとめて実行することもできる。 「Run」は頻繁に使うので、毎回クリックするのは面倒なので、ショートカットキーを覚えよう。実行には以下のショートカットキーを使う。 Windows: ctrl + enter Mac: command + enter 以下のコードを実行してみよう： 1 + 2 ## [1] 3 8 - 3 ## [1] 5 10 * 8 ## [1] 80 4 / 15 ## [1] 0.2666667 2.4.2 スクリプトファイルを保存する 上記のようにスクリプトを書いて実行していくわけだが、スクリプトを書いた変更が保存されていない状態だと、スクリプトの上部が赤く表示される。 このスクリプトを保存する場合には、上記のフロッピーディスク（今の大学生は見たことも聞いたこともないと思いますが……）のアイコンをクリックすると、変更を保存することができる。フロッピーディスクが1枚のアイコンは「上書き保存」、2枚重なったアイコンは「現在開いているスクリプトファイルをまとめてすべて保存」を表している。 スクリプトを保存すると、赤い文字列は黒い表示になり、無事保存されたことがわかる。保存したファイルは「xxxxx.R」というファイルとして、現在開いているプロジェクトフォルダに保存される。後日作業を再開するときには、再度当該ファイルを開けばよい。 2.4.3 パッケージのインストール install.packages()はゲームソフトを購入（無料ですが）するようなもの。実際にそのソフトに入っているコンテンツを使うためには、毎回RStudioを立ち上げるために、ゲームソフトをセットしないといけない。その際には、library()を用いる。 本資料では以下のパッケージを使用する。今のうちにまとめてインストールしておこう。 install.packages(&quot;tidyverse&quot;) install.packages(&quot;haven&quot;) install.packages(&quot;readxl&quot;) install.packages(&quot;gtsummary&quot;) install.packages(&quot;modelsummary&quot;) install.packages(&quot;flextable&quot;) install.packages(&quot;estimatr&quot;) install.packages(&quot;broom&quot;) とくに重要なのがtidyverseパッケージ。以下の8つのパッケージをまとめたパッケージ群であり、どれもよく使うものなので、何らかの分析をする際にはほとんど常にlibrary(tidyverse)を実行しておくことになる。 ggplot2 tibble tidyr readr purrr dplyr stringr forcats 2.5 Rの基礎（準備中） これについてはたくさんの素晴らしい解説が世の中にあふれているのでここでは扱わない。一例として以下の箇所などを参照のこと。以下の箇所で扱われている程度の基礎的な知識を次章以降では前提とする。 浅野正彦・矢内勇生，2018，『Rによる計量政治学』オーム社より「4.2 Rの基本操作」. 安井翔太・株式会社ホクソエム，2020，『効果検証入門：正しい比較のための因果推論／計量経済学の基礎』技術評論社より「付録 RとRStudioの基礎」 Imai, Kosuke. 2018. Quantitative Social Science: An Introduction.Princeton University Press. （粕谷祐子・原田勝孝・久保浩樹訳，『社会科学のためのデータ分析入門』岩波書店．）より”1.3 Introduction to R”（「1.3 Rの基礎」） 太郎丸博，2021，「データを読み込む前に知っておきたいRの基礎」（太郎丸博先生の授業関連ページ→「R入門（2021年社会学実習 G科目）」にアップロードされている資料です） "],["import.html", "Chapter 3 データの読み込み 3.1 Rのサンプルデータの読み込み 3.2 作業ディレクトリ上のデータの読み込み 3.3 ウェブ上のデータの読み込み", " Chapter 3 データの読み込み 本章では、Rを使ってデータを読み込む方法を説明する。 内容に入る前に、右上のプロジェクトのボックスの横が、前章で作成したプロジェクトの名前（たとえば、seminar_sociology_r）になっているかどうかを確認しておこう。なっていない場合は、右上のボックスをクリックして、「Open Project…」を選択し、前章で作成したRprojファイル（たとえば、seminar_sociology_r.Rprojといったような名前になっている）を選んで、プロジェクトを切り替えよう。 本章では以下の3つのパッケージを使用するので、あらかじめパッケージを読み込んでおこう。 3.1 Rのサンプルデータの読み込み Rにはいくつかのサンプルデータがあらかじめ入っており、これを読み込んで試しに分析することもできる。ここでは例としてAnscombe’s Quartetのデータをみてみよう： anscombe ## x1 x2 x3 x4 y1 y2 y3 y4 ## 1 10 10 10 8 8.04 9.14 7.46 6.58 ## 2 8 8 8 8 6.95 8.14 6.77 5.76 ## 3 13 13 13 8 7.58 8.74 12.74 7.71 ## 4 9 9 9 8 8.81 8.77 7.11 8.84 ## 5 11 11 11 8 8.33 9.26 7.81 8.47 ## 6 14 14 14 8 9.96 8.10 8.84 7.04 ## 7 6 6 6 8 7.24 6.13 6.08 5.25 ## 8 4 4 4 19 4.26 3.10 5.39 12.50 ## 9 12 12 12 8 10.84 9.13 8.15 5.56 ## 10 7 7 7 8 4.82 7.26 6.42 7.91 ## 11 5 5 5 8 5.68 4.74 5.73 6.89 このデータにdfという名前をつけて格納する。 df &lt;- anscombe このようにデータフレームをオブジェクトに入れると、右上の「Environment」のウインドウに次のような表示が現れる。 11 obs. of 8 variablesと書かれている。11 obs.というのは、「このデータフレームは全部で11行ありますよ」ということを示しており、8 variablesというのは、「このデータフレームには8つの列がありますよ」ということを示している。実際にどのようなデータが読み込まれているかは、上記画像のdfあたりをクリックするか、次のコードを実行すると新しいタブが開き、そこにデータの中身が表示される。 df %&gt;% view() このようなデータが読み込まれているはずだ。 その他にも、データのうち一部を表示したり、変数の一覧を表示したりするコマンドがある。ここではコードを紹介するにとどめるので、各自で実行してみてほしい。 df %&gt;% head() df %&gt;% names() df %&gt;% glimpse() 3.2 作業ディレクトリ上のデータの読み込み 3.2.1 データを置く場所を作る 前章ではプロジェクトを作成して、Rに作業を行う場所（作業ディレクトリ, working directory）を教えてあげた。この場所に、データを置くためのフォルダを別途作成しておくとよい。作成する方法は以下の2つである。 作業ディレクトリとして設定したフォルダを開き、右クリック→「新規フォルダ」（Mac）または「新規作成」→「フォルダ」を選択（Windows）。フォルダの名前は「data」としよう。 以下のコードを実行する。 dir.create(&quot;data&quot;) フォルダを作ったら、下記のコードを実行して練習用のデータをダウンロードしよう（コピー&amp;ペーストでよい）。コードを実行すると、先ほど作った「data」フォルダにダウンロードしたデータが入っていることを確認しよう。 download.file(&quot;https://github.com/mugiyama/seminar_sociology_r/raw/master/data/census_pop.csv&quot;, destfile = &quot;data/census_pop.csv&quot;) download.file(&quot;https://github.com/mugiyama/seminar_sociology_r/raw/master/data/census_pop.xlsx&quot;, destfile = &quot;data/census_pop.xlsx&quot;) download.file(&quot;https://github.com/mugiyama/seminar_sociology_r/raw/master/data/census_pop.rds&quot;, destfile = &quot;data/census_pop.rds&quot;) download.file(&quot;https://github.com/mugiyama/seminar_sociology_r/raw/master/data/census_pop.sav&quot;, destfile = &quot;data/census_pop.sav&quot;) download.file(&quot;https://github.com/mugiyama/seminar_sociology_r/raw/master/data/census_pop.dta&quot;, destfile = &quot;data/census_pop.dta&quot;) 3.2.2 csv形式のファイル example.csvというふうに、末尾に.csvとついているのはcsv形式といって、一つひとつの値をカンマで区切った形式である。readr::read_csv()でcsv形式のファイルを読み込むことができる。readrというのはtidyverseパッケージを読み込むと読み込まれるパッケージの一つである。 df &lt;- read_csv(&quot;data/census_pop.csv&quot;) 3.2.3 xlsx形式のファイル census_pop.xlsxというふうに、末尾に.xlsxとついている（古いExcel形式だと.xls）のはMicrosoft Excelのデータ形式である。readxl::read_excel()でxlsx形式のファイルを読み込むことができる。readxlは冒頭で読み込んだパッケージである。 df &lt;- read_excel(&quot;data/census_pop.xlsx&quot;) 3.2.4 rds形式のファイル census_pop.rdsというふうに、末尾に.rdsとついているのはRびデータ形式である。rds形式で保存されたデータは、Rで読み込むうえではもっとも便利な形式である（が、rds形式で社会調査の個票データが提供されることはまれ）。readr::read_rds()でrds形式のファイルを読み込むことができる。 df &lt;- read_rds(&quot;data/census_pop.rds&quot;) 3.2.5 sav形式のファイル census_pop.savというふうに、末尾に.savとついているのはSPSSという統計ソフトのデータ形式である。SSJDAなどからデータを借りた場合にはSPSS形式であることがほとんどである。haven::read_sav()でsav形式のファイルを読み込むことができる。havenは冒頭で読み込んだパッケージである。 df &lt;- read_sav(&quot;data/census_pop.sav&quot;) 3.2.6 dta形式のファイル example.dtaというふうに、末尾に.dtaとついているのはStataという統計ソフトのデータ形式である。haven::read_dta()でdta形式のファイルを読み込むことができる。 df &lt;- read_dta(&quot;data/census_pop.dta&quot;) 3.2.7 文字コードに関わる問題 ファイルを読み込む際に、ファイルのなかに日本語が含まれていたりすると、エラーが起こることがある。このあたりの問題への詳しい対処は土井翔平先生のページに記載されているので、参考にするとよい。 3.3 ウェブ上のデータの読み込み ウェブサイト上にExcel形式のファイルやcsv形式のファイルがアップロードされている場合、それを直接読み込んでくることができる。たとえば、e-Stat上にアップロードされている国勢調査の主要時系列データのうち、「年齢（５歳階級），男女別人口－全国（大正９年～平成27年）」のデータを読み込んでみよう。先ほどの文字コード絡みの問題があるため、read_csv()に少しくふうを加えている。 file_url &lt;- &quot;https://www.e-stat.go.jp/stat-search/file-download?statInfId=000031524030&amp;fileKind=1&quot; df &lt;- read_csv(file_url, locale = locale(encoding = &quot;shift-jis&quot;)) ## Rows: 406 Columns: 7 ## ── Column specification ──────────────────────────────────────────────────────── ## Delimiter: &quot;,&quot; ## chr (2): 元号, 年齢5歳階級 ## dbl (5): 和暦（年）, 西暦（年）, 人口（総数）, 人口（男）, 人口（女） ## ## ℹ Use `spec()` to retrieve the full column specification for this data. ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. Windowsユーザーの場合は以下で大丈夫かもしれない（未確認）。 df &lt;- read_csv(file_url) ただし、何度もアクセスするのは当該ウェブサイトのサーバーに負荷をかけてしまう。頻繁に更新されるようなファイルでなければ、自分のパソコン上にダウンロードしたほうがよいだろう。download.file()でファイルをダウンロードできる。 download.file(url = file_url, destfile = &quot;data/census_pop_original.csv&quot;) ダウンロードしたデータは、これまでと同じように、csvやexcelなどの形式に対応するかたちで読み込んでやればよい。 df &lt;- read_csv(&quot;data/census_pop_original.csv&quot;, locale = locale(encoding = &quot;shift-jis&quot;)) ## Rows: 406 Columns: 7 ## ── Column specification ──────────────────────────────────────────────────────── ## Delimiter: &quot;,&quot; ## chr (2): 元号, 年齢5歳階級 ## dbl (5): 和暦（年）, 西暦（年）, 人口（総数）, 人口（男）, 人口（女） ## ## ℹ Use `spec()` to retrieve the full column specification for this data. ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. Windowsユーザーの場合は以下で大丈夫かもしれない（未確認）。 df &lt;- read_csv(file_url) なお、先ほど紹介した各種形式の「census_pop」のデータは、今ダウンロードしてきたデータに少し手を加えて麦山が作成した練習用データである。 "],["handling.html", "Chapter 4 データの加工 4.1 本資料で用いるデータ 4.2 データ加工のステップ 4.3 パイプ演算子（%&gt;%または|&gt;）について（準備中） 4.4 変数の作成 4.5 変数の作成についてのtips 4.6 %&gt;%をつなげてコマンドをまとめる 4.7 サンプルの限定 4.8 データの追加（発展）", " Chapter 4 データの加工 この章ではデータの加工方法について説明する。 内容に入る前にいくつか確認しておこう。 第1に、右上のプロジェクトのボックスの横が、第2章で作成したプロジェクトの名前（たとえば、seminar_sociology_r）になっているかどうかを確認しておこう。なっていない場合は、右上のボックスをクリックして、「Open Project…」を選択し、前章で作成したRprojファイル（たとえば、seminar_sociology_r.Rprojといったような名前になっている）を選んで、プロジェクトを切り替えよう。 第2に、第3章で確認したとおり、データを格納するためのフォルダがプロジェクトフォルダ内に準備されていることを確認しよう。作っていない場合には、データを置く場所を作るを確認し、作成しておこう。 第3に、上記の準備をすませたうえで、以下のとおりtidyverseパッケージを読み込もう。 library(tidyverse) 4.1 本資料で用いるデータ 本資料では基本的に、OECDが実施している国際成人力調査Programme for the International Assessment of Adult Competencies, PIAACの日本版データをサンプルデータとして使用する。 ダウンロード手順は以下のとおり。まず、Dataのページから “Download the datasets (Public Use Files)” &gt; “csv” &gt; “prgjpnp1.csv” を選択して、ファイルをダウンロードできる。 ダウンロードファイルを「data」のフォルダに入れるのを忘れずに。 「data」のフォルダに入っていることを確認して、データを読み込む。このデータは少し特殊で、数値のほかに文字列などが入っている。そのため、すこしだけ特殊な処理をほどこしてデータを読み込むことにする。 piaac &lt;- read_csv(&quot;data/prgjpnp1.csv&quot;) %&gt;% mutate_if(is.character, as.numeric) %&gt;% #すべての文字列変数を小文字に変換 rename_all(.funs = tolower) #すべての大文字を小文字に変換 ## Rows: 5278 Columns: 1328 ## ── Column specification ──────────────────────────────────────────────────────── ## Delimiter: &quot;,&quot; ## chr (470): DISP_MAIN, B_Q01a3, B_Q01a3_C, B_Q01b, B_Q01c1, B_Q01c1_C, B_Q01c... ## dbl (656): CNTRYID, CNTRYID_E, SEQID, AGE_R, GENDER_R, DISP_CIBQ, A_N01_T, B... ## lgl (202): DISP_MAINWRC, D_Q16b_T, P901002R, P901002S, P904012R, P904012S, P... ## ## ℹ Use `spec()` to retrieve the full column specification for this data. ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 通常、SSJDAなどの機関を通して社会調査データをダウンロードしたときに文字列が入っていることはまれなので、あまり心配しなくてよい。 4.2 データ加工のステップ いざデータを手に入れて読み込むことができたとしても、そこから分析に至るまでにはデータを加工して、分析の準備をしなくてはならない。このデータ加工は、大きく分けて以下の2つ（3つ）のステップからなる。 変数の作成 サンプルの限定 データの追加（該当者のみ） データの加工を行う際には、今書いているコードがそれぞれ上記3つの作業のうちどの作業に該当するのかを混同しないように注意する。 変数の作成とサンプルの限定とはそれぞれ次のような操作を指す。たとえば、以下のようなデータがあるとする。 ## # A tibble: 6 × 3 ## id x1 x2 ## &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 1 5 1 ## 2 2 8 1 ## 3 3 2 1 ## 4 4 0 2 ## 5 5 6 2 ## 6 6 1 2 「変数の作成」では、この元データを加工して、次のような列を追加する作業にあたる。 ## # A tibble: 6 × 5 ## id x1 x2 x3 x4 ## &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; ## 1 1 5 1 500 男性 ## 2 2 8 1 800 男性 ## 3 3 2 1 200 男性 ## 4 4 0 2 0 女性 ## 5 5 6 2 600 女性 ## 6 6 1 2 100 女性 「サンプルの限定」は、データから一部の対象者だけを選ぶ、言い換えれば行を削除する作業にあたる。 ## # A tibble: 3 × 5 ## id x1 x2 x3 x4 ## &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; ## 1 1 5 1 500 男性 ## 2 2 8 1 800 男性 ## 3 5 6 2 600 女性 4.3 パイプ演算子（%&gt;%または|&gt;）について（準備中） 準備中です 4.4 変数の作成 データを読み込んだとしても、調査で尋ねられた回答（列）をそのまま使えることはまれで、無回答を示す番号（9など）が含まれていたり、数値が意図しているならびと逆向きになっていたりと、そのままでは使えないことが多い。このような場合には、回答を記録した列を加工して、自分で意図した変数へと変換していく必要がある。社会調査データの分析を行う場合、かなり多くの作業がこの「変数の作成」に使われることになる。 4.4.1 変数の型（カテゴリ変数と連続変数） 変数は、その種類によって（大きく）カテゴリ変数と量的変数に分けることができる8。 カテゴリ変数の例 Rで扱うときの型 カテゴリ変数 性別、居住地域、職業など factor 連続変数 所得、幸福度など numeric カテゴリ変数は、グループや属性といったように、足し算や引き算をしたり、平均値を取ったりといった操作に意味のない変数を指す。たとえば居住地域の場合は、「東京都」「京都府」といったふうな値が入っているだろう。この値の平均値というのはそもそも定義することができない。 連続変数は、足し算や引き算をしたり平均値を取ったりといった操作に意味がある。たとえば所得の場合は、個々人は300万円だったり700万円だったりといった値を取るわけだが、平均値を取れば所得平均という意味のある値になる。 ものによっては、カテゴリ変数とも連続変数ともとれる変数もある。たとえば学歴は、「中学」「高校」「専門」「短大」「高専」「大学」「大学院」と分けるのであればカテゴリ変数であるが、教育年数（何年学校に通ったか）で測定する場合には、9, 12, 14, 16, 18などの値を取る連続変数とみなすことができる。カテゴリ変数とみなすべきか、連続変数とみなすべきかは先行研究での扱いや、問題関心に依存する。くわしくは「変数の作成についてのtips」を参照。 多くの場合、社会調査データの個票でははじめからこれらカテゴリ変数と連続変数が区別されているわけではない。たとえば性別であれば、「男性」であれば1、「女性」であれば2というふうな値が入っている。あるいは所得であれば、「0万円」であれば1、「0〜25万円」であれば2、というふうな値が入っている。そのため、単純に平均値を取ってしまうと、本来は連続変数とはみなせないものの平均値を計算できてしまう。しかし、それには何の意味もない。そのため、分析に入る前に、自分が使用する変数を適切な型や値へと加工していく必要があるのである。 4.4.2 新たな変数をつくる：mutate() データ操作の基本は、すでにある変数を書き換えたりして、自分の関心に即した新しい変数を作ることである。このときに使用するのがmutate()。変数の加工を行うときには、ほとんどの場合このmutate()を使うことになる。以下に、いくつか簡単な例を挙げる。 4.4.2.1 例1: もとの変数の内容をそのままコピーする PIAACには、ボーナスの額を含めて、対象者の給与を時給換算したearnhrbonusという変数が含まれている。この変数をそのままコピーして、時給換算した賃金を表す変数wageを作成する。 piaac %&gt;% mutate(wage = earnhrbonus) このコードは、「piaacというデータフレームにwageという列を追加してね、ちなみにその列には（既存の列である）earnhrbonusの値を入れてね」という命令を表している。 ただしこれだけだと新たに列を追加した結果だけが表示されて、データフレームそのものは更新されることはない。そこで、次のようにして、列を追加した結果を新たなデータフレームに格納してみる。 piaac_new &lt;- piaac %&gt;% mutate(wage = earnhrbonus) すると、右側のEnvironmentのウインドウに新たに「piaac_new」というデータフレームが追加される。 piaac_new というのが、新たに1つ列を追加したデータフレームである。 もしくは、次のように同じデータフレームに格納してもよい。 piaac &lt;- piaac %&gt;% mutate(wage = earnhrbonus) 先ほどpiaac_new というデータフレームに格納したのが「名前をつけて保存」に当たるとしたら、これは「上書き保存」に当たるようなイメージである。どちらでも、個人の好みに応じて使い分けるとよいだろう。 さて、上記の処理を行った結果、piaacというデータフレームには、earnhrbonusとまったく同じ値が含まれるwageという列が作られたことがわかる。 piaac %&gt;% select(earnhrbonus, wage) %&gt;% # select()についてはこのあと解説があります head() ## # A tibble: 6 × 2 ## earnhrbonus wage ## &lt;dbl&gt; &lt;dbl&gt; ## 1 793. 793. ## 2 1763. 1763. ## 3 2692. 2692. ## 4 2312. 2312. ## 5 NA NA ## 6 5192. 5192. もとの変数を何ら加工せずにそのまま使うとしても、元々の変数の名前がわかりやすいとはいえない名前になっていることはよくある（たとえば、q31_3、など）。このような場合には、今行ったように、その列が何の変数であるかがすぐに分かるように新たに名前を付けた列を作成すると、後から間違いが少なくなる。 4.4.2.2 例2: もとの変数に何らかの計算を施す たとえば、1週間の労働時間を尋ねた変数d_q10を5で割って、平日1日あたりの労働時間に変換した列を作りたいというときがあるだろう。このような場合には次のように計算する。 piaac &lt;- piaac %&gt;% mutate(workhour = d_q10 / 5) 新しく作った列workhourは、たしかにもともとの変数を5で割った値になっていることがわかる。 piaac %&gt;% select(d_q10, workhour) %&gt;% head() ## # A tibble: 6 × 2 ## d_q10 workhour ## &lt;dbl&gt; &lt;dbl&gt; ## 1 48 9.6 ## 2 60 12 ## 3 50 10 ## 4 60 12 ## 5 NA NA ## 6 40 8 調査時点での就業状態（働いているか否か）を尋ねた項目c_q01aでは、働いていれば1、そうでなければ2という値が入っている。これを変換して、働いていれば1、そうでなければ0となるような変数workを作ってみよう。 piaac &lt;- piaac %&gt;% mutate(work = 2 - c_q01a) 新しく作った列workは、確かにもともとの変数の値が1であれば1、2であれば0となっていることがわかる。 piaac %&gt;% select(c_q01a, work) %&gt;% head() ## # A tibble: 6 × 2 ## c_q01a work ## &lt;dbl&gt; &lt;dbl&gt; ## 1 1 1 ## 2 1 1 ## 3 1 1 ## 4 1 1 ## 5 2 0 ## 6 1 1 4.4.2.3 例3: もとの変数と関係なく、まったく新しい変数を作成する たとえば、以下のように1ずつ増える変数を作成することもできる。この変数を分析に直接使用するということはないが、通し番号が振ってあると何かと便利なことが多い。 piaac &lt;- piaac %&gt;% mutate(id = 1:n()) n() はデータフレーム内の行数を返す関数。上記3つの例で作成した変数を並べてみよう： piaac %&gt;% select(id, wage, workhour) %&gt;% head() ## # A tibble: 6 × 3 ## id wage workhour ## &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 1 793. 9.6 ## 2 2 1763. 12 ## 3 3 2692. 10 ## 4 4 2312. 12 ## 5 5 NA NA ## 6 6 5192. 8 4.4.3 条件の指定：if_else() 実際にmutate()で既存の変数の値を書き換えたりする場合には、カテゴリをまとめたり、複数の変数を組み合わせて新しい変数を作成したりすることが多い。そこでよく使う関数がif_else()、case_when()、factor()の3つである。 4.4.3.1 if_else()の説明 if_else()は、条件を指定し、その条件に合う場合と合わない場合の値を返す関数。if_else(条件, 条件に合う場合の値, 条件に合わない場合の値)、というふうに使う。 piaac &lt;- piaac %&gt;% mutate(gender = if_else(gender_r == 1, &quot;男性&quot;, &quot;女性&quot;)) 上記は、genderという列に対して、gender_rの列の値が1ならば”男性”、そうでないならば”女性”という文字列を入れてね、という命令である。 新しく変数を作ったときには、きちんとできているかどうかを逐一確認するのがよい。たとえば以下のように、古い変数と新しい変数のクロス集計表を作ってみるのが良い方法だろう。 piaac %&gt;% with(table(gender_r, gender)) ## gender ## gender_r 女性 男性 ## 1 0 2517 ## 2 2761 0 4.4.3.2 論理演算子の説明 上記の例のように、条件を指定するときには論理演算子というのを使用する。よく使う論理演算子の意味は次の通り。 条件記号 意味 コード例 コード例の意味 == 等しい age == 25 年齢が25に等しい != ではない age != 25 年齢が25ではない &gt; より大きい age &gt; 25 年齢が25より大きい &lt; より小さい age &lt; 25 年齢が25より小さい &gt;= 以上 age &gt;= 25 年齢が25以上（25を含む） &lt;= 以下 age &lt;= 25 年齢が25以下（25を含む） &amp; かつ age &gt;= 25 &amp; age &lt;= 54 年齢が25以上54以下 | または age &lt; 35 | age &gt; 54 年齢が35より小さいまたは54より大きい 以上、以下のときの不等号の位置（どちらも左側！）、等しいときには=ではなく==、などは間違えやすいので注意しよう。 4.4.4 複数条件の指定：case_when() if_else()の場合は条件節は一つだが、複数の条件を指定して、それぞれの条件に対応するときに特定の値を入れたい、というような時がある。このときには、複数条件を指定して値を書き換えるコマンドである、case_when()をつかうとよい。 piaac &lt;- piaac %&gt;% mutate(agegroup = case_when( 25 &lt;= age_r &amp; age_r &lt;= 34 ~ &quot;25-34歳&quot;, 35 &lt;= age_r &amp; age_r &lt;= 44 ~ &quot;35-44歳&quot;, 45 &lt;= age_r &amp; age_r &lt;= 54 ~ &quot;45-54歳&quot;, 55 &lt;= age_r &amp; age_r &lt;= 64 ~ &quot;55-64歳&quot; )) ちゃんとできたかを確認しよう。 piaac %&gt;% with(table(age_r, agegroup)) ## agegroup ## age_r 25-34歳 35-44歳 45-54歳 55-64歳 ## 16 0 0 0 0 ## 17 0 0 0 0 ## 18 0 0 0 0 ## 19 0 0 0 0 ## 20 0 0 0 0 ## 21 0 0 0 0 ## 22 0 0 0 0 ## 23 0 0 0 0 ## 24 0 0 0 0 ## 25 70 0 0 0 ## 26 86 0 0 0 ## 27 83 0 0 0 ## 28 77 0 0 0 ## 29 104 0 0 0 ## 30 86 0 0 0 ## 31 105 0 0 0 ## 32 106 0 0 0 ## 33 106 0 0 0 ## 34 110 0 0 0 ## 35 0 126 0 0 ## 36 0 124 0 0 ## 37 0 123 0 0 ## 38 0 144 0 0 ## 39 0 133 0 0 ## 40 0 128 0 0 ## 41 0 110 0 0 ## 42 0 116 0 0 ## 43 0 127 0 0 ## 44 0 111 0 0 ## 45 0 0 93 0 ## 46 0 0 119 0 ## 47 0 0 114 0 ## 48 0 0 110 0 ## 49 0 0 109 0 ## 50 0 0 85 0 ## 51 0 0 97 0 ## 52 0 0 102 0 ## 53 0 0 110 0 ## 54 0 0 98 0 ## 55 0 0 0 103 ## 56 0 0 0 95 ## 57 0 0 0 88 ## 58 0 0 0 133 ## 59 0 0 0 98 ## 60 0 0 0 136 ## 61 0 0 0 138 ## 62 0 0 0 132 ## 63 0 0 0 143 ## 64 0 0 0 145 ## 65 0 0 0 0 もともとのデータには年齢が16歳から65歳の人が含まれているが、先ほどのコードでは16歳から24歳、65歳の人が条件に含まれていなかったので、新しく作成した列であるagegroupには該当するものがないという結果になっている。このようなケースにはNAが与えられる。 実際、NAが与えられているかどうかを確認してみよう。以下のようにwith(table())にオプションuseNA = \"always\"を指定することで、NAについても集計することができる。 piaac %&gt;% with(table(age_r, agegroup, useNA = &quot;always&quot;)) ## agegroup ## age_r 25-34歳 35-44歳 45-54歳 55-64歳 &lt;NA&gt; ## 16 0 0 0 0 114 ## 17 0 0 0 0 90 ## 18 0 0 0 0 96 ## 19 0 0 0 0 76 ## 20 0 0 0 0 90 ## 21 0 0 0 0 75 ## 22 0 0 0 0 72 ## 23 0 0 0 0 88 ## 24 0 0 0 0 84 ## 25 70 0 0 0 0 ## 26 86 0 0 0 0 ## 27 83 0 0 0 0 ## 28 77 0 0 0 0 ## 29 104 0 0 0 0 ## 30 86 0 0 0 0 ## 31 105 0 0 0 0 ## 32 106 0 0 0 0 ## 33 106 0 0 0 0 ## 34 110 0 0 0 0 ## 35 0 126 0 0 0 ## 36 0 124 0 0 0 ## 37 0 123 0 0 0 ## 38 0 144 0 0 0 ## 39 0 133 0 0 0 ## 40 0 128 0 0 0 ## 41 0 110 0 0 0 ## 42 0 116 0 0 0 ## 43 0 127 0 0 0 ## 44 0 111 0 0 0 ## 45 0 0 93 0 0 ## 46 0 0 119 0 0 ## 47 0 0 114 0 0 ## 48 0 0 110 0 0 ## 49 0 0 109 0 0 ## 50 0 0 85 0 0 ## 51 0 0 97 0 0 ## 52 0 0 102 0 0 ## 53 0 0 110 0 0 ## 54 0 0 98 0 0 ## 55 0 0 0 103 0 ## 56 0 0 0 95 0 ## 57 0 0 0 88 0 ## 58 0 0 0 133 0 ## 59 0 0 0 98 0 ## 60 0 0 0 136 0 ## 61 0 0 0 138 0 ## 62 0 0 0 132 0 ## 63 0 0 0 143 0 ## 64 0 0 0 145 0 ## 65 0 0 0 0 70 ## &lt;NA&gt; 0 0 0 0 0 4.4.5 カテゴリ変数へ変換：factor() PIAACには次のように、母親の最終学歴を尋ねた質問項目（j_q06b）がある。 選択肢 調査票の番号 小学校・中学校 1 高校（旧制の中学校、高校を含む） 2 専門学校、高等専門学校、短大、大学以上 3 piaac %&gt;% with(table(j_q06b)) ## j_q06b ## 1 2 3 ## 1553 2303 1098 この数値だけでは、何番が何を指しているのかよくわからない。そこで、この変数の値にそれぞれ名前を付けてカテゴリ変数（factor型）へと変換した変数mothereducを作成する。 piaac &lt;- piaac %&gt;% mutate(mothereduc = factor(j_q06b, levels = 1:3, labels = c(&quot;初等教育&quot;, &quot;中等教育&quot;, &quot;高等教育&quot;))) 結果を確認： piaac %&gt;% with(table(j_q06b, mothereduc)) ## mothereduc ## j_q06b 初等教育 中等教育 高等教育 ## 1 1553 0 0 ## 2 0 2303 0 ## 3 0 0 1098 if_else()やcase_when()を使って新しくカテゴリ変数を作るとき、カテゴリの順序が意図していたものとは違う順序になってしまうことがある。これは、文字列の場合はアルファベット順、日本語の場合はshift-jis順で並んでしまうことによる。 たとえば、1週間の労働時間（d_q10）に関する変数をもとに、次のように労働時間の長さ別に分けたカテゴリ変数を作成したいと思ったとする。 d_q10 workhour_fct 35時間未満 短時間 35時間以上49時間以下 標準 50時間以上59時間以下 長時間 60時間以上 過労死ライン case_when() を使って作成すると、意図していた順序とは違ったバラバラの順番になってしまう。 piaac &lt;- piaac %&gt;% mutate(workhour_fct = case_when( d_q10 &lt; 35 ~ &quot;短時間（35時間未満）&quot;, d_q10 &gt;= 35 &amp; d_q10 &lt;= 49 ~ &quot;標準（35-49時間）&quot;, d_q10 &gt;= 50 &amp; d_q10 &lt;= 59 ~ &quot;長時間（50-59時間）&quot;, d_q10 &gt;= 60 ~ &quot;過労死ライン（60時間以上）&quot; )) piaac %&gt;% with(table(workhour_fct)) ## workhour_fct ## 過労死ライン（60時間以上） 短時間（35時間未満） ## 396 960 ## 長時間（50-59時間） 標準（35-49時間） ## 648 1848 このような場合には、以下の2つの方法で順序を制御することができる。どちらを使っても良い。 4.4.5.1 一度数値変数に変換し、数値変数をカテゴリ変数に変換 いったん数値の変数を挟んでからfactor() を使って変数を作成することで、順番がばらばらになってしまうのを防ぐことができる。 # 方法1 piaac &lt;- piaac %&gt;% mutate(workhour_fct = case_when( d_q10 &lt; 35 ~ 1, d_q10 &gt;= 35 &amp; d_q10 &lt;= 49 ~ 2, d_q10 &gt;= 50 &amp; d_q10 &lt;= 59 ~ 3, d_q10 &gt;= 60 ~ 4 )) %&gt;% mutate(workhour_fct = factor(workhour_fct, levels = 1:4, labels = c(&quot;短時間（35時間未満）&quot;, &quot;通常（35-49時間）&quot;, &quot;長時間（50-59時間）&quot;, &quot;過労死ライン（60時間以上）&quot;))) piaac %&gt;% with(table(workhour_fct)) # 確認 ## workhour_fct ## 短時間（35時間未満） 通常（35-49時間） ## 960 1848 ## 長時間（50-59時間） 過労死ライン（60時間以上） ## 648 396 4.4.5.2 fct_relevel()を使う fct_relevel()は、文字列変数の値の順序を任意の順序に並び替えるコマンドである。これを使う場合には次のようなコマンドになる。 piaac &lt;- piaac %&gt;% mutate(workhour_fct = case_when( d_q10 &lt; 35 ~ &quot;短時間（35時間未満）&quot;, d_q10 &gt;= 35 &amp; d_q10 &lt;= 49 ~ &quot;標準（35-49時間）&quot;, d_q10 &gt;= 50 &amp; d_q10 &lt;= 59 ~ &quot;長時間（50-59時間）&quot;, d_q10 &gt;= 60 ~ &quot;過労死ライン（60時間以上）&quot; )) %&gt;% mutate(workhour_fct = fct_relevel(workhour_fct, &quot;短時間（35時間未満）&quot;, &quot;標準（35-49時間）&quot;, &quot;長時間（50-59時間）&quot;, &quot;過労死ライン（60時間以上）&quot;)) piaac %&gt;% with(table(workhour_fct)) # 確認 ## workhour_fct ## 短時間（35時間未満） 標準（35-49時間） ## 960 1848 ## 長時間（50-59時間） 過労死ライン（60時間以上） ## 648 396 4.4.6 必要な列のみ抽出：select() このコマンドは「変数の作成」の節で扱ったコマンドと比べるとやや特殊で、列を追加するのではなく、列を削除するという操作を行う。普通に分析をする限りは列を削除する必要はないが、一部の列だけを取り出してどのようになっているのかを確認したりしたいときなどに使う。 このときに使うコマンドがselect()である。 piaac_sub &lt;- piaac %&gt;% select(gender, wage) #gender, wageの列を抽出 piaac_sub &lt;- piaac %&gt;% select(-gender, -wage) #gender, wage「以外」の列を抽出 4.5 変数の作成についてのtips 4.5.1 カテゴリをまとめる たとえば、親の職業（階級）によって、対象者の学歴がどの程度異なるのかを知りたいとする。このとき、学歴を「中学」「高校」「短大高専」「大学大学院」という4つのカテゴリで定義しているとする。この場合には、たとえば「大学大学院」を1、それ以外を0とすることで、大学以上か大学未満か、という2値のカテゴリにする。 一つひとつのカテゴリに該当する人数が少ないときや、議論を単純化したいときに有効な方法といえる。 4.5.2 複数の変数を組み合わせた変数を作る PIAACでは、父親および母親の学歴を「初等教育」「中等教育」「高等教育」の3つの選択肢から選ぶ形式で尋ねている。この項目をもとに、父親と母親のうちどちらか高い方のの学歴を採用して、親学歴に関する変数を作りたいとする。ただし、どちらかが欠損の場合には、わかっているほうの学歴を採用することとする。この場合の対応表は以下のとおり： 父親学歴と母親学歴のうち高いほうをとって親学歴を作成する 母親学歴 父親学歴 1（初等教育） 2（中等教育） 3（高等教育） NA 1（初等教育） 初等教育 中等教育 高等教育 初等教育 2（中等教育） 中等教育 中等教育 高等教育 中等教育 3（高等教育） 高等教育 高等教育 高等教育 高等教育 NA 初等教育 中等教育 高等教育 NA このようにやや複雑な変換に対してもcase_when() が利用可能である。具体的には、以下のようにする。また、作成した変数にはやはりfactor()をつかってカテゴリ変数（factor型）へ変換し、ラベルを付けておこう。 piaac &lt;- piaac %&gt;% mutate(parenteduc = case_when( j_q07b &gt;= j_q06b ~ j_q07b, j_q07b &lt; j_q06b ~ j_q06b, is.na(j_q07b) == TRUE &amp; is.na(j_q06b) == FALSE ~ j_q06b, is.na(j_q06b) == TRUE &amp; is.na(j_q07b) == FALSE ~ j_q07b )) %&gt;% mutate(parenteduc = factor(parenteduc, levels = 1:3, labels = c(&quot;初等教育&quot;, &quot;中等教育&quot;, &quot;高等教育&quot;))) 4.5.3 均等な順序を仮定して連続変数とする ある程度均等な順序があると仮定できるならば、数値として扱うことを考えてみるとよい。JGSSでは、「現在の仕事にどの程度満足していますか」という質問（ST5JOB）で、仕事への満足度が尋ねられている。選択肢は「満足している」「どちらかといえば満足している」「どちらともいえない」「どちらかといえば不満である」「不満である」という5つから1つを選択する形式である（わからないや無回答もあるが（後述）、ここでは省略する）。このようなときには、以下のように数値を割り当てることで、値が高いほど満足していることを表す連続変数に見立てることができる。もちろん、選択肢間の間隔がどれも同じ1であるというのはあくまで仮定であり本当は違うかもしれないということには注意が必要だが、解釈はわかりやすくなるというメリットがある。 選択肢 調査票上の番号 数値化例 満足している 1 5 どちらかといえば満足している 2 4 どちらでもない 3 3 どちらかといえば不満である 4 2 不満である 5 1 jgss #元のデータ（架空例） ## # A tibble: 6 × 1 ## ST5JOB ## &lt;dbl&gt; ## 1 1 ## 2 5 ## 3 4 ## 4 2 ## 5 1 ## 6 3 以下のようにして値を変えた変数を作成する。 jgss &lt;- jgss %&gt;% mutate(jobsatis = 6 - ST5JOB) jgss ## # A tibble: 6 × 2 ## ST5JOB jobsatis ## &lt;dbl&gt; &lt;dbl&gt; ## 1 1 5 ## 2 5 1 ## 3 4 2 ## 4 2 4 ## 5 1 5 ## 6 3 3 なお、こうした扱いが認められるかどうかは扱う変数によって異なるので、先行研究での定義を参考にするとよい。たとえば今回のような仕事への満足度についてはおおむねこのような処理は認められているが、「中学」に1、「高校」に2、「短大高専」に3、「大学大学院」に4を振る、というような処理はあまり認められていない。しかしながら、受けた教育年数として、「中学」に9、「高校」に12、「短大高専」に14、「大学」に16、「大学院」に18（など）といった値を振ることはある程度認められている。このあたりは先行研究の操作化を参考にしつつ、最終的には自分たちの関心によって決めるとよいだろう。 4.5.4 無回答、非該当、「わからない」などをNAに JGSSでは「夫は外で働き、妻は家庭を守るべきだ」という意見に対して賛成か反対かを4つの選択肢を設けて尋ねている。ただし、この質問に（何らかの理由で）回答していない者もおり、そのような場合には9という値が便宜的に振られている。 この質問に対する回答を連続値とみなして集計したりしたいとする。このような場合、無回答の9という値は計算から除外したいので、9という値ではなくNAとしたい。 jgss #元のデータ（架空例） ## # A tibble: 6 × 1 ## Q4WWHHX ## &lt;dbl&gt; ## 1 1 ## 2 9 ## 3 4 ## 4 3 ## 5 2 ## 6 1 以下のようにして9をNAに置き換えた変数を作成する。 jgss &lt;- jgss %&gt;% mutate(genderrole = if_else(Q4WWHHX == 9, NA_real_, Q4WWHHX)) # 9をNAに置換 jgss #変換後のデータ ## # A tibble: 6 × 2 ## Q4WWHHX genderrole ## &lt;dbl&gt; &lt;dbl&gt; ## 1 1 1 ## 2 9 NA ## 3 4 4 ## 4 3 3 ## 5 2 2 ## 6 1 1 調査によってはこのように無回答やあるいは「わからない」という選択肢に対して便宜的に99という数字が振られていたり、非該当（たとえば結婚している人に対してのみ尋ねる質問の場合、結婚していない人はその質問に回答しない。このような場合には、回答対象ではないという意味で、非該当とされる）のケースに対して便宜的に88といったような数字が振られていることがある。このような場合にも同じようにNAに変換する。 この作業を忘れて平均値などを計算するととんでもない間違いを犯してしまうことになるため、忘れないようにしっかりチェックしておきたい9。 用いる変数については平均値だけではなく、分布や実際の値、調査票の文言などをきちんとチェックしておき、くれぐれもこのようなミスが起こらないようにしたい。 4.5.5 カテゴリ変数の区間の中点をとって連続変数とする なんらかの区間をとって尋ねられている場合、その区間の中点をとって、連続変数とみなす。たとえば、日本家族社会学会が行っている2008年全国家族調査（NFRJ08）では、「あなたご自身…は、次にあげる…家事を現在どのくらいの頻度で行っていますか」という質問項目で、たとえば「食事の用意」について、以下のような選択肢で家事頻度を尋ねている。 選択肢 調査票上の番号 数値化例 ほぼ毎日（週6〜7回） 1 6.5 1週間に4〜5回 2 4.5 1週間に2〜3回 3 2.5 1週間に1回くらい 4 1 ほとんど行わない 5 0 このような場合、週6〜7回という区間の中点をとって6.5、週4〜5回という区間の中点をとって4.5、、etcとすることで、1週間当たりの家事頻度を表す連続変数と見立てることができる。 こうした扱いがどの程度許容されるかについては、先行研究での定義を参照するとよい。 年収などもこうした区間で扱われることがあるが、この場合は中点を定義できない選択肢が設けられていることがある（例：2050万円以上）。こうした場合の扱いについては諸説あり、こちらにも少しそのことを記載している。 4.6 %&gt;%をつなげてコマンドをまとめる 変数を作成する過程では、正しく変数を作れているかどうかを一つひとつ確認しながら進めていくことが必須である。しかし、正しく作成できたことが確認できたら、with(table())などを使って確認するコードは必ずしもスクリプトに残しておく必要はない。分析に使う変数が固まってきたら、変数を作成するためのコードを（ある程度）まとめておくと、コードがシンプルになってよいだろう。このようなときに、パイプ記法は有用である。 上記で作成した変数も含めて、本資料で使う変数をまとめて作成するためのコードを以下に記した。 piaac &lt;- piaac %&gt;% mutate(id = 1:n()) %&gt;% mutate(wage = earnhrbonus) %&gt;% mutate(logwage = log(wage)) %&gt;% mutate(gender = factor(gender_r, level = 2:1, label = c(&quot;女性&quot;,&quot;男性&quot;))) %&gt;% mutate(age = age_r) %&gt;% mutate(work = 2 - c_q01a) %&gt;% mutate(workhour = d_q10 / 5) %&gt;% mutate(workhour_fct = case_when( d_q10 &lt; 35 ~ 1, d_q10 &gt;= 35 &amp; d_q10 &lt;= 49 ~ 2, d_q10 &gt;= 50 &amp; d_q10 &lt;= 59 ~ 3, d_q10 &gt;= 60 ~ 4 )) %&gt;% mutate(workhour_fct = factor(workhour_fct, levels = 1:4, labels = c(&quot;短時間（35時間未満）&quot;, &quot;標準（35-49時間）&quot;, &quot;長時間（50-59時間）&quot;, &quot;過労死ライン（60時間以上）&quot;))) %&gt;% mutate(educ = case_when( edcat8 == 1 | edcat8 == 2 ~ 1, edcat8 == 3 ~ 2, edcat8 == 4 | edcat8 == 5 ~ 3, edcat8 == 6 | edcat8 == 7 | edcat8 == 8 ~ 4)) %&gt;% mutate(educ = factor(educ, levels = 1:4, labels = c(&quot;中学&quot;, &quot;高校&quot;, &quot;短大高専&quot;, &quot;大学大学院&quot;))) %&gt;% mutate(mothereduc = factor(j_q06b, levels = 1:3, labels = c(&quot;初等教育&quot;, &quot;中等教育&quot;, &quot;高等教育&quot;))) %&gt;% mutate(fathereduc = factor(j_q07b, levels = 1:3, labels = c(&quot;初等教育&quot;, &quot;中等教育&quot;, &quot;高等教育&quot;))) %&gt;% mutate(parenteduc = case_when( j_q07b &gt;= j_q06b ~ j_q07b, j_q07b &lt; j_q06b ~ j_q06b, is.na(j_q07b) == TRUE &amp; is.na(j_q06b) == FALSE ~ j_q06b, is.na(j_q06b) == TRUE &amp; is.na(j_q07b) == FALSE ~ j_q07b )) %&gt;% mutate(parenteduc = factor(parenteduc, levels = 1:3, labels = c(&quot;初等教育&quot;, &quot;中等教育&quot;, &quot;高等教育&quot;))) %&gt;% mutate(occupation = factor(isco1c, levels = 1:9, labels = c(&quot;管理職&quot;,&quot;専門職&quot;,&quot;技術職・准専門職&quot;,&quot;事務補助&quot;,&quot;サービス・販売&quot;,&quot;農林漁業&quot;,&quot;技能工&quot;,&quot;設備・機械運転・組立&quot;,&quot;単純作業&quot;) )) %&gt;% mutate(numeracy = pvnum1) %&gt;% mutate(ojt = 2 - b_q12c) %&gt;% mutate(health = 6 - i_q08) %&gt;% mutate(learning = i_q04d) %&gt;% mutate(readwork = readwork) %&gt;% mutate(numwork = numwork) このようにして作成した変数のみを残したデータを別途データフレームとして残しておこう。 piaac_variable &lt;- piaac %&gt;% select(id, wage, logwage, gender, age, work, workhour, workhour_fct, educ, mothereduc, fathereduc, parenteduc, occupation, numeracy, ojt, health, learning, readwork, numwork) 4.7 サンプルの限定 社会調査データを分析する場合、調査対象者をすべて分析対象に含めるわけではなく、年齢を限定したり、働いている人だけに限定したりといったふうに、分析対象を一部に限定することが多い。このときに使うコードや注意点について記す。 4.7.1 該当するケースだけを残す：filter() 関心によっては、若年の人だけ分析したいとか、高齢の人だけ分析したいとか、女性（男性）だけ分析したいというときがある。それ以外にも、使う変数にNAが含まれているケースをあらかじめ除外するということはふつうにある。このようなときには、filter()を使う。 性別（gender）が男性のケースのみを抽出し、抽出したデータに新しい名前（piaac_male）をつける場合には次のようにする。 piaac_male &lt;- piaac_variable %&gt;% filter(gender == &quot;男性&quot;) 年齢が25歳以上34歳以下のケースのみを抽出し、抽出したデータに新しい名前（piaac_young）をつける。 piaac_young &lt;- piaac_variable %&gt;% filter(age &gt;= 25 &amp; age &lt;= 34) 今回の資料では、「25歳以上64歳以下の有業者」に対象を限定する。そのため、次のように条件を指定する。 piaac_sample &lt;- piaac_variable %&gt;% filter(25 &lt;= age &amp; age &lt;= 64) %&gt;% filter(work == 1) 4.7.2 欠損値の扱い さて、上記のように分析対象を限定した。このデータに含まれる人数を確認してみる。nrow()を使うと、データフレーム（あるいはベクトル）の長さを調べることができる。 piaac_sample %&gt;% nrow() ## [1] 3330 このように、3330行からなるデータであることがわかる。しかしながら、回答者がすべての質問について回答しているわけではなく、回答を拒否したり、当該質問項目の対象者に当てはまらない（非該当）ために、値が入っていない（NAとなっている）場合がある。今回の資料で用いる変数について、NAとなっている回答がどの程度あるかをみてみよう。 piaac_sample %&gt;% summary() ## id wage logwage gender ## Min. : 1 Min. : 0.06 Min. :-2.851 女性:1508 ## 1st Qu.:1310 1st Qu.: 937.50 1st Qu.: 6.843 男性:1822 ## Median :2654 Median : 1445.09 Median : 7.276 ## Mean :2650 Mean : 2027.32 Mean : 7.311 ## 3rd Qu.:4008 3rd Qu.: 2224.38 3rd Qu.: 7.707 ## Max. :5278 Max. :266666.67 Max. :12.494 ## NA&#39;s :464 NA&#39;s :464 ## age work workhour workhour_fct ## Min. :25.00 Min. :1 Min. : 0.200 短時間（35時間未満） : 721 ## 1st Qu.:36.00 1st Qu.:1 1st Qu.: 7.000 標準（35-49時間） :1643 ## Median :44.00 Median :1 Median : 8.000 長時間（50-59時間） : 590 ## Mean :44.66 Mean :1 Mean : 8.272 過労死ライン（60時間以上）: 368 ## 3rd Qu.:54.00 3rd Qu.:1 3rd Qu.:10.000 NA&#39;s : 8 ## Max. :64.00 Max. :1 Max. :22.400 ## NA&#39;s :8 ## educ mothereduc fathereduc parenteduc ## 中学 : 305 初等教育:1112 初等教育:1110 初等教育: 853 ## 高校 :1187 中等教育:1504 中等教育:1305 中等教育:1411 ## 短大高専 : 793 高等教育: 583 高等教育: 760 高等教育: 977 ## 大学大学院:1044 NA&#39;s : 131 NA&#39;s : 155 NA&#39;s : 89 ## NA&#39;s : 1 ## ## ## occupation numeracy ojt health ## サービス・販売 :712 Min. :103.4 Min. :0.0000 Min. :1.000 ## 技術職・准専門職:532 1st Qu.:266.6 1st Qu.:0.0000 1st Qu.:2.000 ## 専門職 :512 Median :296.3 Median :0.0000 Median :3.000 ## 事務補助 :491 Mean :293.6 Mean :0.3459 Mean :3.038 ## 技能工 :349 3rd Qu.:323.2 3rd Qu.:1.0000 3rd Qu.:4.000 ## (Other) :713 Max. :440.9 Max. :1.0000 Max. :5.000 ## NA&#39;s : 21 ## learning readwork numwork ## Min. :1.000 Min. :-0.9555 Min. :-0.0902 ## 1st Qu.:3.000 1st Qu.: 1.6390 1st Qu.: 1.2468 ## Median :3.000 Median : 2.1992 Median : 1.7690 ## Mean :3.323 Mean : 2.2236 Mean : 1.9018 ## 3rd Qu.:4.000 3rd Qu.: 2.7557 3rd Qu.: 2.3693 ## Max. :5.000 Max. : 7.0208 Max. : 6.0499 ## NA&#39;s :1 NA&#39;s :174 NA&#39;s :420 NA'sと書かれているのが、各変数でNAとなっている行の数である。項目によってはNAがない変数もあるし、たくさんNAがある変数もある。 NAが含まれている変数は分析の際に集計が面倒だったりして、色々と取り扱いが難しい。そこで、分析に使う変数にNAが含まれている行はサンプルから除外しておくと集計が楽になる。filter()を使って、educ, parenteduc, occupation, wageの4つの変数についてNAが含まれている行を除外したデータフレームを作成しよう。 piaac_sample_nona &lt;- piaac_sample %&gt;% filter(is.na(educ) == FALSE) %&gt;% filter(is.na(parenteduc) == FALSE) %&gt;% filter(is.na(occupation) == FALSE) %&gt;% filter(is.na(wage) == FALSE) is.na()は値がNAであればTRUE、NAでなければFALSEを返す関数である。filter(is.na(educ) == FALSE)とすると、educがNAではないケースだけを残してね、という命令になる。上記のコードを実行したあとの回答を再度チェックしてみよう： piaac_sample_nona %&gt;% nrow() ## [1] 2783 piaac_sample_nona %&gt;% summary() ## id wage logwage gender ## Min. : 1 Min. : 0.06 Min. :-2.851 女性:1309 ## 1st Qu.:1306 1st Qu.: 940.00 1st Qu.: 6.846 男性:1474 ## Median :2663 Median : 1445.09 Median : 7.276 ## Mean :2653 Mean : 2040.36 Mean : 7.315 ## 3rd Qu.:3987 3rd Qu.: 2240.80 3rd Qu.: 7.715 ## Max. :5278 Max. :266666.67 Max. :12.494 ## ## age work workhour workhour_fct ## Min. :25.00 Min. :1 Min. : 0.200 短時間（35時間未満） : 610 ## 1st Qu.:35.00 1st Qu.:1 1st Qu.: 7.000 標準（35-49時間） :1419 ## Median :43.00 Median :1 Median : 8.000 長時間（50-59時間） : 490 ## Mean :43.95 Mean :1 Mean : 8.189 過労死ライン（60時間以上）: 264 ## 3rd Qu.:53.00 3rd Qu.:1 3rd Qu.:10.000 ## Max. :64.00 Max. :1 Max. :21.600 ## ## educ mothereduc fathereduc parenteduc ## 中学 :230 初等教育: 931 初等教育: 931 初等教育: 711 ## 高校 :972 中等教育:1305 中等教育:1141 中等教育:1228 ## 短大高専 :690 高等教育: 511 高等教育: 653 高等教育: 844 ## 大学大学院:891 NA&#39;s : 36 NA&#39;s : 58 ## ## ## ## occupation numeracy ojt health ## サービス・販売 :587 Min. :127.3 Min. :0.0000 Min. :1.000 ## 事務補助 :450 1st Qu.:267.7 1st Qu.:0.0000 1st Qu.:2.000 ## 技術職・准専門職:445 Median :297.2 Median :0.0000 Median :3.000 ## 専門職 :425 Mean :294.7 Mean :0.3672 Mean :3.046 ## 技能工 :272 3rd Qu.:324.0 3rd Qu.:1.0000 3rd Qu.:4.000 ## 管理職 :227 Max. :440.9 Max. :1.0000 Max. :5.000 ## (Other) :377 ## learning readwork numwork ## Min. :1.000 Min. :-0.9555 Min. :-0.0902 ## 1st Qu.:3.000 1st Qu.: 1.6240 1st Qu.: 1.2244 ## Median :3.000 Median : 2.1789 Median : 1.7651 ## Mean :3.312 Mean : 2.1966 Mean : 1.9057 ## 3rd Qu.:4.000 3rd Qu.: 2.7169 3rd Qu.: 2.3798 ## Max. :5.000 Max. : 7.0208 Max. : 6.0499 ## NA&#39;s :149 NA&#39;s :365 データの行数は先ほどよりも減っており、またwage, educ, occupationに含まれていたNA’sの表記が消えていることがわかる。 このように、変数に欠損が含まれるケースを除外するような処理の仕方をさして、リストワイズ削除 listwise delitionという。今日では欠損値の処理としてあまり望ましくない処理とされているが、まずはこのやりかたでやるのがよいだろう。欠損があまりに多い場合には、何らかのデータ操作のミス、調査のうえでの何らかの問題、そのほかの理由が考えられるため、欠損の数がどれくらいあるのかは注意して見ておくとよいだろう。 4.7.3 外れ値の扱い さて、上記のように欠損値を除いたサンプルを作成したあと、最後に考慮すべきは、外れ値の問題である。連続変数を分析に用いる場合、このような外れ値が結果に大きな影響をおよぼす場合がある。その一例として、時給換算した賃金について考えてみよう。この変数の分布をみると、常識的には理解しがたい高い値、あるいは低い値をとっているケースが存在することがわかる（ヒストグラムについては第5章で解説する）。たとえば以下のように、時間あたり賃金が極端に低かったり（300円未満など）、逆に極端に高かったり（20000円以上など）するケースが存在している。 piaac_sample_nona %&gt;% ggplot(aes(x = wage)) + geom_histogram(bins = 100) + xlim(0, 800) piaac_sample_nona %&gt;% ggplot(aes(x = wage)) + geom_histogram(bins = 100) + xlim(5000, 100000) このようなケースが発生する理由はいくつかあるのだが、分析上は、たとえば平均値を計算したりする場合に、これらの外れ値があることによって結果がこうした極端に高い・低い人によって大きく左右されるという問題がある。そこで、こうした極端に高いあるいは低いケースを除外することはしばしば有効になる。時給換算した賃金の場合にはたとえば、上位1%、下位1%のサンプルを除外するという処理を行うことが多い。このように上位1%、下位1%のサンプルを除外するときの方法について記す。 まず、ntile()関数を使って、賃金の分位数を表す変数を作成する。 piaac_sample_nona &lt;- piaac_sample_nona %&gt;% mutate(wage_tile = ntile(wage, 100)) 下位1%と上位1%のケースにはどこからどこまでの値が含まれているのかチェックしてみよう： piaac_sample_nona %&gt;% filter(wage_tile == 1 | wage_tile == 100) %&gt;% group_by(wage_tile) %&gt;% summarize(min = min(wage), max = max(wage)) ## # A tibble: 2 × 3 ## wage_tile min max ## &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 1 0.0578 462. ## 2 100 9760. 266667. このように、下位1%には462円以下のケースが含まれ、上位1%には9760円以上のケースが含まれていることがわかる。これらのケースを除外して、分析に使用するためのサンプルを作ろう。 piaac_sample_analytic &lt;- piaac_sample_nona %&gt;% filter(2 &lt;= wage_tile &amp; wage_tile &lt;= 99) このように極端に低いケースと極端に高いケースを除外することで、外れ値の影響を除いた賃金の分布を得ることができる。 piaac_sample_analytic %&gt;% ggplot(aes(x = wage)) + geom_histogram(bins = 100) このように、分析に連続変数を用いる場合には、外れ値がないかどうか、外れ値を含むことで結果が大きく変わってしまわないかをチェックしておく必要がある。 4.7.4 分析用データを書き出す 上記のような手順を経て、ようやく分析することのできるデータを準備することができた。準備できたデータを、新しいデータとして保存しておこう。readr::write_excel_csv()を使うと、データフレームをrds形式で書き出すことができる。 write_rds(piaac_sample_analytic, file = &quot;data/piaac_sample_analytic.rds&quot;) このように、元々のデータから種々のデータ加工を行い、分析のために使用することにしたデータは、元々のデータとは別に保存しておくことで、データの加工のプロセスとデータの分析のプロセスを明示的に分けることにつながり、エラーを減らすことができる。 以降では、このデータを使って分析を行っていく。 4.8 データの追加（発展） たとえば複数の社会調査データを合併してサンプルサイズを増やしたり、時系列比較を行いたいといったことがあるかもしれない。このような場合の処理について記しておく。 以下のような2つのデータがあるとする。 df1 ## # A tibble: 6 × 4 ## id x1 x2 data ## &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; ## 1 1 5 1 data 1 ## 2 2 8 1 data 1 ## 3 3 2 1 data 1 ## 4 4 0 2 data 1 ## 5 5 6 2 data 1 ## 6 6 1 2 data 1 df2 ## # A tibble: 4 × 4 ## id x1 x2 data ## &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; ## 1 7 9 2 data 2 ## 2 8 4 1 data 2 ## 3 9 0 2 data 2 ## 4 10 2 1 data 2 この2つのデータを合併したいときには、dplyr::bind_rows()を使う。 df &lt;- df1 %&gt;% bind_rows(df2) これで、以下のように2つのデータを合併して行が増えたデータが得られる。 df ## # A tibble: 10 × 4 ## id x1 x2 data ## &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; ## 1 1 5 1 data 1 ## 2 2 8 1 data 1 ## 3 3 2 1 data 1 ## 4 4 0 2 data 1 ## 5 5 6 2 data 1 ## 6 6 1 2 data 1 ## 7 7 9 2 data 2 ## 8 8 4 1 data 2 ## 9 9 0 2 data 2 ## 10 10 2 1 data 2 "],["descriptives.html", "Chapter 5 1変数の集計 5.1 連続変数を集計する 5.2 分布をみる 5.3 カテゴリ変数の集計 5.4 記述統計量の一覧表を作る 5.5 結果をファイルに書き出す", " Chapter 5 1変数の集計 本章では、1変数の集計方法を説明する。 内容に入る前に、右上のプロジェクトのボックスの横が、前章で作成したプロジェクトの名前（たとえば、seminar_sociology_r）になっているかどうかを確認しておこう。なっていない場合は、右上のボックスをクリックして、「Open Project…」を選択し、前章で作成したRprojファイル（たとえば、seminar_sociology_r.Rprojといったような名前になっている）を選んで、プロジェクトを切り替えよう。 さらに、以下のパッケージを読み込んだ上で、第4章で作成したデータを読み込んでpiaacというデータフレームに入れていることを前提とする。具体的には、以下のコードを実行しておく必要がある。 library(tidyverse) piaac &lt;- read_rds(&quot;data/piaac_sample_analytic.rds&quot;) 5.1 連続変数を集計する 5.1.1 要約統計量の計算 さまざまな変数を集計するときに最も基本的なコードが、summarize()である。たとえば、piaacというデータフレームに含まれている変数wageの平均値を求めたいとする。このようなときには、次のように記述する。 piaac %&gt;% summarize(mean = mean(wage)) ## # A tibble: 1 × 1 ## mean ## &lt;dbl&gt; ## 1 1792. この命令は、「piaacというデータフレームのなかに入っている変数を集計してね、具体的には、平均値を求めてね、ちなみにその平均値にはmeanという名前をつけてね」ということを意味している。 集計する変数（この場合はwage）にNAが含まれていると計算ができず、結果もNAとなってしまう。NAが含まれる変数の平均値を計算するときには、あらかじめwageがNAの行を除外しておくとよい。詳しくは前章のサンプルの選択を参照のこと。一時的にNAの行を除外して集計してみたい場合には、次のように書く。 piaac %&gt;% filter(is.na(wage) == FALSE) %&gt;% summarize(mean = mean(wage)) ## # A tibble: 1 × 1 ## mean ## &lt;dbl&gt; ## 1 1792. 平均値だけでなく、いろいろな統計量を計算できる。よく用いるものは以下のとおり。 関数 意味 mean(x) 平均値 sd(x) 標準偏差 max(x) 最大値 min(x) 最小値 quantile(x, 0.5) 分位数。0.5とした場合には50パーセンタイル点（中央値）を計算する。0（最小）から1（最大）まで任意の点を指定できる。 n() 行数を数える。 全部集計してみるとたとえば以下のような感じになる。 piaac %&gt;% summarize(mean = mean(wage), sd = sd(wage), max = max(wage), min = min(wage), p25 = quantile(wage, 0.25), p50 = quantile(wage, 0.5), p75 = quantile(wage, 0.75), n = n()) ## # A tibble: 1 × 8 ## mean sd max min p25 p50 p75 n ## &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; ## 1 1792. 1191. 9634. 462. 950 1445. 2212. 2728 いくつかの変数について最小値、第1四分位点、中央値、平均値、第3四分位点、最大値をまとめて表示したい場合、これらを一つひとつやっていくのはとても煩雑である。このような場合には、統計量を計算したい変数だけをselect()で抽出し、そのうえで、summary()関数を使うとできる。たとえば、wage, age, healthの3つの変数についての統計量をまとめて見てみたい場合に次のようにする。 piaac %&gt;% select(wage, age, health) %&gt;% summary() ## wage age health ## Min. : 461.5 Min. :25.00 Min. :1.000 ## 1st Qu.: 950.0 1st Qu.:35.00 1st Qu.:2.000 ## Median :1445.1 Median :43.00 Median :3.000 ## Mean :1792.4 Mean :43.85 Mean :3.046 ## 3rd Qu.:2212.2 3rd Qu.:53.00 3rd Qu.:4.000 ## Max. :9633.9 Max. :64.00 Max. :5.000 5.2 分布をみる 5.2.1 ヒストグラムとggplotの導入 連続変数の場合にはたんに平均値や中央値だけを見るだけでなく、分布を見ることも重要だ。連続変数の分布をみるときには、ヒストグラムを使うのが有効である。コードの説明はさておき、まずはヒストグラムをみてみよう。 piaac %&gt;% ggplot(aes(x = wage)) + geom_histogram() ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. このように、Rでグラフを作成したいときに活躍するのがggplot2である。ggplot2はtidyverseパッケージを読み込むと合わせて読み込まれるため、別途library(ggplot2)で読み込む必要はない。 ggplot2の基本的な発想は、キャンバスに絵の具を重ね塗りしていくかのように、一つひとつ層を重ねていってグラフを作るというものである。具体的にみてみよう。先ほどのコードから3行目を削除した次の結果を確認してみよう。 piaac %&gt;% ggplot(aes(x = wage)) ggplot()という部分が、グラフを書くための準備をしている箇所である。aes()のなかでは、x軸やy軸にそれぞれ何の変数を取るのかであったり、どのような色で分けるのか（後述）などを指定する。今の場合であれば、x軸にwageをとる、ということを指している。上記の命令だけだと、このようにx軸のみが表示された空白の座標が準備される。 geom_histogram()というのが、ヒストグラムを書くためのコードである。先ほどのコードに、+でつないでgeom_histogram()というコードを追加すると、空白の座標にヒストグラムが描かれる。縦軸（count）は、その区間に何人の人が属しているかを示している。 piaac %&gt;% ggplot(aes(x = wage)) + geom_histogram() ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. geom_histogram()内でオプションを指定することで、ヒストグラムの見た目をさまざまに変更できる。たとえば、区間の区切りの個数（bins）を細かくしてみよう（デフォルトはbins = 30）。 piaac %&gt;% ggplot(aes(x = wage)) + geom_histogram(bins = 100) 以下、+でつないでいくことで、さらに層を重ねて、グラフの見た目をさまざまに変更できる。たとえば、x軸の範囲を指定するxlim()を使って、より見やすいグラフを作ってみよう。 piaac %&gt;% ggplot(aes(x = wage)) + geom_histogram(bins = 100) + xlim(0, 10000) 5.2.2 ggplotの設定（日本語関係） ところで、Macでggplot2パッケージを使用し、グラフ中に日本語を使用する場合には、library(tidyverse)（またはlibrary(ggplot2)）を実行したうえで、たとえば以下のようなコードをあらかじめ実行しておく必要がある。 theme_set(theme_grey(base_family = &quot;HiraginoSans-W3&quot;)) theme_set()関数はフォントのほかにいくつかの追加的な設定を行うことができる。 この資料で使用しているグラフについては以下のようにthemeを設定しています。 theme_set(theme_bw( base_family = &quot;HiraginoSans-W3&quot;, base_size = 11, #文字の大きさを設定。デフォルトは11 base_line_size = 0.2, #罫線の線の太さを設定。デフォルトはbase_size/22 base_rect_size = 0.2 #外枠の線の太さを設定。デフォルトはbase_size/22 )) Windowsユーザの方は上記コードからbase_family =の行を除いたこちらのコードで同じような雰囲気になります： theme_set(theme_bw( base_size = 11, base_line_size = 0.2, base_rect_size = 0.2 )) 5.2.3 軸に名前をつける 上記の設定を終えて日本語問題をクリアしていれば（Windowsユーザならはじめからクリアしているのだけれども）、軸に名前をつけるコマンドlabs()をさらに追加して、日本語の名前を付けてよりわかりやすいグラフを作ることができる。 piaac %&gt;% ggplot(aes(x = wage)) + geom_histogram(bins = 100) + xlim(0, 10000) + labs(x = &quot;賃金&quot;, y = &quot;度数&quot;) 5.3 カテゴリ変数の集計 5.3.1 度数の確認 カテゴリ変数の場合は平均値や標準偏差のような要約統計量を計算することはできない（意味がない）。最も基本的な集計は、各カテゴリにそれぞれ何人いるのかを確認することだ。with(table())を使うことで各カテゴリの人数（行数）をみることができる。 piaac %&gt;% with(table(occupation)) ## occupation ## 管理職 専門職 技術職・准専門職 ## 219 419 439 ## 事務補助 サービス・販売 農林漁業 ## 439 576 25 ## 技能工 設備・機械運転・組立 単純作業 ## 265 207 139 人数だけでなく、各職業にどれくらいの割合の人が含まれているのかも重要だ。先ほどのコマンドにprop.table()を加えることで、各カテゴリに含まれる人が全体に占める割合を計算できる。 piaac %&gt;% with(table(occupation)) %&gt;% prop.table() ## occupation ## 管理職 専門職 技術職・准専門職 ## 0.080278592 0.153592375 0.160923754 ## 事務補助 サービス・販売 農林漁業 ## 0.160923754 0.211143695 0.009164223 ## 技能工 設備・機械運転・組立 単純作業 ## 0.097140762 0.075879765 0.050953079 小数点以下が多すぎて見にくいので、小数点第3位で丸めよう。先ほどのコマンドにround(digits = 3)を加えると、小数点第3位で丸めることができる。digitsのところの値が、小数点第○位の○の値に対応する。 piaac %&gt;% with(table(occupation)) %&gt;% prop.table() %&gt;% round(3) ## occupation ## 管理職 専門職 技術職・准専門職 ## 0.080 0.154 0.161 ## 事務補助 サービス・販売 農林漁業 ## 0.161 0.211 0.009 ## 技能工 設備・機械運転・組立 単純作業 ## 0.097 0.076 0.051 この値はすべて足すと1になる。なので、この値を100倍すると百分率（%）としてよむことができる。 5.3.2 分布の可視化：棒グラフ こうして集計した値を棒グラフにして表すと見やすいかもしれない。そのためにまず、先の集計表をデータフレーム形式に変換してみよう。 piaac %&gt;% with(table(occupation)) %&gt;% prop.table() %&gt;% as.data.frame() ## occupation Freq ## 1 管理職 0.080278592 ## 2 専門職 0.153592375 ## 3 技術職・准専門職 0.160923754 ## 4 事務補助 0.160923754 ## 5 サービス・販売 0.211143695 ## 6 農林漁業 0.009164223 ## 7 技能工 0.097140762 ## 8 設備・機械運転・組立 0.075879765 ## 9 単純作業 0.050953079 このように、1行が1つの職業を表し、Freqという列には先ほど計算した割合が入っているようなデータフレームに変換することができる。これをggplot()に渡してやることで、棒グラフをつくることができる。棒グラフを作るときのコマンドが、geom_col()である。 piaac %&gt;% with(table(occupation)) %&gt;% prop.table() %&gt;% as.data.frame() %&gt;% ggplot(aes(x = occupation, y = Freq)) + geom_col() 悪くないけれど、横軸のラベルがかぶってしまって、何を指しているのかいまいちわからなくなってしまっている。また、縦軸や横軸の名前は必ずしもわかりやすいものではないだろう。そこで、以下のようにコマンドを追加しよう。 piaac %&gt;% with(table(occupation)) %&gt;% prop.table() %&gt;% as.data.frame() %&gt;% ggplot(aes(x = occupation, y = Freq)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + # X軸を90度傾ける labs(x = &quot;職業&quot;, y = &quot;割合&quot;) # x軸とy軸に名前をつける 5.4 記述統計量の一覧表を作る 論文などで分析に使用する変数の記述統計量の一覧表を示していることがよくある。このような表を作ることで、読む側にとっては変数の分布を確認でき、その後の結果も読みやすくなる。こうした一覧表を作るために非常に便利なパッケージがgtsummaryだ。まずはこれを読み込もう。 library(gtsummary) 次の5つの変数の記述統計量の一覧表を作りたいとしよう。select()を使って、こららの変数だけを残したデータフレームを作成する。 列名 型 変数ラベル gender カテゴリ（factor） 性別 age 連続（numeric） 年齢 educ カテゴリ（factor） 最終学歴 occupation カテゴリ（factor） 職業 wage 連続（numeric） 賃金 piaac_selected &lt;- piaac %&gt;% select(gender, age, educ, occupation, wage) この中には連続変数もカテゴリ変数もあり、またカテゴリの個数が2つのものもあればもっと多いものもあって複雑である。gtsummary::tbl_summary()は、変数の型がきちんとしていれば、それを読み取ってきれいな記述統計量の表を作ってくれる。 piaac_selected %&gt;% tbl_summary() html { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif; } #vogrbwifji .gt_table { display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; } #vogrbwifji .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #vogrbwifji .gt_title { color: #333333; font-size: 125%; font-weight: initial; padding-top: 4px; padding-bottom: 4px; border-bottom-color: #FFFFFF; border-bottom-width: 0; } #vogrbwifji .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 0; padding-bottom: 6px; border-top-color: #FFFFFF; border-top-width: 0; } #vogrbwifji .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #vogrbwifji .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #vogrbwifji .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; } #vogrbwifji .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; } #vogrbwifji .gt_column_spanner_outer:first-child { padding-left: 0; } #vogrbwifji .gt_column_spanner_outer:last-child { padding-right: 0; } #vogrbwifji .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 5px; overflow-x: hidden; display: inline-block; width: 100%; } #vogrbwifji .gt_group_heading { padding: 8px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; } #vogrbwifji .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: middle; } #vogrbwifji .gt_from_md > :first-child { margin-top: 0; } #vogrbwifji .gt_from_md > :last-child { margin-bottom: 0; } #vogrbwifji .gt_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; } #vogrbwifji .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 12px; } #vogrbwifji .gt_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #vogrbwifji .gt_first_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; } #vogrbwifji .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #vogrbwifji .gt_first_grand_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; } #vogrbwifji .gt_striped { background-color: rgba(128, 128, 128, 0.05); } #vogrbwifji .gt_table_body { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #vogrbwifji .gt_footnotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #vogrbwifji .gt_footnote { margin: 0px; font-size: 90%; padding: 4px; } #vogrbwifji .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #vogrbwifji .gt_sourcenote { font-size: 90%; padding: 4px; } #vogrbwifji .gt_left { text-align: left; } #vogrbwifji .gt_center { text-align: center; } #vogrbwifji .gt_right { text-align: right; font-variant-numeric: tabular-nums; } #vogrbwifji .gt_font_normal { font-weight: normal; } #vogrbwifji .gt_font_bold { font-weight: bold; } #vogrbwifji .gt_font_italic { font-style: italic; } #vogrbwifji .gt_super { font-size: 65%; } #vogrbwifji .gt_footnote_marks { font-style: italic; font-weight: normal; font-size: 65%; } Characteristic N = 2,7281 gender 女性 1,284 (47%) 男性 1,444 (53%) age 43 (35, 53) educ 中学 226 (8.3%) 高校 948 (35%) 短大高専 681 (25%) 大学大学院 873 (32%) occupation 管理職 219 (8.0%) 専門職 419 (15%) 技術職・准専門職 439 (16%) 事務補助 439 (16%) サービス・販売 576 (21%) 農林漁業 25 (0.9%) 技能工 265 (9.7%) 設備・機械運転・組立 207 (7.6%) 単純作業 139 (5.1%) wage 1,445 (950, 2,212) 1 n (%); Median (IQR) これでもすでにかなりきれいな表になっているが、以下の4点で修正をしてみよう。 educやoccupationといった変数がそれぞれ何を示しているのか、自分以外の見る人にとってもわかるように日本語の名前をつけたい：label = list(x ~ \"名前\") 連続変数については中央値（50パーセンタイル点）、第1四分位数（25パーセンタイル点）、第3四分位数（75パーセンタイル点）が示されているが、それよりは、平均値と標準偏差を載せたい：statistic = list(all_continuous() ~ \"{mean} ({sd})\") 同じく、連続変数については、小数点以下の桁数（小数点第1位に）揃えたい：digits = all_continuous() ~ 1 左上のCharacteristicsというのがなんだか気になるので削除したい：tbl_crossのコマンドの後ろに%&gt;%でつないでmodify_header(label ~ \"\") piaac_selected %&gt;% tbl_summary(label = list(gender ~ &quot;性別&quot;, age ~ &quot;年齢&quot;, educ ~ &quot;最終学歴&quot;, occupation ~ &quot;職業&quot;, wage ~ &quot;賃金&quot;), #~の前には列名、後ろにはつけたい名前を&quot;&quot;で囲んで入れ、,で一つずつ区切る statistic = list(all_continuous() ~ &quot;{mean} ({sd})&quot;), digits = all_continuous() ~ 1) %&gt;% #数値の部分が小数点第y位の部分の値 modify_header(label ~ &quot;&quot;) # &quot;&quot;の部分には好きな文字列を入れられる。何も入れなければ空欄になる html { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif; } #sjuwnynaoh .gt_table { display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; } #sjuwnynaoh .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #sjuwnynaoh .gt_title { color: #333333; font-size: 125%; font-weight: initial; padding-top: 4px; padding-bottom: 4px; border-bottom-color: #FFFFFF; border-bottom-width: 0; } #sjuwnynaoh .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 0; padding-bottom: 6px; border-top-color: #FFFFFF; border-top-width: 0; } #sjuwnynaoh .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #sjuwnynaoh .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #sjuwnynaoh .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; } #sjuwnynaoh .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; } #sjuwnynaoh .gt_column_spanner_outer:first-child { padding-left: 0; } #sjuwnynaoh .gt_column_spanner_outer:last-child { padding-right: 0; } #sjuwnynaoh .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 5px; overflow-x: hidden; display: inline-block; width: 100%; } #sjuwnynaoh .gt_group_heading { padding: 8px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; } #sjuwnynaoh .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: middle; } #sjuwnynaoh .gt_from_md > :first-child { margin-top: 0; } #sjuwnynaoh .gt_from_md > :last-child { margin-bottom: 0; } #sjuwnynaoh .gt_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; } #sjuwnynaoh .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 12px; } #sjuwnynaoh .gt_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #sjuwnynaoh .gt_first_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; } #sjuwnynaoh .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #sjuwnynaoh .gt_first_grand_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; } #sjuwnynaoh .gt_striped { background-color: rgba(128, 128, 128, 0.05); } #sjuwnynaoh .gt_table_body { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #sjuwnynaoh .gt_footnotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #sjuwnynaoh .gt_footnote { margin: 0px; font-size: 90%; padding: 4px; } #sjuwnynaoh .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #sjuwnynaoh .gt_sourcenote { font-size: 90%; padding: 4px; } #sjuwnynaoh .gt_left { text-align: left; } #sjuwnynaoh .gt_center { text-align: center; } #sjuwnynaoh .gt_right { text-align: right; font-variant-numeric: tabular-nums; } #sjuwnynaoh .gt_font_normal { font-weight: normal; } #sjuwnynaoh .gt_font_bold { font-weight: bold; } #sjuwnynaoh .gt_font_italic { font-style: italic; } #sjuwnynaoh .gt_super { font-size: 65%; } #sjuwnynaoh .gt_footnote_marks { font-style: italic; font-weight: normal; font-size: 65%; } N = 2,7281 性別 女性 1,284 (47%) 男性 1,444 (53%) 年齢 43.8 (10.8) 最終学歴 中学 226 (8.3%) 高校 948 (35%) 短大高専 681 (25%) 大学大学院 873 (32%) 職業 管理職 219 (8.0%) 専門職 419 (15%) 技術職・准専門職 439 (16%) 事務補助 439 (16%) サービス・販売 576 (21%) 農林漁業 25 (0.9%) 技能工 265 (9.7%) 設備・機械運転・組立 207 (7.6%) 単純作業 139 (5.1%) 賃金 1,792.4 (1,191.0) 1 n (%); Mean (SD) 5.4.1 グループ別の記述統計量の一覧表 何らかの属性などでサンプルを分けて比較分析する場合には、属性ごとの記述統計量を示すとよい。これも、tbl_summary()のなかでオプションを指定することで簡単に実行することができる。 piaac_selected %&gt;% tbl_summary(statistic = list(all_continuous() ~ &quot;{mean} ({sd})&quot;), by = gender, digits = all_continuous() ~ 1) %&gt;% modify_header(label ~ &quot;&quot;) html { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif; } #wfadrdakvh .gt_table { display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; } #wfadrdakvh .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #wfadrdakvh .gt_title { color: #333333; font-size: 125%; font-weight: initial; padding-top: 4px; padding-bottom: 4px; border-bottom-color: #FFFFFF; border-bottom-width: 0; } #wfadrdakvh .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 0; padding-bottom: 6px; border-top-color: #FFFFFF; border-top-width: 0; } #wfadrdakvh .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #wfadrdakvh .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #wfadrdakvh .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; } #wfadrdakvh .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; } #wfadrdakvh .gt_column_spanner_outer:first-child { padding-left: 0; } #wfadrdakvh .gt_column_spanner_outer:last-child { padding-right: 0; } #wfadrdakvh .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 5px; overflow-x: hidden; display: inline-block; width: 100%; } #wfadrdakvh .gt_group_heading { padding: 8px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; } #wfadrdakvh .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: middle; } #wfadrdakvh .gt_from_md > :first-child { margin-top: 0; } #wfadrdakvh .gt_from_md > :last-child { margin-bottom: 0; } #wfadrdakvh .gt_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; } #wfadrdakvh .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 12px; } #wfadrdakvh .gt_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #wfadrdakvh .gt_first_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; } #wfadrdakvh .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #wfadrdakvh .gt_first_grand_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; } #wfadrdakvh .gt_striped { background-color: rgba(128, 128, 128, 0.05); } #wfadrdakvh .gt_table_body { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #wfadrdakvh .gt_footnotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #wfadrdakvh .gt_footnote { margin: 0px; font-size: 90%; padding: 4px; } #wfadrdakvh .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #wfadrdakvh .gt_sourcenote { font-size: 90%; padding: 4px; } #wfadrdakvh .gt_left { text-align: left; } #wfadrdakvh .gt_center { text-align: center; } #wfadrdakvh .gt_right { text-align: right; font-variant-numeric: tabular-nums; } #wfadrdakvh .gt_font_normal { font-weight: normal; } #wfadrdakvh .gt_font_bold { font-weight: bold; } #wfadrdakvh .gt_font_italic { font-style: italic; } #wfadrdakvh .gt_super { font-size: 65%; } #wfadrdakvh .gt_footnote_marks { font-style: italic; font-weight: normal; font-size: 65%; } 女性, N = 1,2841 男性, N = 1,4441 age 44.0 (10.7) 43.7 (11.0) educ 中学 94 (7.3%) 132 (9.1%) 高校 466 (36%) 482 (33%) 短大高専 466 (36%) 215 (15%) 大学大学院 258 (20%) 615 (43%) occupation 管理職 17 (1.3%) 202 (14%) 専門職 206 (16%) 213 (15%) 技術職・准専門職 143 (11%) 296 (20%) 事務補助 324 (25%) 115 (8.0%) サービス・販売 397 (31%) 179 (12%) 農林漁業 7 (0.5%) 18 (1.2%) 技能工 62 (4.8%) 203 (14%) 設備・機械運転・組立 33 (2.6%) 174 (12%) 単純作業 95 (7.4%) 44 (3.0%) wage 1,339.1 (781.6) 2,195.5 (1,338.7) 1 Mean (SD); n (%) 5.5 結果をファイルに書き出す 5.5.1 結果を入れるためのフォルダを作る 上記ではいろいろなグラフを作ったり、要約統計量を計算するためのコマンドを紹介してきた。RStudio上で見る分にはこれで十分だが、実際にこれらを論文にまとめていく段階では、結果をwordに貼り付けたりする必要がある。ここではそうした方法を紹介する。 3章で、データを置くためのフォルダを作成しておくとよいということを紹介した。分析結果を保存しておくためのフォルダというのも別途あると整理整頓ができて便利である。ここでは、「results」という分析結果を保存しておくためのフォルダを作ろう。右クリックで「新規フォルダを作成」するか、以下のコードを実行する。 dir.create(&quot;results&quot;) 5.5.2 ggplotで作成した図を書き出す ggplotで作成した図を保存する方法は以下のとおりである。日本語フォントを含んでいるかどうか、および、出力形式によってどのようなコマンドを実行するかが変わってくるので、注意が必要。 5.5.2.1 日本語フォントを含まない図の場合 piaac %&gt;% ggplot(aes(x = wage)) + geom_histogram() + xlim(0, 10000) ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. ここでは図を保存するときの形式として、pdfファイルとpngファイルについて説明する。 pdfはベクター形式といわれていて、拡大しても画質が荒くならない。どんなに大きくしたり小さくしたりしてもつねにきれいなグラフが保持されるというメリットがあるが、Wordファイルに貼り付けられなかったりすることもある（たしかWindowsだとWordにpdfを貼り付けられない気がする？）。 pngはラスタ形式と言われていて、（写真みたいに）拡大すると画質が荒くなってしまう。ただ、よっぽど拡大しない限りはそれなりにきれいな図にすることができるので、これでも事足りる場面は多い。この方法は、WindowsでもMacでも実行できるはず。 書き出したい図が右下のplotのウィンドウに表示された状態でggsave()を使って保存することができる。 ggsave(&quot;results/histogram.pdf&quot;) # png形式 ## Saving 7 x 5 in image ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. ggsave(&quot;results/histogram.png&quot;) # png形式 ## Saving 7 x 5 in image ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. サイズをとくに指定しない場合には、plotの画面に表示されている縮尺で結果が保存される。これだとあまりplotのウィンドウの大きさによって出力結果が変わってしまうので、次のように幅と高さを指定するとよい。 ggsave(&quot;results/histogram.pdf&quot;, width = 5, height = 4) ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. 自分はたいていwidthを5、heightを4に設定している。 5.5.2.2 日本語フォントを含む図の場合 続いて、日本語フォントを含む図を保存してみよう。 piaac %&gt;% with(table(occupation)) %&gt;% prop.table() %&gt;% as.data.frame() %&gt;% ggplot(aes(x = occupation, y = Freq)) + geom_col() + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # X軸を45度傾ける labs(x = &quot;職業&quot;, y = &quot;割合&quot;) # x軸とy軸に名前をつける png形式の場合は今までと同じ方法で文字化けせずに保存できる。 ggsave(&quot;results/bar_graph.png&quot;, width = 5, height = 4) # png形式 pdfの場合にはひとくふう必要となる。まず、保存したいグラフをオブジェクトに入れてやる。 g &lt;- piaac %&gt;% with(table(occupation)) %&gt;% prop.table() %&gt;% as.data.frame() %&gt;% ggplot(aes(x = occupation, y = Freq)) + geom_col() + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # X軸を45度傾ける labs(x = &quot;職業&quot;, y = &quot;割合&quot;) # x軸とy軸に名前をつける そのうえで、Windowsの場合は以下のコマンド： pdf(file = &quot;results/bar_graph.pdf&quot;, family = &quot;Japan1GothicBBB&quot;, width = 5, height = 4) g dev.off() Macの場合は以下のコマンドで保存する： quartz(file = &quot;results/bar_graph.pdf&quot;, type = &quot;pdf&quot;, family = &quot;sans&quot;, width = 5, height = 4) g dev.off() ## quartz_off_screen ## 2 5.5.3 記述統計の一覧表をwordに書き出す gtsummary::tbl_summary()で作成した記述統計の表はword形式で書き出すことができる。その際に用いるパッケージがflextableである。まずはこのパッケージを読み込んでおく。 library(flextable) 先ほど作成したグループ別の記述統計量の表をwordファイルに書き出したいときには、以下のように%&gt;%演算子でつないで、as_flex_table() %&gt;% save_as_docs(path = \"xxx.docx\")というコマンドを追加する。 piaac_selected %&gt;% tbl_summary(label = list(gender ~ &quot;性別&quot;, age ~ &quot;年齢&quot;, educ ~ &quot;最終学歴&quot;, occupation ~ &quot;職業&quot;, wage ~ &quot;賃金&quot;), statistic = list(all_continuous() ~ &quot;{mean} ({sd})&quot;), by = gender, digits = all_continuous() ~ 1) %&gt;% modify_header(label ~ &quot;&quot;) %&gt;% as_flex_table() %&gt;% save_as_docx(path = &quot;results/summary.docx&quot;) "],["tabulate.html", "Chapter 6 2変数の集計 6.1 平均値の比較 6.2 分布の比較 6.3 クロス集計表 6.4 クロス集計表を図示する 6.5 散布図 6.6 2変数集計のときのくふう 6.7 結果をファイルに書き出す", " Chapter 6 2変数の集計 本章では、2変数の集計方法を説明する。 内容に入る前に、右上のプロジェクトのボックスの横が、前章で作成したプロジェクトの名前（たとえば、seminar_sociology_r）になっているかどうかを確認しておこう。なっていない場合は、右上のボックスをクリックして、「Open Project…」を選択し、前章で作成したRprojファイル（たとえば、seminar_sociology_r.Rprojといったような名前になっている）を選んで、プロジェクトを切り替えよう。 さらに、これまでの章で説明した以下のパッケージを読み込んだ上で、第4章で作成したデータを読み込んでpiaacというデータフレームに入れていることを前提とする。具体的には、以下のコードを実行しておく必要がある。 library(tidyverse) library(gtsummary) library(flextable) piaac &lt;- read_rds(&quot;data/piaac_sample_analytic.rds&quot;) 加えて、第5章で確認したように、ggplotの設定を変更しておくことで見やすいグラフを作ることができる。ここでは以下のコードを実行している。 Macの場合： theme_set(theme_bw( base_family = &quot;HiraginoSans-W3&quot;, base_size = 11, base_rect_size = 0.2, base_line_size = 0.2 )) Windowsの場合： theme_set(theme_bw( base_size = 11, base_rect_size = 0.2, base_line_size = 0.2 )) 6.1 平均値の比較 6.1.1 基本 カテゴリ変数の値ごとに連続変数の値を比較したい。たとえば性別ごとに賃金の平均値を比較したいとする。このようなときには、前章で学んだ連続変数を集計する方法に、以下のようにグループに分けるための命令group_by()を付け加えることで、グループ別の集計を行うことができる。 piaac %&gt;% group_by(gender) %&gt;% # genderの値ごとに分けると宣言 summarize(mean = mean(wage)) ## # A tibble: 2 × 2 ## gender mean ## &lt;fct&gt; &lt;dbl&gt; ## 1 女性 1339. ## 2 男性 2196. 前章で説明したときと同様、集計する変数にNAが含まれていると計算ができず、結果はNAとなる。グループ別に集計する場合はgroup_by()で分ける変数にNAが含まれている可能性も考えないといけない。たとえば、父親学歴parenteducごとに集計してみるとどうだろうか。ここでは、平均値だけではなく標準偏差と人数を合わせてチェックしてみよう。 piaac %&gt;% group_by(fathereduc) %&gt;% summarize(mean = mean(wage), sd = sd(wage), n = n()) ## # A tibble: 4 × 4 ## fathereduc mean sd n ## &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; ## 1 初等教育 1689. 1181. 912 ## 2 中等教育 1772. 1157. 1120 ## 3 高等教育 1985. 1260. 639 ## 4 &lt;NA&gt; 1680. 984. 57 このように、group_by()で分ける変数にNAが含まれている場合には、それもグループとみなしたうえで集計を行う。これがそのまま残っているとグラフを作ったりするときに面倒になるので、やはりNAはあらかじめ除外しておくとよい。 piaac %&gt;% filter(is.na(fathereduc) == FALSE) %&gt;% # is.na(fathereduc)で、fathereducの値がNAならTRUE, NAでないならFALSEを返す group_by(parenteduc) %&gt;% summarize(mean = mean(wage), sd = sd(wage), n = n()) ## # A tibble: 3 × 4 ## parenteduc mean sd n ## &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; ## 1 初等教育 1650. 1206. 670 ## 2 中等教育 1773. 1155. 1176 ## 3 高等教育 1943. 1227. 825 6.1.2 棒グラフによる可視化 平均値の違いを視覚的にみたいときには、棒グラフを作るのがよい。先ほどのようにカテゴリごとに平均値を計算したうえで、geom_col()で棒グラフを作ることができる。 piaac %&gt;% group_by(gender) %&gt;% summarize(mean = mean(wage)) %&gt;% ggplot(aes(x = gender, y = mean)) + geom_col() + labs(x = &quot;性別&quot;, y = &quot;平均賃金&quot;) 6.1.3 複数カテゴリの組み合わせ 複数のカテゴリ変数を組み合わせて平均値を比較したいということもあるだろう。このような場合も、基本は同じ。group_by()の部分に複数の変数を指定することで、カテゴリを組合わせた集計ができる。 piaac %&gt;% group_by(gender, educ) %&gt;% summarize(mean = mean(wage), sd = sd(wage), n = n()) ## `summarise()` has grouped output by &#39;gender&#39;. You can override using the `.groups` argument. ## # A tibble: 8 × 5 ## # Groups: gender [2] ## gender educ mean sd n ## &lt;fct&gt; &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; ## 1 女性 中学 993. 563. 94 ## 2 女性 高校 1158. 633. 466 ## 3 女性 短大高専 1363. 775. 466 ## 4 女性 大学大学院 1749. 921. 258 ## 5 男性 中学 1743. 1288. 132 ## 6 男性 高校 1900. 1045. 482 ## 7 男性 短大高専 1935. 1142. 215 ## 8 男性 大学大学院 2615. 1495. 615 棒グラフを作ることももちろんできる。いくつかのパターンを示しておく。 meandata &lt;- piaac %&gt;% group_by(gender, educ) %&gt;% summarize(mean = mean(wage)) #いったん名前をつけて保存しておく ## `summarise()` has grouped output by &#39;gender&#39;. You can override using the `.groups` argument. 学歴で色分けするパターン： meandata %&gt;% ggplot(aes(x = gender, y = mean, fill = educ)) + # fillで色分けする変数を指定 geom_col(position = &quot;dodge&quot;) + # position = &quot;dodge&quot;とすることで棒を重ねずに表示する labs(x = &quot;性別&quot;, y = &quot;平均賃金&quot;, fill = &quot;学歴&quot;) 性別で色分けするパターン： meandata %&gt;% ggplot(aes(x = educ, y = mean, fill = gender)) + geom_col(position = &quot;dodge&quot;) + labs(x = &quot;学歴&quot;, y = &quot;平均賃金&quot;, fill = &quot;性別&quot;) 性別でグラフを分割するパターン： meandata %&gt;% ggplot(aes(x = educ, y = mean)) + geom_col() + labs(x = &quot;学歴&quot;, y = &quot;平均賃金&quot;) + facet_wrap(~gender) 6.2 分布の比較 平均値だけではなく、分布そのものを比較することでより全体の違いがわかりやすい事がある。前章ではヒストグラムを使って連続変数の分布をみる方法を紹介した。これをグループ別にそれぞれ書いてみよう。 複数のヒストグラムを重ねるときには、geom_histogram()のなかでposition = \"identity\"と指定する。また、ヒストグラムが重なると片方が見えなくなってしまうので、alpha = 0.5などと指定することで、透明度をつける。alpha = 1がデフォルトで、0に近づくほど透明度が高くなる。 piaac %&gt;% ggplot(aes(x = wage, fill = gender)) + geom_histogram(position = &quot;identity&quot;, alpha = 0.5) + labs(fill = &quot;&quot;) ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. グループ間で人数が異なると少し比較が難しいかもしれない。このような場合は縦軸を度数ではなく密度（density）にするとよい。 piaac %&gt;% ggplot(aes(x = wage, y = ..density.., fill = gender)) + geom_histogram(position = &quot;identity&quot;, alpha = 0.5) + labs(fill = &quot;&quot;) ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. カテゴリの数が2つならいいが、たくさんの場合には見にくくなってしまう。そのような場合にはfacet_wrap()をつかって図を分けるのがよいだろう。 piaac %&gt;% ggplot(aes(x = wage, y = ..density..)) + geom_histogram() + facet_wrap(~occupation) ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. 6.3 クロス集計表 6.3.1 基本 カテゴリ変数の場合は平均値などを計算することはできないので、度数をみることが有効であった。カテゴリ変数の度数分布をグループ間で比べることも可能である。たとえば、親の学歴（父親と母親のうちどちらか高い方の学歴をとった変数）parenteducによって本人の学歴の分布がどの程度異なるのかを知りたいとする。これは、前章で紹介したwith(table())を使うとできる。 piaac %&gt;% with(table(parenteduc, educ)) ## educ ## parenteduc 中学 高校 短大高専 大学大学院 ## 初等教育 127 337 125 106 ## 中等教育 78 464 332 329 ## 高等教育 21 147 224 438 このようなときに、カテゴリ変数の分布をグループごとに集計した表を指して、クロス集計表という。 もちろんこれだけだと、どの学歴ではどの職業が多いのかというのは一見してすぐにわからない。そこで、行%を計算することで、より学歴ごとの内訳がわかりやすくなる。 piaac %&gt;% with(table(parenteduc, educ)) %&gt;% prop.table(margin = 1) ## educ ## parenteduc 中学 高校 短大高専 大学大学院 ## 初等教育 0.18273381 0.48489209 0.17985612 0.15251799 ## 中等教育 0.06483791 0.38570241 0.27597672 0.27348296 ## 高等教育 0.02530120 0.17710843 0.26987952 0.52771084 親の学歴が高いほど、本人の学歴も高いことがわかる。 6.3.2 カイ2乗検定（発展） クロス集計表を作成したときにみられた関連（たとえば今回の場合であれば、親の学歴が高いほど子どもの学歴も高い傾向がある = 親の学歴と子どもの学歴に関連がある）がたんなる偶然で生じたものではなく、母集団においても確かに関連があるかどうかを確かめたいとする。これを統計的検定という。 クロス集計表の場合には、カイ二乗検定という方法を用いて検定を行う。カイ二乗検定では、（もし親の学歴と子どもの学歴の間にまったく関連がなかったとしたら得られるであろう）架空のクロス集計表と比べて、実際のクロス集計表で得られた結果が大きくかけ離れていたのであれば、やはり母集団においても親の学歴と子どもの学歴の間には関連があるのだろう（親の学歴と子どもの学歴の間に関連がないという帰無仮説を棄却する）、というふうに考えて関連の有無を判定する。 with(table())で作成したテーブルに対してchisq.test()を実行することでカイ二乗検定を行うことができる。 piaac %&gt;% with(table(parenteduc, educ)) %&gt;% chisq.test() ## ## Pearson&#39;s Chi-squared test ## ## data: . ## X-squared = 432.95, df = 6, p-value &lt; 2.2e-16 「p-value」というところをみると、非常に低い値を示していることがわかる10。これはつまり、もし親の学歴と子どもの学歴の間に全く関連がなかったとしたら、今回のデータのようなクロス集計表が（偶然に）得られる確率は極めて低い、ということを表している。この結果から、「親の学歴と子どもの学歴には関連がない」という帰無仮説を棄却でき、たしかに、親の学歴と子どもの学歴には関連があるのだと主張することができる。 6.3.3 きれいなクロス表をつくる - gtsummary::tbl_cross() とはいえ、このクロス表はあまり見やすいものとはいえない。度数（人数）と行%がいずれも表示され、かつ、周辺度数（行合計と列合計）を表示するグラフは作れないだろうか。 このようなときに、gtsummaryパッケージに含まれているgtsummary::tbl_cross()関数が役に立つ。 library(gtsummary) 行%を表記する場合は、tbl_cross(data = xx, row = 行にする変数, column = 列にする変数, percent = \"row\")と書く。 piaac %&gt;% tbl_cross(parenteduc, educ, percent = &quot;row&quot;) html { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif; } #jkoosofrwe .gt_table { display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; } #jkoosofrwe .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #jkoosofrwe .gt_title { color: #333333; font-size: 125%; font-weight: initial; padding-top: 4px; padding-bottom: 4px; border-bottom-color: #FFFFFF; border-bottom-width: 0; } #jkoosofrwe .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 0; padding-bottom: 6px; border-top-color: #FFFFFF; border-top-width: 0; } #jkoosofrwe .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #jkoosofrwe .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #jkoosofrwe .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; } #jkoosofrwe .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; } #jkoosofrwe .gt_column_spanner_outer:first-child { padding-left: 0; } #jkoosofrwe .gt_column_spanner_outer:last-child { padding-right: 0; } #jkoosofrwe .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 5px; overflow-x: hidden; display: inline-block; width: 100%; } #jkoosofrwe .gt_group_heading { padding: 8px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; } #jkoosofrwe .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: middle; } #jkoosofrwe .gt_from_md > :first-child { margin-top: 0; } #jkoosofrwe .gt_from_md > :last-child { margin-bottom: 0; } #jkoosofrwe .gt_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; } #jkoosofrwe .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 12px; } #jkoosofrwe .gt_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #jkoosofrwe .gt_first_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; } #jkoosofrwe .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #jkoosofrwe .gt_first_grand_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; } #jkoosofrwe .gt_striped { background-color: rgba(128, 128, 128, 0.05); } #jkoosofrwe .gt_table_body { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #jkoosofrwe .gt_footnotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #jkoosofrwe .gt_footnote { margin: 0px; font-size: 90%; padding: 4px; } #jkoosofrwe .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #jkoosofrwe .gt_sourcenote { font-size: 90%; padding: 4px; } #jkoosofrwe .gt_left { text-align: left; } #jkoosofrwe .gt_center { text-align: center; } #jkoosofrwe .gt_right { text-align: right; font-variant-numeric: tabular-nums; } #jkoosofrwe .gt_font_normal { font-weight: normal; } #jkoosofrwe .gt_font_bold { font-weight: bold; } #jkoosofrwe .gt_font_italic { font-style: italic; } #jkoosofrwe .gt_super { font-size: 65%; } #jkoosofrwe .gt_footnote_marks { font-style: italic; font-weight: normal; font-size: 65%; } Characteristic educ Total 中学 高校 短大高専 大学大学院 parenteduc 初等教育 127 (18%) 337 (48%) 125 (18%) 106 (15%) 695 (100%) 中等教育 78 (6.5%) 464 (39%) 332 (28%) 329 (27%) 1,203 (100%) 高等教育 21 (2.5%) 147 (18%) 224 (27%) 438 (53%) 830 (100%) Total 226 (8.3%) 948 (35%) 681 (25%) 873 (32%) 2,728 (100%) 値が度数、括弧内が行%を意味している。with(table())のときと違って、もし変数にNAが含まれている場合には表から自動的に除外されず、「Unknown」という行や列が追加される。 このクロス集計表もいくつかの点で改良の余地がある。以下の3つの点で修正をしてみよう。 parenteduc, educがそれぞれ何を指しているのか、日本語の名前をつけたい：label = list(x ~ \"名前\") 行および列の合計が”Total”と記載されているが、これを「合計」という日本語の名前にしたい：margin_text = \"合計\" 左上に書かれている「Characteristics」というのは特に必要がないので削除したい：tbl_crossのコマンドの後ろに%&gt;%でつないでmodify_header(label ~ \"\") piaac %&gt;% tbl_cross(parenteduc, educ, percent = &quot;row&quot;, label = list(parenteduc ~ &quot;親学歴&quot;, educ ~ &quot;本人学歴&quot;), margin_text = &quot;合計&quot;) %&gt;% modify_header(label ~ &quot;&quot;) html { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif; } #ohduluwksx .gt_table { display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; } #ohduluwksx .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #ohduluwksx .gt_title { color: #333333; font-size: 125%; font-weight: initial; padding-top: 4px; padding-bottom: 4px; border-bottom-color: #FFFFFF; border-bottom-width: 0; } #ohduluwksx .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 0; padding-bottom: 6px; border-top-color: #FFFFFF; border-top-width: 0; } #ohduluwksx .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #ohduluwksx .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #ohduluwksx .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; } #ohduluwksx .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; } #ohduluwksx .gt_column_spanner_outer:first-child { padding-left: 0; } #ohduluwksx .gt_column_spanner_outer:last-child { padding-right: 0; } #ohduluwksx .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 5px; overflow-x: hidden; display: inline-block; width: 100%; } #ohduluwksx .gt_group_heading { padding: 8px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; } #ohduluwksx .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: middle; } #ohduluwksx .gt_from_md > :first-child { margin-top: 0; } #ohduluwksx .gt_from_md > :last-child { margin-bottom: 0; } #ohduluwksx .gt_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; } #ohduluwksx .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 12px; } #ohduluwksx .gt_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #ohduluwksx .gt_first_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; } #ohduluwksx .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #ohduluwksx .gt_first_grand_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; } #ohduluwksx .gt_striped { background-color: rgba(128, 128, 128, 0.05); } #ohduluwksx .gt_table_body { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #ohduluwksx .gt_footnotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #ohduluwksx .gt_footnote { margin: 0px; font-size: 90%; padding: 4px; } #ohduluwksx .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #ohduluwksx .gt_sourcenote { font-size: 90%; padding: 4px; } #ohduluwksx .gt_left { text-align: left; } #ohduluwksx .gt_center { text-align: center; } #ohduluwksx .gt_right { text-align: right; font-variant-numeric: tabular-nums; } #ohduluwksx .gt_font_normal { font-weight: normal; } #ohduluwksx .gt_font_bold { font-weight: bold; } #ohduluwksx .gt_font_italic { font-style: italic; } #ohduluwksx .gt_super { font-size: 65%; } #ohduluwksx .gt_footnote_marks { font-style: italic; font-weight: normal; font-size: 65%; } 本人学歴 合計 中学 高校 短大高専 大学大学院 親学歴 初等教育 127 (18%) 337 (48%) 125 (18%) 106 (15%) 695 (100%) 中等教育 78 (6.5%) 464 (39%) 332 (28%) 329 (27%) 1,203 (100%) 高等教育 21 (2.5%) 147 (18%) 224 (27%) 438 (53%) 830 (100%) 合計 226 (8.3%) 948 (35%) 681 (25%) 873 (32%) 2,728 (100%) これならばそのまま論文に掲載できるくらいきれいな図になっている。もちろんこれもwordファイルに書き出すことができる。この方法については本章最後に紹介する。 6.4 クロス集計表を図示する クロス集計表は数値が多いので、図で表されているとわかりやすいかもしれない。このようなときも、前章で説明したように、with(table())で作成した数値をデータフレームとすることで、比較的簡単に図をつくることができる。 table &lt;- piaac %&gt;% with(table(parenteduc, educ)) %&gt;% prop.table(margin = 1) %&gt;% as.data.frame() # データフレーム形式に変換 table #中身を確認。 ## parenteduc educ Freq ## 1 初等教育 中学 0.18273381 ## 2 中等教育 中学 0.06483791 ## 3 高等教育 中学 0.02530120 ## 4 初等教育 高校 0.48489209 ## 5 中等教育 高校 0.38570241 ## 6 高等教育 高校 0.17710843 ## 7 初等教育 短大高専 0.17985612 ## 8 中等教育 短大高専 0.27597672 ## 9 高等教育 短大高専 0.26987952 ## 10 初等教育 大学大学院 0.15251799 ## 11 中等教育 大学大学院 0.27348296 ## 12 高等教育 大学大学院 0.52771084 table %&gt;% ggplot(aes(y = Freq, x = parenteduc, fill = educ)) + geom_col() + labs(x = &quot;&quot;, y = &quot;割合&quot;, fill = &quot;本人学歴&quot;) 積み上げ棒グラフは各カテゴリの大きさがわかりにくいので、ばらして始点をそろえるほうが見やすいかもしれない。 table %&gt;% ggplot(aes(y = Freq, x = parenteduc, fill = educ)) + geom_col(position = &quot;dodge&quot;) + labs(x = &quot;&quot;, y = &quot;割合&quot;, fill = &quot;本人学歴&quot;) 6.5 散布図 6.5.1 散布図をみる 連続変数どうしの関係をみたいときには、散布図を使う。散布図を書くときには、geom_point()を使う。サンプルサイズが大きい場合には点がかぶってしまうので、かぶっている箇所がわかりやすいよう、透明度を指定するか、点の形状を変えると良い。shape = 1というオプションをつけると、白抜きの点にできる11。 piaac %&gt;% ggplot(aes(x = age, y = wage)) + geom_point(shape = 1) 散布図の傾向を表すような直線を引くと、関係がよりわかりやすいだろう。 piaac %&gt;% ggplot(aes(x = age, y = wage)) + geom_point(shape = 1) + geom_smooth(method = &quot;lm&quot;, se = FALSE) ## `geom_smooth()` using formula &#39;y ~ x&#39; geom_smooth()というのは、2つの変数の関連の傾向を示す線を描く関数。カッコ内で、どのような線を引くのかを指定する。 method = \"lm\"という部分は、回帰分析により推定される直線を引くという指定を表している。何も書かない場合には、method = \"loess\"（局所回帰）による線が描かれる。 se = FALSEの部分では、係数の標準誤差から計算される95%信頼区間を書かないという指定を表している。何も書かない場合には、信頼区間がプロットされる。 6.5.2 カテゴリごとに散布図を分ける たとえば男性と女性で別々に散布図を書きたいということがあるだろう。このような場合には、facet_wrap()を使うか、color =を指定する。 piaac %&gt;% ggplot(aes(x = age, y = wage)) + geom_point(shape = 1) + geom_smooth(method = &quot;lm&quot;, se = FALSE) + facet_wrap(~gender) ## `geom_smooth()` using formula &#39;y ~ x&#39; piaac %&gt;% ggplot(aes(x = age, y = wage, color = gender)) + geom_point(shape = 1) + geom_smooth(method = &quot;lm&quot;, se = FALSE) ## `geom_smooth()` using formula &#39;y ~ x&#39; 6.5.3 相関係数 相関係数は以下のように定義される： \\[ r = \\frac{\\textrm{Cov}(x, y)}{\\textrm{Sd}(x)\\textrm{Sd}(y)} = \\frac{\\frac{1}{N} \\sum_{i = 1}^N(x_i - \\overline{x})(y_i - \\overline{y})}{\\sqrt{\\frac{1}{N} \\sum_{i = 1}^N(x_i - \\overline{x})^2}\\sqrt{\\frac{1}{N} \\sum_{i = 1}^N(y_i - \\overline{y})^2}} \\] 相関係数はsummarize()コマンドで計算できる。NAが含まれている場合にはやはり計算結果もNAになってしまうので、前もってNAの行がないかどうかチェックしておく。 piaac %&gt;% filter(is.na(wage) == FALSE) %&gt;% summarize(cor = cor(age, wage)) ## # A tibble: 1 × 1 ## cor ## &lt;dbl&gt; ## 1 0.135 6.6 2変数集計のときのくふう 6.6.1 値が粗い連続変数を扱う 値が粗い連続変数を扱う場合、散布図があまり可視化の役に立たないことがある。例えば、健康状態について尋ねた質問の選択肢に次のように値を与え、高いほど健康であることを示すようにした変数（health）があるとする。 選択肢 調査票上の番号 数値化例 極めて優れている 1 5 大変良い 2 4 良い 3 3 どちらともいえない 4 2 悪い 5 1 年齢が高いほど健康状態が悪くなるというのはよく知られているので、年齢を横軸、健康状態を縦軸にとった散布図を書くと右下に点が集まるはずだと思ったが、散布図を書いてみると、点が重なってしまってなんだかよくわからない散布図になってしまう。 piaac %&gt;% ggplot(aes(x = age, y = health)) + geom_point(alpha = 0.2) このような場合はどうしたらよいだろうか？解決策の1つは、平均値の比較のときのように、横軸の変数の値ごとに健康状態の平均値を計算し、それをプロットするという方法がある。 piaac %&gt;% group_by(age) %&gt;% summarize(mean = mean(health)) %&gt;% ggplot(aes(x = age, y = mean)) + geom_point() ただ、この図では人数が少ない年齢層も多い年齢層も同じ大きさの点で描かれてしまっていることが少し不満かもしれない。点の大きさを考慮したい場合には、バブル・プロットを使う。aestheticsのところでsize =を指定することで、点の大きさを変えることができる。ただしその際、scale_size_area(max_size = 5)などというふうに円の面積に関するコマンドを含めないと円の大きさと人数が対応しなくなってしまうため、注意が必要。 piaac %&gt;% group_by(age) %&gt;% summarize(mean = mean(health), n = n()) %&gt;% ggplot(aes(x = age, y = mean, size = n)) + geom_point(shape = 1) + scale_size_area(max_size = 5) 6.6.2 カテゴリが多いクロス集計表を扱う 学歴によって就いている職業の分布がどのように異なっているかを知りたいとする。このような場合にはクロス集計表を作る。 piaac %&gt;% tbl_cross(educ, occupation, percent = &quot;row&quot;) html { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif; } #vrkcklkpna .gt_table { display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; } #vrkcklkpna .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #vrkcklkpna .gt_title { color: #333333; font-size: 125%; font-weight: initial; padding-top: 4px; padding-bottom: 4px; border-bottom-color: #FFFFFF; border-bottom-width: 0; } #vrkcklkpna .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 0; padding-bottom: 6px; border-top-color: #FFFFFF; border-top-width: 0; } #vrkcklkpna .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #vrkcklkpna .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #vrkcklkpna .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; } #vrkcklkpna .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; } #vrkcklkpna .gt_column_spanner_outer:first-child { padding-left: 0; } #vrkcklkpna .gt_column_spanner_outer:last-child { padding-right: 0; } #vrkcklkpna .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 5px; overflow-x: hidden; display: inline-block; width: 100%; } #vrkcklkpna .gt_group_heading { padding: 8px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; } #vrkcklkpna .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: middle; } #vrkcklkpna .gt_from_md > :first-child { margin-top: 0; } #vrkcklkpna .gt_from_md > :last-child { margin-bottom: 0; } #vrkcklkpna .gt_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; } #vrkcklkpna .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 12px; } #vrkcklkpna .gt_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #vrkcklkpna .gt_first_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; } #vrkcklkpna .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #vrkcklkpna .gt_first_grand_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; } #vrkcklkpna .gt_striped { background-color: rgba(128, 128, 128, 0.05); } #vrkcklkpna .gt_table_body { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #vrkcklkpna .gt_footnotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #vrkcklkpna .gt_footnote { margin: 0px; font-size: 90%; padding: 4px; } #vrkcklkpna .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #vrkcklkpna .gt_sourcenote { font-size: 90%; padding: 4px; } #vrkcklkpna .gt_left { text-align: left; } #vrkcklkpna .gt_center { text-align: center; } #vrkcklkpna .gt_right { text-align: right; font-variant-numeric: tabular-nums; } #vrkcklkpna .gt_font_normal { font-weight: normal; } #vrkcklkpna .gt_font_bold { font-weight: bold; } #vrkcklkpna .gt_font_italic { font-style: italic; } #vrkcklkpna .gt_super { font-size: 65%; } #vrkcklkpna .gt_footnote_marks { font-style: italic; font-weight: normal; font-size: 65%; } Characteristic occupation Total 管理職 専門職 技術職・准専門職 事務補助 サービス・販売 農林漁業 技能工 設備・機械運転・組立 単純作業 educ 中学 7 (3.1%) 2 (0.9%) 12 (5.3%) 18 (8.0%) 48 (21%) 9 (4.0%) 52 (23%) 40 (18%) 38 (17%) 226 (100%) 高校 48 (5.1%) 27 (2.8%) 114 (12%) 177 (19%) 266 (28%) 7 (0.7%) 120 (13%) 125 (13%) 64 (6.8%) 948 (100%) 短大高専 31 (4.6%) 123 (18%) 114 (17%) 121 (18%) 173 (25%) 4 (0.6%) 63 (9.3%) 24 (3.5%) 28 (4.1%) 681 (100%) 大学大学院 133 (15%) 267 (31%) 199 (23%) 123 (14%) 89 (10%) 5 (0.6%) 30 (3.4%) 18 (2.1%) 9 (1.0%) 873 (100%) Total 219 (8.0%) 419 (15%) 439 (16%) 439 (16%) 576 (21%) 25 (0.9%) 265 (9.7%) 207 (7.6%) 139 (5.1%) 2,728 (100%) この表はやや横に大きく、数値も多いため、見にくい表になってしまっているかもしれない。実際、これを積み上げ棒グラフにすると、お世辞にもあまり見やすいとはいえないグラフができあがる。 table &lt;- piaac %&gt;% with(table(educ, occupation)) %&gt;% prop.table(margin = 1) %&gt;% as.data.frame() # データフレーム形式に変換 table %&gt;% ggplot(aes(x = educ, y = Freq, fill = occupation)) + geom_col() + labs(x = &quot;&quot;, y = &quot;&quot;, fill = &quot;&quot;) そこで、学歴ごとにグラフをわけて、職業の分布を書くという方法がある。facet_wrap()を使うことで、グラフを分割することができる。 table %&gt;% ggplot(aes(y = Freq, x = occupation)) + geom_col() + facet_wrap(~educ) + labs(x = &quot;&quot;, y = &quot;割合&quot;) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) もう一つの方法は、職業ごとにグラフをわけて、各学歴において当該職業に就いている人の割合を示すという方法である。 table %&gt;% ggplot(aes(y = Freq, x = educ)) + geom_col() + facet_wrap(~occupation) + labs(x = &quot;&quot;, y = &quot;割合&quot;) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) どのように図示するかは、自分がどれだと文章を書きやすいか（何を伝えたいのか）によって決める。 このようにカテゴリが多い場合には、そもそもカテゴリをまとめて簡単にするという方法が考えられる。くわしくは、「カテゴリをまとめる」を参照のこと。 6.7 結果をファイルに書き出す 6.7.1 ggplotで作成した図を書き出す 前章の「結果をファイルに書き出す」を参照。 6.7.2 クロス集計表をwordファイルに書き出す これも基本的な方法は前章の「記述統計の一覧表をwordに書き出す」と同じ。この章ではすでに冒頭で読み込んでおいたが、flextableパッケージを読み込んでおく。 そのうえで、先ほど作成したグループ別の記述統計量の表をwordファイルに書き出したいときには、以下のように%&gt;%演算子でつないで、as_flex_table() %&gt;% save_as_docs(path = \"xxx.docx\")というコマンドを追加する。 piaac %&gt;% tbl_cross(parenteduc, educ, percent = &quot;row&quot;, label = list(parenteduc ~ &quot;親学歴&quot;, educ ~ &quot;本人学歴&quot;), margin_text = &quot;合計&quot;) %&gt;% modify_header(label ~ &quot;&quot;) %&gt;% as_flex_table() %&gt;% save_as_docx(path = &quot;results/tbl_cross.docx&quot;) "],["regression_basic.html", "Chapter 7 回帰分析の基礎 7.1 回帰分析とは何か 7.2 独立変数がカテゴリ変数の場合 7.3 従属変数が2値のカテゴリ変数（0/1）の場合 7.4 （発展）非線形の関連 7.5 結果をファイルに書き出す", " Chapter 7 回帰分析の基礎 本章では、回帰分析の基礎について説明する。 内容に入る前に、右上のプロジェクトのボックスの横が、前章で作成したプロジェクトの名前（たとえば、seminar_sociology_r）になっているかどうかを確認しておこう。なっていない場合は、右上のボックスをクリックして、「Open Project…」を選択し、前章で作成したRprojファイル（たとえば、seminar_sociology_r.Rprojといったような名前になっている）を選んで、プロジェクトを切り替えよう。 さらに、これまでの章で説明した以下のパッケージを読み込んだ上で、第4章で作成したデータを読み込んでpiaacというデータフレームに入れていることを前提とする。具体的には、以下のコードを実行しておく必要がある。 library(tidyverse) library(gtsummary) library(flextable) piaac &lt;- read_rds(&quot;data/piaac_sample_analytic.rds&quot;) 第5章で確認したように、ggplotの設定を変更しておくことで見やすいグラフを作ることができる。ここでは以下のコードを実行している。 Macの場合： theme_set(theme_bw( base_family = &quot;HiraginoSans-W3&quot;, base_size = 11, base_rect_size = 0.2, base_line_size = 0.2 )) Windowsの場合： theme_set(theme_bw( base_size = 11, base_rect_size = 0.2, base_line_size = 0.2 )) 7.1 回帰分析とは何か 7.1.1 散布図を眺める 数的思考力スコアが高いほど賃金（時給換算）が高いという傾向があるかどうかを知りたいとする。このとき、年齢を横軸、賃金を縦軸とする散布図を書いてみる。 piaac %&gt;% ggplot(aes(x = numeracy, y = wage)) + geom_point(shape = 1) なんとなく、数的思考力スコアが高いほど賃金が高い傾向があるようにみえる。この関係を1つの直線で要約するとしたらどのようになるだろう？この直線を示したのが次の図になる。 piaac %&gt;% ggplot(aes(x = numeracy, y = wage)) + geom_point(shape = 1) + geom_smooth(method = &quot;lm&quot;, se = FALSE) ## `geom_smooth()` using formula &#39;y ~ x&#39; 7.1.2 回帰式の読み方 このように、2つの変数の関係を\\(y = f(x)\\)というような関数で表現する分析方法を指して、回帰分析 regression analysis/regression model という。とくに、今y軸に置かれている変数 （賃金）は、数的思考力スコアによって説明される変数であるという意味で、被説明変数 explained variableまたは従属変数 dependent variable、x軸に置かれている変数（数的思考力スコア）は、賃金を説明する変数であるという意味で、説明変数 explanatory variableまたは独立変数 independent variableという。 今回の式は、次のようなかたちになる12。 \\[ y = \\beta_0 + \\beta_1x \\] 今の例の場合は、\\(y\\)は賃金、\\(x\\)は年齢である。\\(\\beta_k\\)のことを係数 coefficient といい、なかでもとくに\\(\\beta_0\\)のことを切片 intercept、\\(\\beta_1\\)のことを傾き slope という。傾きは、\\(x\\)が1単位高いときに\\(y\\)がどれだけ高いかを表す。 ここで関心があるのは傾きの値である。これが正であれば、\\(x\\)が高いほど\\(y\\)は高いという正の関係を表すし、負であれば、\\(x\\)が高いほど\\(y\\)は低いという負の関係を表す。絶対値が大きいほど、\\(x\\) 1単位の変化に対して \\(y\\)がより大きく変わるということを表すので、たんに正か負かというだけでなく、その値も重要である。 今回の場合は係数はどうなるだろうか？線形回帰分析を推定するときのコマンドがlm()である。lm(data = xx, formula = )という書き方になる。formula =の部分は省略しても大丈夫。 lm(data = piaac, formula = wage ~ numeracy) ## ## Call: ## lm(formula = wage ~ numeracy, data = piaac) ## ## Coefficients: ## (Intercept) numeracy ## -521.073 7.849 (Intercept)の部分が切片\\(\\beta_0\\)、numeracyの部分がnumeracyの傾き\\(\\beta_1\\)にそれぞれ対応する。したがって、賃金と年齢の関係は以下の式のように表されるということを意味する： \\[ y = -521.1 + 7.8x \\] 7.1.3 （発展）回帰式の決め方：最小二乗法 もちろん、上記の回帰式は散布図をみて直観でえいやっと式の値を決めたのではなく、全体の傾向をもっともよく要約するような係数を推定している。その係数の推定方法を最小二乗法 ordinary least square, OLSという。 最小二乗法の意味は図にするとわかりやすい。例えば、次のような散布図と、そこに引いた直線を考えよう。 このとき、散布図の各点の座標を\\((x_i, y_i)\\)と表すことにしよう。すると、各点のy座標の位置\\(y_i\\)は、（1）回帰直線の式に\\(x_i\\)を当てはめた値と、（2）そこからのずれ（\\(e_i\\)とする）の和として表すことができる。すなわち： \\[ y_i = \\beta_0 + \\beta_1x_{i} + e_i \\] この\\(e_i\\)というのは、散布図の点からx軸に垂線を下ろしたときの、回帰直線との交点までの距離を表している。図で考えると次のようになる。 ずれ\\(e_i\\)のことを、残差（residuals）という。散布図に直線を引く方法はたくさんあるのだが、最小二乗法では、上記の残差の二乗和を最も小さくするような直線が散布図全体の傾向をもっともよく反映する直線だとみなして、切片と傾きのパラメータを推定する。式で書くとつぎのようになる。 \\[ \\sum_{i = 1}^N e_i^2 = \\sum_{i = 1}^N(y_i - (\\beta_0 + \\beta_1x_{i}))^2 \\] この式を最小にするような\\(\\beta_0, \\beta_1\\)を求めるということになる。上式は\\(\\beta_0, \\beta_1\\)に関して下に凸な二次関数であるので、\\(\\beta_0\\)について微分した値と\\(\\beta_1\\)について微分した値が同時に0になるような\\(\\beta_0, \\beta_1\\)というのが、上式を最小にするようなパラメータだ、ということになる。 \\[ \\left\\{ \\begin{align} \\frac{\\partial}{\\partial\\beta_0}\\sum_{i = 1}^N(y_i - (\\beta_0 + \\beta_1x_{i}))^2 &amp;= 0\\\\ \\frac{\\partial}{\\partial\\beta_1}\\sum_{i = 1}^N(y_i - (\\beta_0 + \\beta_1x_{i}))^2 &amp;= 0\\\\ \\end{align} \\right. \\] これより先のくわしい証明は省略するが、いずれにしてもポイントは、回帰直線は「回帰直線と各点とのずれ（残差）の二乗和が最も小さくなるように引かれた線だ」ということである。 7.1.4 母集団における関係の推測 今回分析しているのはあくまで母集団から抽出された標本（サンプル）であり、本当に知りたいのは母集団においても確かに関係があるといえるかどうかである。今回のサンプルにおいて推定された係数は偶然生じたものではなく、母集団においても確かに正であるということはできるのだろうか。 まずはいったん、回帰分析の結果をオブジェクトに格納しよう。 reg_res &lt;- lm(data = piaac, wage ~ numeracy) 結果は、summary()でよびだすことができる。呼び出した結果には、先ほどの疑問に答えるための情報が含まれている。 summary(reg_res) ## ## Call: ## lm(formula = wage ~ numeracy, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -1774.0 -716.6 -304.5 373.9 8360.5 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) -521.0726 151.8525 -3.431 0.000609 *** ## numeracy 7.8491 0.5098 15.396 &lt; 2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 1143 on 2726 degrees of freedom ## Multiple R-squared: 0.08, Adjusted R-squared: 0.07966 ## F-statistic: 237 on 1 and 2726 DF, p-value: &lt; 2.2e-16 1列目のEstimateの列には、先ほどみたように係数の値が表示される。 2列目のStd. Errorの列が標準誤差 standard errorを表し、得られた係数のばらつき（標準偏差）を示している。標準誤差は、次に述べるp値の計算に使われている13。 4列めのPr(&gt;|t|)の列がp値 p-valueを表している。p値は「もし母集団において係数が0であるという帰無仮説が正しいとしたときに、今回のような係数の値となる確率」を表している。この値が十分に低いのならば、帰無仮説を棄却して、たしかに母集団においても係数は0でなさそうだ（正あるいは負だ）、ということを自信をもって主張できるということになる。 numeracyの行のp値は0.001よりずっと低いことがわかる。つまり、母集団において年齢の係数が0であったとしたら、今回のような係数の値が得られる確率はとても低い（0.001 = 0.1%未満）、ということである。 この確率がどれくらい低ければ自信をもって関係があると言えるのか？ということについて、慣習的には、0.05という基準が使われている。Rでは、0.05よりも小さければ（正確には0.01 ≤ p &lt; 0.05）、p値の横に*という印がつく。同じようにして、0.01よりも小さければ（0.001 ≤ p &lt; 0.01）**、0.001よりも小さければ（p &lt; 0.001）、***という印がつく。 このように、「母集団において係数が0であったとしたら、今回のような係数の値が得られる確率は十分に低い（0.05未満である）」ことを慣習的に「統計的に有意」と略記（？）する。基本的には、統計的に有意でないならば、係数が正であったり負であったりしても、その結果を（母集団においても関係が正だ／負だ、というふうに）強く論じることはできないと考えておけばよい。 7.2 独立変数がカテゴリ変数の場合 7.2.1 2値のカテゴリ 線形回帰分析では、連続変数だけではなく、カテゴリ変数も扱うことができる。その例としてまず、性別によって賃金がどの程度異なるのかを知りたいとする。このとき、（無理やり）散布図を書くと、次のようになる。分布がわかりやすいように点は水平方向に少し散らして表示している。 piaac %&gt;% ggplot(aes(x = gender, y = wage)) + geom_point(shape = 1, position = position_jitter(w = 0.3, h = 0)) + ylim(0, 10000) ここで得られた男性の平均値と女性の平均値をそれぞれ散布図に書き入れてみたのが次の図である。実線が男性の平均値、点線が女性の平均値を表している（コードはやや複雑なので、とくに実行する必要はありません）。 meandata &lt;- piaac %&gt;% group_by(gender) %&gt;% summarize(mean_wage = mean(wage)) piaac %&gt;% ggplot(aes(x = gender, y = wage)) + geom_point(shape = 1, position = position_jitter(w = 0.3, h = 0)) + geom_hline(yintercept = meandata$mean_wage[1], lty = 2, color = &quot;brown1&quot;) + geom_hline(yintercept = meandata$mean_wage[2], color = &quot;deepskyblue&quot;) + annotate(&quot;text&quot;, x = 1.5, y = 1000, label = round(meandata$mean_wage[1], 1), color = &quot;brown1&quot;) + annotate(&quot;text&quot;, x = 1.5, y = 2600, label = round(meandata$mean_wage[2], 1), color = &quot;deepskyblue&quot;) + ylim(0, 10000) いま、男性であれば1、女性であれば0をとる変数\\(x\\)を考えよう。このように、カテゴリ変数のカテゴリを区別するために便宜的に0/1の値を振った変数のことを、ダミー変数 dummy variableという。このとき、性別による賃金の違いを表す回帰式は次のようになる： \\[ y = \\beta_0 + \\beta_1x \\] 回帰式のかたちは先ほどと同じとなる。傾き\\(\\beta_1\\)は、女性（0）とくらべて男性（1）がどの程度賃金が高いのかを示している。実際、この係数を推定してみよう。 piaac &lt;- piaac %&gt;% mutate(male_d = case_when( gender == &quot;男性&quot; ~ 1, gender == &quot;女性&quot; ~ 0 )) reg_res &lt;- lm(data = piaac, wage ~ male_d) summary(reg_res) ## ## Call: ## lm(formula = wage ~ male_d, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -1733.1 -612.4 -329.3 368.6 7438.4 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 1339.12 31.03 43.16 &lt;2e-16 *** ## male_d 856.38 42.65 20.08 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 1112 on 2726 degrees of freedom ## Multiple R-squared: 0.1289, Adjusted R-squared: 0.1285 ## F-statistic: 403.2 on 1 and 2726 DF, p-value: &lt; 2.2e-16 male_dというのが、性別が男性のときに1、女性のときに0をとる変数である。この係数は傾き\\(\\beta_1\\)に対応し、切片（Intercept）は切片\\(\\beta_0\\)に対応する。つまり、推定された式は次のようになる： \\[ y = 1339 + 856x \\] つまり、女性（x = 0）とくらべて男性（x = 1）の賃金は856円高いということを意味している。 この値が、先ほど散布図に示した男性の平均値と女性の平均値の差に一致していることを確認しよう。すなわち、2値のカテゴリ変数を独立変数として用いる場合、傾きの値は、2つのカテゴリの平均値の差を表している。 7.2.2 3値以上のカテゴリ カテゴリが3値以上の場合はどうだろう？これも、基本的には同じふうに考えることができる。 piaac %&gt;% filter(is.na(educ) == FALSE) %&gt;% ggplot(aes(x = educ, y = wage)) + geom_point(shape = 1, position = position_jitter(w = 0.3, h = 0)) 中学卒を基準として、高校卒（高校卒 - 中学卒）、短大高専卒（短大高専卒 - 中学卒）、大学大学院卒（大学大学院卒 - 中学卒）だとどれくらい賃金が高いのかを推定することになる。 piaac &lt;- piaac %&gt;% mutate(educ_d2 = if_else(educ == &quot;高校&quot;, 1, 0)) %&gt;% mutate(educ_d3 = if_else(educ == &quot;短大高専&quot;, 1, 0)) %&gt;% mutate(educ_d4 = if_else(educ == &quot;大学大学院&quot;, 1, 0)) reg_res &lt;- lm(data = piaac, wage ~ educ_d2 + educ_d3 + educ_d4) summary(reg_res) ## ## Call: ## lm(formula = wage ~ educ_d2 + educ_d3 + educ_d4, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -1859.1 -690.8 -310.8 387.7 8184.0 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 1431.36 74.90 19.110 &lt;2e-16 *** ## educ_d2 103.99 83.35 1.248 0.212 ## educ_d3 112.34 86.44 1.300 0.194 ## educ_d4 927.69 84.04 11.039 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 1126 on 2724 degrees of freedom ## Multiple R-squared: 0.1072, Adjusted R-squared: 0.1062 ## F-statistic: 109 on 3 and 2724 DF, p-value: &lt; 2.2e-16 それぞれの係数は、基準カテゴリ（今回なら中学卒）と比べて、それぞれ高校、短大高専、大学大学院卒だとどれくらい賃金の平均値が高いのかを表している。標準誤差やp値のみかたについてはどれも同じ。 7.2.3 変数がfactorであれば自動でカテゴリとして投入される 先ほどまでは、0または1の値が入ったダミー変数を自分で作っていた。独立変数の型がカテゴリの場合には、Rが自動で先ほどのようなダミー変数を勝手に作って投入してくれる。 reg_res &lt;- lm(data = piaac, wage ~ educ) summary(reg_res) ## ## Call: ## lm(formula = wage ~ educ, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -1859.1 -690.8 -310.8 387.7 8184.0 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 1431.36 74.90 19.110 &lt;2e-16 *** ## educ高校 103.99 83.35 1.248 0.212 ## educ短大高専 112.34 86.44 1.300 0.194 ## educ大学大学院 927.69 84.04 11.039 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 1126 on 2724 degrees of freedom ## Multiple R-squared: 0.1072, Adjusted R-squared: 0.1062 ## F-statistic: 109 on 3 and 2724 DF, p-value: &lt; 2.2e-16 それぞれ、「educ高校」は中学卒と比べて高校卒の賃金はいくら高いか、「educ短大高専」は中学卒と比べて短大高専卒の賃金はいくら高いか、「educ大学大学院」は中学卒と比べて大学大学院卒の賃金はいくら高いか、をそれぞれ表す。 ただし、基準カテゴリは一番最初のものが勝手に選ばれるので、たとえば高校を基準にしてその他を比較したい、と思ったときには、自分でカテゴリの順序を変更しておく必要がある。 piaac &lt;- piaac %&gt;% mutate(educ_reorder = factor(educ, levels = c(&quot;高校&quot;, &quot;中学&quot;, &quot;短大高専&quot;, &quot;大学大学院&quot;), labels = c(&quot;高校&quot;, &quot;中学&quot;, &quot;短大高専&quot;, &quot;大学大学院&quot;))) reg_res &lt;- lm(data = piaac, wage ~ educ_reorder) summary(reg_res) ## ## Call: ## lm(formula = wage ~ educ_reorder, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -1859.1 -690.8 -310.8 387.7 8184.0 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 1535.357 36.571 41.983 &lt;2e-16 *** ## educ_reorder中学 -103.992 83.352 -1.248 0.212 ## educ_reorder短大高専 8.351 56.562 0.148 0.883 ## educ_reorder大学大学院 823.702 52.818 15.595 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 1126 on 2724 degrees of freedom ## Multiple R-squared: 0.1072, Adjusted R-squared: 0.1062 ## F-statistic: 109 on 3 and 2724 DF, p-value: &lt; 2.2e-16 7.3 従属変数が2値のカテゴリ変数（0/1）の場合 7.3.1 クロス集計と比較しながら結果をみる たとえば、性別によってこの1年間に職場での訓練（OJTとよぶ）を受ける率が異なっているかどうかを知りたいとする。これも今までと同じように回帰分析の枠組みで扱うことができる。 まず、OJTを受けたならば1、受けていないならば0を取る変数があるとする。この値の平均をとれば、OJTを受けた人の割合に一致する。たとえば以下の2つを比較してみよう。 piaac %&gt;% with(table(gender, ojt)) %&gt;% prop.table(margin = 1) %&gt;% round(3) ## ojt ## gender 0 1 ## 女性 0.674 0.326 ## 男性 0.592 0.408 ついで、性別ごとにojtの平均値を計算し、図に書いてみる。 piaac %&gt;% group_by(gender) %&gt;% summarize(mean_ojt = mean(ojt, na.rm = TRUE)) %&gt;% ggplot(aes(x = gender, y = mean_ojt, fill = gender)) + geom_col() + geom_text(aes(label = round(mean_ojt, digit = 3)), vjust = -1) + ylim(0, 1) + theme(legend.position = &quot;none&quot;) ここで示された値は、上記クロス表の「1」のほうに示されている行%、すなわち「OJTを受けた人の割合」に一致している。男性は女性とくらべてOJTを受けた割合が8.2%ポイント高いということがわかる。 回帰式を推定してみよう。 reg_res &lt;- lm(data = piaac, ojt ~ gender) summary(reg_res) ## ## Call: ## lm(formula = ojt ~ gender, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -0.4079 -0.4079 -0.3263 0.5921 0.6737 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 0.32632 0.01343 24.30 &lt; 2e-16 *** ## gender男性 0.08157 0.01846 4.42 1.03e-05 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 0.4811 on 2726 degrees of freedom ## Multiple R-squared: 0.007116, Adjusted R-squared: 0.006751 ## F-statistic: 19.54 on 1 and 2726 DF, p-value: 1.026e-05 「gender男性」と書かれている行が、女性と比べて男性が何ポイントOJTを受ける割合が高いのかを示している。この値が、ちょうど先ほどの棒グラフの男性と女性の割合（平均値）の差に一致していることを確認しよう。係数の見方も、標準誤差も、p値も、すべて今までの回帰分析と同じである。 7.3.2 散布図と比較しながら結果をみる もちろん、年齢などの連続変数を独立変数（X）として使うこともできる。たとえば、横軸に年齢、縦軸にOJTをとった散布図を考えてみよう。ここでは重なっているほど点が大きくなるように調整している。 piaac %&gt;% group_by(age, ojt) %&gt;% summarize(n = n()) %&gt;% ggplot(aes(x = age, y = ojt)) + geom_point(aes(size = n), shape = 1) + scale_size(range = c(1, 10)) + geom_smooth(aes(weight = n), method = &quot;lm&quot;, se = FALSE) + theme(legend.position = &quot;none&quot;) ## `summarise()` has grouped output by &#39;age&#39;. You can override using the `.groups` argument. ## `geom_smooth()` using formula &#39;y ~ x&#39; 縦軸のOJTは0または1しかとらないので、点はy = 1またはy = 0の位置のどちらかに描かれる。推定される回帰式は、この散布図全体の傾向を要約するような線として表される。実際に、回帰式を推定してみよう。 reg_res &lt;- lm(data = piaac, ojt ~ age) summary(reg_res) ## ## Call: ## lm(formula = ojt ~ age, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -0.4416 -0.3842 -0.3230 0.6043 0.7076 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 0.5372265 0.0383580 14.006 &lt; 2e-16 *** ## age -0.0038253 0.0008492 -4.504 6.94e-06 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 0.4811 on 2726 degrees of freedom ## Multiple R-squared: 0.007388, Adjusted R-squared: 0.007024 ## F-statistic: 20.29 on 1 and 2726 DF, p-value: 6.936e-06 年齢（age）の係数はマイナスであり、年齢が1歳高いと、OJTを受けている割合が0.004ポイント（0.4 %ポイント）低いということがわかる。 7.3.3 注意点 分析に先立ち、従属変数とする2値のカテゴリ変数のどちらを1とし、どちらを0とするかは自分であらかじめ決めておいて、数値型に変換しておく必要がある（カテゴリ変数のままでは分析できない）。 なお、従属変数が2値のカテゴリ変数の場合にはロジスティック回帰分析がよく使われる。ただし、今紹介した（ふつうの）回帰分析と比べるとやや解釈が難しい。また上記の（ふつうの）回帰分析を使っても、たいていの場合はそんなに間違った結論にはならないので、学部レベルではこれで十分である。もちろん、関心のある人は積極的にチャレンジしてみてほしい。 7.3.4 （発展）ロバスト標準誤差 上記のように従属変数が2値の場合の線形回帰分析のことを線形確率モデル linear probability modelと呼ぶことがある。線形確率モデルの場合は、誤差が正規分布するという仮定に反し、普通の標準誤差は誤った値になってしまうことが知られている。そこで、こうした不均一分散の問題に対処するために、ロバスト標準誤差を用いることが推奨されている。 ここではロバスト標準誤差のことについてはくわしく説明しないが、推定の仕方だけ書いておく。estimatr::lm_robust()で、ロバスト標準誤差を得ることができる。使い方はこのページにくわしい。まずは、estimatrパッケージを読み込む。 library(estimatr) そのうえで、以下のように、ふつうの回帰分析と同じように実行すればよい。違うのは、関数がlm()ではなくてlm_robust()となっている点だけだ。 reg_res &lt;- lm_robust(data = piaac, ojt ~ gender) summary(reg_res) ## ## Call: ## lm_robust(formula = ojt ~ gender, data = piaac) ## ## Standard error type: HC2 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper DF ## (Intercept) 0.32632 0.01309 24.929 9.569e-124 0.30066 0.3520 2726 ## gender男性 0.08157 0.01840 4.432 9.698e-06 0.04548 0.1177 2726 ## ## Multiple R-squared: 0.007116 , Adjusted R-squared: 0.006751 ## F-statistic: 19.64 on 1 and 2726 DF, p-value: 9.698e-06 7.4 （発展）非線形の関連 7.4.1 対数変換 用いる変数が正規分布から乖離しているときや、変数の単位に依存せず効果の大きさを測定したいときには、変数を対数変換することを検討するとよい。社会科学系では、底がeの対数（自然対数）を取ることで変数を対数変換することが多い。Rではlog()という関数で自然対数変換ができる。次のようにして、賃金を対数変換した変数を作ることができる。 piaac &lt;- piaac %&gt;% mutate(logwage = log(wage)) 2つの変数の分布を比較してみよう。 piaac %&gt;% ggplot(aes(x = wage)) + geom_histogram() ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. piaac %&gt;% ggplot(aes(x = logwage)) + geom_histogram() ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`. 対数変換した後の変数は、対数変換する前の変数よりも正規分布に近づいていることがわかる。 7.4.1.1 自然対数と対数関数について \\[ e = \\lim_{t\\rightarrow0}(1 + t)^{\\frac{1}{t}} \\simeq 2.7182818\\cdots \\] で定義される数のことをネイピア数といい、\\(e\\)と書く（円周率\\(\\pi\\)みたいな感じ）。慣習上、ネイピア数\\(e\\)を底とする指数\\(e^x\\)を\\(\\exp(x)\\)と表記したりする。 \\(\\log_a x\\)のように表される関数を対数関数といい、次のように定義される： \\[ a^y = x \\leftrightarrow y = \\log_a x \\] とくに底が\\(e\\)の場合を自然対数という。社会科学系の文脈ではこのときには底を省略して、\\(e^y = x \\leftrightarrow y = \\log(x)\\)というふうに書かれることが多い。 7.4.1.2 対数を使った場合の回帰分析 先にみたように、数的思考力スコアと対数賃金の散布図を書くと、次のようになる。 piaac %&gt;% ggplot(aes(x = numeracy, y = logwage)) + geom_point(shape = 1) + geom_smooth(method = &quot;lm&quot;, se = FALSE) ## `geom_smooth()` using formula &#39;y ~ x&#39; 対数変換した後の賃金を従属変数として、回帰分析を推定してみよう。 reg_res &lt;- lm(data = piaac, logwage ~ numeracy) summary(reg_res) ## ## Call: ## lm(formula = logwage ~ numeracy, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -1.31652 -0.39318 -0.05807 0.33222 2.14472 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 6.0351509 0.0688414 87.67 &lt;2e-16 *** ## numeracy 0.0043809 0.0002311 18.95 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 0.518 on 2726 degrees of freedom ## Multiple R-squared: 0.1164, Adjusted R-squared: 0.1161 ## F-statistic: 359.3 on 1 and 2726 DF, p-value: &lt; 2.2e-16 なお、対数変換した変数を新たに作成しなくても、次のように書くことで、回帰分析のコード中で対数変換を行う事ができる。以下でも同じ結果を得ることができる（結果は省略）。 lm(data = piaac, log(wage) ~ age) numeracyの係数は、数的思考力スコアが1ポイント高いと、対数賃金が0.004ポイント高いということを意味する。対数をとった場合、（微小な）変化は%の変化に一致する（後述）。すなわち、数的思考力スコアが1歳高いと、賃金が0.4%高いということを意味している。 7.4.1.3 対数を使った場合の回帰分析：なぜ%になるのか 以下のような単回帰分析について考える。 \\[ y = \\beta_0 + \\beta_1x \\] このとき、\\(x\\)を1単位増やしたときの\\(y\\)の変化分を\\(\\Delta y\\)と表すことにする。すると \\[ \\begin{align} y + \\Delta y &amp;= \\beta_0 + \\beta_1 (x + 1) \\\\ y + \\Delta y &amp;= (\\beta_0 + \\beta_1 x) + \\beta_1 \\\\ \\Delta y &amp;= \\beta_1 \\\\ \\end{align} \\] \\(\\Delta y = \\beta_1\\)となる。すなわち、\\(\\beta_1\\)は、\\(x\\)を1単位増やしたときに\\(y\\)がどれだけ増えるかに一致する。 では、次のような式のときはどうだろうか？ \\[ \\log(y) = \\beta_0 + \\beta_1x \\] 同じように、\\(x\\)が1単位増えたときの\\(y\\)の変化分を\\(\\Delta y\\)と表すことにする。すると、 \\[ \\begin{aligned} \\log(y + \\Delta y) &amp;= \\beta_0 + \\beta_1(x + 1) \\\\ y + \\Delta y &amp;= \\exp(\\beta_0 + \\beta_1x + \\beta_1) \\\\ y + \\Delta y &amp;= \\exp(\\beta_1)\\exp(\\beta_0 + \\beta_1x) \\\\ y + \\Delta y &amp;= \\exp(\\beta_1)y \\\\ \\Delta y &amp;= (\\exp(\\beta_1) - 1)y \\end{aligned} \\] となり、xが1単位増えたときに\\(y\\)は\\((\\exp(\\beta_1) - 1)\\)倍ぶんだけ増える、ということがわかる。実際の値を計算してみると、次のようになる： \\[ \\begin{align} \\beta_1 &amp;= 0.1 \\leftrightarrow \\exp(\\beta_1) - 1 \\simeq 0.11 \\\\ \\beta_1 &amp;= 0 \\leftrightarrow \\exp(\\beta_1) - 1 \\simeq 0 \\\\ \\beta_1 &amp;= -0.1 \\leftrightarrow \\exp(\\beta_1) - 1\\simeq -0.10 \\\\ \\end{align} \\] \\(\\beta_1\\)が0に近い値ならば、おおむね「\\(x\\)が1単位高いと、\\(y\\)が\\(100 \\times \\beta_1\\)%高い」といえる。 ただし、係数の絶対値が大きくなるほど\\(\\beta_1\\)と\\(\\exp(\\beta_1) - 1\\)のずれが大きくなるという点は頭の片隅に入れておくとよい。図にするとこんな感じで、0から離れるほど点線からずれていく： 従属変数だけではなく、独立変数についても対数を取ることができる。その場合の解釈はそれぞれ次のようになる： 従属変数 独立変数 解釈 \\(y\\) \\(x\\) \\(x\\)が1単位高いと、\\(y\\)が\\(b_1\\)高い \\(\\log(y)\\) \\(x\\) \\(x\\)が1単位高いと、\\(y\\)が\\(100 \\times \\beta_1\\)%高い \\(y\\) \\(\\log(x)\\) \\(x\\)が1%高いと、\\(y\\)が\\(\\beta_1 / 100\\)高い \\(\\log(y)\\) \\(\\log(x)\\) \\(x\\)が1%高いと、\\(y\\)が\\(\\beta_1\\)%高い 7.4.1.4 係数の絶対値が大きい場合の対数の解釈 例えば次のように対数賃金を従属変数、性別を独立変数とする回帰分析を推定してみよう。 reg_res &lt;- lm(data = piaac, logwage ~ gender) summary(reg_res) ## ## Call: ## lm(formula = logwage ~ gender, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -1.40835 -0.35529 -0.07757 0.32873 1.90992 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 7.08073 0.01395 507.5 &lt;2e-16 *** ## gender男性 0.46412 0.01918 24.2 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 0.5 on 2726 degrees of freedom ## Multiple R-squared: 0.1769, Adjusted R-squared: 0.1766 ## F-statistic: 585.7 on 1 and 2726 DF, p-value: &lt; 2.2e-16 gender男性の係数の値は0.464である。この係数は絶対値が大きいため、きちんと\\(\\exp(\\beta_1) - 1\\)を計算してやる必要がある。いろいろな方法があるが、ここでは回帰分析の結果をデータフレームにして扱いやすくするためのパッケージであるbroomパッケージを利用する方法を紹介する。まずは、broomパッケージを読み込もう。 library(broom) broom::tidy()関数を実行することで、回帰分析などのモデルの主要な結果をデータフレーム形式へと変換することができる。それぞれ、1行目が切片の推定結果、2行目が男性ダミーの推定結果である。 reg_res_tidy &lt;- reg_res %&gt;% tidy() reg_res_tidy ## # A tibble: 2 × 5 ## term estimate std.error statistic p.value ## &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 (Intercept) 7.08 0.0140 507. 0 ## 2 gender男性 0.464 0.0192 24.2 2.26e-117 この推定結果に含まれるestimateという列に対して\\((\\exp(\\beta_1) - 1)\\)という計算を施した新しい列を作成すればよい。 reg_res_tidy %&gt;% mutate(estimate_exp = (exp(estimate) - 1)) ## # A tibble: 2 × 6 ## term estimate std.error statistic p.value estimate_exp ## &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 (Intercept) 7.08 0.0140 507. 0 1188. ## 2 gender男性 0.464 0.0192 24.2 2.26e-117 0.591 新しく作成した列のgender男性の値は0.591である。つまり、男性は女性と比べて、59.1%賃金が高いということである。 7.4.2 2次関数型 年齢と賃金がどのような関係にあるかを考えてみたい。年齢と賃金の関係は、たんに年齢が上がると賃金が上がるという線形の関連ではなく、年齢が上がるほど賃金の上昇が緩やかになっていって、ある程度年齢が上がると関係が反転する（負の関係になる）ということが考えられる。2次関数を使うことで、こうした関係をうまく表現できる。 \\[ y = \\beta_0 + \\beta_1x + \\beta_2x^2 \\] 7.4.2.1 係数の読み方 このような場合、\\(x\\)が1単位増加したときの\\(y\\)の増加量は、もともとの\\(x\\)の値によって異なる。\\(x\\)が1単位増えたときの\\(y\\)の変化分を\\(\\Delta y\\)と表すとすると、 \\[ \\begin{align} y + \\Delta y &amp;= \\beta_0 + \\beta_1(x + 1) + \\beta_2 (x + 1)^2 \\\\ &amp;= (\\beta_0 + \\beta_1x + \\beta_2x^2) + \\beta_1 + (2x + 1)\\beta_2 \\\\ \\Delta y &amp;= \\beta_1 + (2x + 1)\\beta_2 \\end{align} \\] となる。すなわち、\\(x\\)が1単位増加したときの\\(y\\)の増加量は、もともとの\\(x\\)の値によって異なるということになる。回帰式の形状や結果の読み方は次のようになる： \\(\\beta_2\\)の係数 解釈 形状 \\(\\beta_2 &lt; 0\\) xが大きいほど、x1単位の増加に対するyの増加量は小さい \\(-\\beta_1/2\\beta_2\\)を底とする、上に凸な2次関数 \\(\\beta_2 &gt; 0\\) xが大きいほど、x1単位の増加に対するyの増加量は大きい \\(-\\beta_1/2\\beta_2\\)を底とする、下に凸な2次関数 7.4.2.2 変数の作成と結果の解釈 年齢を2乗した変数は次のように作成できる。 piaac &lt;- piaac %&gt;% mutate(age_sq = age^2) 回帰分析を行ってみる： reg_res &lt;- lm(data = piaac, logwage ~ age + age_sq) summary(reg_res) ## ## Call: ## lm(formula = logwage ~ age + age_sq, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -1.28557 -0.44715 -0.03263 0.36524 1.95383 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 5.636e+00 1.762e-01 31.98 &lt;2e-16 *** ## age 7.609e-02 8.226e-03 9.25 &lt;2e-16 *** ## age_sq -8.064e-04 9.185e-05 -8.78 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 0.5415 on 2725 degrees of freedom ## Multiple R-squared: 0.03465, Adjusted R-squared: 0.03394 ## F-statistic: 48.91 on 2 and 2725 DF, p-value: &lt; 2.2e-16 二次曲線の場合、個々の係数だけではあまり解釈ができない。そこで、散布図と回帰直線（曲線）をみてみよう： piaac %&gt;% ggplot(aes(x = age, y = logwage)) + geom_point(shape = 1) + geom_smooth(method = &quot;lm&quot;, formula = y ~ poly(x, 2), se = FALSE) このように、若いときには年齢による賃金の上昇は大きいけれども、その上昇幅は年齢が高くなるほど小さくなり、高い年齢ではむしろ負に転ずることがわかる。年齢についてはこのように二次曲線をつかうことはしばしば有効である。 なお2乗した変数を別に作らなくても、回帰分析のコード中で2乗した変数を作成することができる。（結果は省略） lm(data = piaac, log(wage) ~ age + I(age^2)) 7.4.3 回帰分析の結果をきれいに表示する 先ほどの回帰分析の結果をもう少しきれいに表示したいと思うかもしれない。このようなときに活躍するのがmodelsummaryパッケージである。 library(modelsummary) では、実際に使ってみよう。modelsummary(list(model))（modelという部分には、すでに保存しておいた回帰分析の結果を入れる）というのが最低限のコマンド。 reg_res &lt;- lm(data = piaac, log(wage) ~ age) modelsummary(list(reg_res)) Model 1 (Intercept) 7.136 (0.044) age 0.004 (0.001) Num.Obs. 2728 R2 0.007 R2 Adj. 0.007 AIC 4474.4 BIC 4492.1 RMSE 0.55 よく論文でみる感じのきれいな見た目になる。とはいえ、まだたとえば変数名が何を指しているかなどは改善の余地がある。オプションを色々指定することで、よりわかりやすい表が作れる。 modelsummary(list(reg_res), stars = TRUE, # 有意水準を示す印をつける coef_rename = c(&quot;(Intercept)&quot; = &quot;切片&quot;, &quot;age&quot; = &quot;年齢&quot;), # 各変数に名前をつける gof_map = c(&quot;nobs&quot;, &quot;r.squared&quot;) # サンプルサイズと決定係数のみ記載する ) Model 1 切片 7.136*** (0.044) 年齢 0.004*** (0.001) Num.Obs. 2728 R2 0.007 + p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001 このように各変数がそれぞれ何の変数なのか名前をつけてやると、読む人にとって見やすい表になる。 7.5 結果をファイルに書き出す 第5章、第6章と同様、回帰分析についても結果をwordに書き出すことができる。flextableパッケージを読み込んでおいた状態で（この章では冒頭ですでに読み込んでおいた）、上記のmodelsummary()のコードにoutput = \"xxx.docx\"というようなオプションをつけることで、wordファイルに結果を書き出すことができる。 modelsummary(list(reg_res), stars = TRUE, # 有意水準を示す印をつける coef_rename = c(&quot;(Intercept)&quot; = &quot;切片&quot;, &quot;age&quot; = &quot;年齢&quot;), # 各変数に名前をつける gof_map = c(&quot;nobs&quot;, &quot;r.squared&quot;), # サンプルサイズと決定係数のみ記載する output = &quot;results/regression.docx&quot;) # 出力先のファイル名をつける as_flex_table() %&gt;% save_as_docs(path = \"xxx.docx\")を使っていた第5章、第6章とは少し違う点に注意。多少の手直しが必要かもしれないが、きれいな回帰分析の表をWordファイルに書き出すことができる。 "],["regression_advanced.html", "Chapter 8 回帰分析の活用 8.1 重回帰分析 8.2 交絡要因の統制 8.3 媒介分析／要因分解 8.4 回帰分析の実際 8.5 結果をファイルに書き出す", " Chapter 8 回帰分析の活用 本章では、前章で学んだ回帰分析を発展させて、複数の独立変数を扱う方法について説明する。 内容に入る前に、右上のプロジェクトのボックスの横が、前章で作成したプロジェクトの名前（たとえば、seminar_sociology_r）になっているかどうかを確認しておこう。なっていない場合は、右上のボックスをクリックして、「Open Project…」を選択し、前章で作成したRprojファイル（たとえば、seminar_sociology_r.Rprojといったような名前になっている）を選んで、プロジェクトを切り替えよう。 さらに、これまでの章で説明した以下のパッケージを読み込んだ上で、第4章で作成したデータを読み込んでpiaacというデータフレームに入れていることを前提とする。具体的には、以下のコードを実行しておく必要がある。 library(tidyverse) library(gtsummary) library(flextable) library(modelsummary) library(broom) piaac &lt;- read_rds(&quot;data/piaac_sample_analytic.rds&quot;) 第5章で確認したように、ggplotの設定を変更しておくことで見やすいグラフを作ることができる。ここでは以下のコードを実行している。 Macの場合： theme_set(theme_bw( base_family = &quot;HiraginoSans-W3&quot;, base_size = 11, base_rect_size = 0.2, base_line_size = 0.2 )) Windowsの場合： theme_set(theme_bw( base_size = 11, base_rect_size = 0.2, base_line_size = 0.2 )) 8.1 重回帰分析 先の単回帰分析では、年齢、性別、学歴、数的思考力スコアによって賃金が異なっていることをみた。これら4つの変数を同時に考慮することで、賃金の分散をよりよく説明できるモデルを作ることができないだろうか？このようなときに役に立つのが、重回帰分析である。 今推定したい式は次のように書くことができる。 \\[ y = \\beta_0 + \\beta_1年齢 + \\beta_2女性 + \\beta_3高校卒 + \\beta_4短大高専卒 + \\beta_5大学大学院卒 + \\beta_6数的思考力スコア \\] \\(\\beta_1\\)が年齢の係数、\\(\\beta_2\\)が（男性と比較したときの）女性の係数、\\(\\beta_3, \\beta_4, \\beta_5\\)が（中学卒と比較したときの）高校卒、短大高専卒、大学大学院卒の係数を、\\(\\beta_6\\)が数的思考力スコアの係数を、それぞれ表す。各係数は、他の変数を一定として（統制 controlして、ともいう）、当該変数が1単位高いと\\(y\\)がどれだけ高いのか、という独立の影響力を測っていることになる。 単回帰分析のときと同じように、lm()関数を使って推定することができる。ここでは、賃金の測定の際により一般的に使われる、対数変換した賃金（logwage）を用いる。正負の解釈については通常と同じだが、係数の値についての解釈は少しだけ勉強が必要になる。くわしくは前章「対数変換」を参照のこと。 reg_res &lt;- lm(data = piaac, logwage ~ age + gender + educ + numeracy) summary(reg_res) ## ## Call: ## lm(formula = logwage ~ age + gender + educ + numeracy, data = piaac) ## ## Residuals: ## Min 1Q Median 3Q Max ## -1.23602 -0.31230 -0.03953 0.29831 1.89012 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) 5.7551032 0.0833818 69.021 &lt; 2e-16 *** ## age 0.0085794 0.0008344 10.282 &lt; 2e-16 *** ## gender男性 0.3915738 0.0184461 21.228 &lt; 2e-16 *** ## educ高校 0.0784268 0.0347435 2.257 0.0241 * ## educ短大高専 0.1725538 0.0370332 4.659 3.32e-06 *** ## educ大学大学院 0.3395225 0.0380275 8.928 &lt; 2e-16 *** ## numeracy 0.0027443 0.0002375 11.553 &lt; 2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 0.4574 on 2721 degrees of freedom ## Multiple R-squared: 0.3123, Adjusted R-squared: 0.3108 ## F-statistic: 205.9 on 6 and 2721 DF, p-value: &lt; 2.2e-16 それぞれ係数、標準誤差、p値のみかたはいずれも前回と同じである。 一般に、重回帰分析の式は次のように書ける。 \\[ y = \\beta_0 + \\beta_1x_1 + \\beta_2x_2 + \\cdots + \\beta_kx_k \\] 係数\\(\\beta_1\\)は、他の変数\\(x_2, \\cdots, x_k\\)を一定としたうえで、\\(x_1\\)が1単位高いと\\(y\\)がどれだけ高いのかを示す。 重回帰分析の係数はやはり最小二乗法によって推定される。 8.2 交絡要因の統制 8.2.1 交絡とは何か では実際、重回帰分析はどのようなことを知りたいときに使うのだろうか。たとえば、高い数的思考力スコアが高いとどれくらい対数賃金が高くなるのかを知りたいと思ったとする。もっともシンプルな方法が、前回みたように（単）回帰分析を使う方法だ。 しかしこの方法では、数的思考力スコアの効果を知るには不十分である。一つの例を考えよう。たとえば、女性はさまざまな理由から男性と比べて数的思考力スコアが低い傾向がある14。また、女性はさまざまな理由から労働市場で男性と比べて高い賃金を得られていない。だとすれば、数的思考力スコアが高いと賃金が高いというのはたんに見かけ上の関係に過ぎず、実際には数的思考力スコアは何ら賃金を高める効果を持っていないのかもしれない。性別に色分けした以下の散布図を見てみよう。たしかに、数的思考力も高く対数賃金も高い右上には男性が、数的思考力スコアが低く対数賃金も低い左下には女性が、それぞれ集中しているようにみえる。 piaac %&gt;% ggplot(aes(x = numeracy, y = logwage, color = gender)) + geom_point(shape = 1) + labs(color = &quot;&quot;) 性別を一定としたうえで、言い換えれば、性別が同じであったとしてもなお、数的思考力スコアと（対数）賃金の関係をみることができたなら、「数的思考力スコアはどの程度賃金を高める効果を持つのか」という問いの答えに近づくことができる。重回帰分析は、こうしたモチベーションに答えるための方法である。 今の議論を図にすると、次のようなかたちになる。 Xを数的思考力スコア、Yを賃金、Zを性別と考えよう。知りたいのは数的思考力スコアが賃金に与える効果（X → Y）だが、その背後にはXにもYにも影響する要因Z（Z → X、Z → Y）が存在する。そのため、数的思考力スコアが賃金に与える効果をみたいのならば、Zを一定とする必要がある。このように、XとYの両者に影響する要因を交絡要因 confounderとよぶ。 複数の変数を使うときの回帰分析では、関心のある変数xと、統制したい変数zというふうに別々の役割があるということが多い。 8.2.2 結果の比較と解釈 もちろん、両者の背後にある交絡要因は性別だけではないだろう。年齢や学歴も関係しているかもしれない。たとえば学歴はどのように数的思考力スコアと賃金の両者と関係しているだろうか。学歴が高い人は学校での勉強を通じて数的思考力スコアを高めており、学歴が高い人は（本人の能力とは関係なしに）賃金の高い仕事に就けるために、見かけ上数的思考力スコアと賃金に正の関連があるだけかもしれない。 以下では、 単回帰分析 性別を統制した回帰分析 性別に加えてさらに年齢と学歴を統制した回帰分析 を比較しながら、それぞれ数的思考力スコアの係数がどのように変わるのかをみてみよう。 reg_res1 &lt;- lm(data = piaac, logwage ~ numeracy) reg_res2 &lt;- lm(data = piaac, logwage ~ numeracy + gender) reg_res3 &lt;- lm(data = piaac, logwage ~ numeracy + gender + age + educ) modelsummary(list(reg_res1, reg_res2, reg_res3), stars = TRUE, fmt = 4, coef_rename = c(&quot;(Intercept)&quot; = &quot;切片&quot;, &quot;numeracy&quot; = &quot;数的思考力スコア&quot;, &quot;age&quot; = &quot;年齢&quot;, &quot;gender男性&quot; = &quot;男性（vs. 女性）&quot;, &quot;educ高校&quot; = &quot;高校（vs. 中学）&quot;, &quot;educ短大高専&quot; = &quot;短大高専（vs. 中学）&quot;, &quot;educ大学大学院&quot; = &quot;大学大学院（vs. 中学）&quot; ), gof_map = c(&quot;nobs&quot;, &quot;r.squared&quot;)) Model 1 Model 2 Model 3 切片 6.0352*** 6.0424*** 5.7551*** (0.0688) (0.0633) (0.0834) 数的思考力スコア 0.0044*** 0.0036*** 0.0027*** (0.0002) (0.0002) (0.0002) 男性（vs. 女性） 0.4146*** 0.3916*** (0.0185) (0.0184) 年齢 0.0086*** (0.0008) 高校（vs. 中学） 0.0784* (0.0347) 短大高専（vs. 中学） 0.1726*** (0.0370) 大学大学院（vs. 中学） 0.3395*** (0.0380) Num.Obs. 2728 2728 2728 R2 0.116 0.254 0.312 + p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001 なお、この例のように、回帰分析の表を作るときには、カテゴリ変数の比較対象（参照カテゴリ）が何かを書くとわかりやすいだろう。 Model 1、Model 2、Model 3ではそれぞれ数的思考力スコアの係数が違っていることが確認できる。性別を統制したModel 2、さらに年齢と学歴を統制したModel 3では、それぞれ係数が小さくなっていることがわかる。ここからわかることは2つである。第1に、数的思考力スコアと対数賃金との正の関連の一部は、両者の背後にある交絡要因（性別、年齢、学歴）によって生じているということである。第2に、しかしながらこれらの交絡要因を統制してもなお、数的思考力スコアの係数は正でありかつ統計的にも有意である。したがって、性別、年齢、学歴を一定としてもなお、数的思考力スコアが高いほど対数賃金が高いといえる。 もちろん、性別や年齢、学歴だけではなくほかにもさまざまな要因が絡んでくるから、これだけで数的思考力が賃金に与える効果の真の推定値を明らかにしたのだということはできない。しかし、適切に（しかるべき）要因を統制すれば、数的思考力が賃金を高めるという効果の真の推定値に近づいていくことはできる。 8.3 媒介分析／要因分解 女性は男性と比べて賃金が低い（男女間賃金格差がある）のはなぜなのかを知りたいとする。たとえばその原因には、(1) 女性が男性よりも教育水準（学歴）が低い、(2) 女性が男性よりも数的思考力スコアが低い、ということがありえるだろう。このような原因を調べるというときにも、重回帰分析を活用することができる。 性別をX、賃金をY、学歴および数的思考力スコアをMとすると、ここでのアイデアは次のような図に表すことができる。 性別が賃金に与える効果は、(1) 女性の学歴や数的思考力スコアが低く、したがって賃金も低い（X → M → Y）という部分と、(2) 学歴や数的思考力スコアを一定としてもなお女性のほうが賃金が低い（X → Y | M）という部分とに分けることができる。このようにして、XとYの中間にある要因（媒介要因 mediator）を考えることでグループ間の差や独立変数の効果を分けていくことを指して、媒介分析 mediation analysisや要因分解decompositionなどという。 piaac &lt;- piaac %&gt;% mutate(female_d = if_else(gender == &quot;女性&quot;, 1, 0)) reg_res1 &lt;- lm(data = piaac, logwage ~ female_d) reg_res2 &lt;- lm(data = piaac, logwage ~ female_d + educ + numeracy) modelsummary(list(reg_res1, reg_res2), stars = TRUE, coef_rename = c(&quot;(Intercept)&quot; = &quot;切片&quot;, &quot;female_d&quot; = &quot;女性（vs. 男性）&quot;, &quot;educ高校&quot; = &quot;高校（vs. 中学）&quot;, &quot;educ短大高専&quot; = &quot;短大高専（vs. 中学）&quot;, &quot;educ大学大学院&quot; = &quot;大学大学院（vs. 中学）&quot;, &quot;numeracy&quot; = &quot;数的思考力スコア&quot;), gof_map = c(&quot;nobs&quot;, &quot;r.squared&quot;)) Model 1 Model 2 切片 7.545*** 6.658*** (0.013) (0.069) 女性（vs. 男性） −0.464*** −0.391*** (0.019) (0.019) 高校（vs. 中学） 0.047 (0.035) 短大高専（vs. 中学） 0.116** (0.037) 大学大学院（vs. 中学） 0.296*** (0.039) 数的思考力スコア 0.002*** (0.000) Num.Obs. 2728 2728 R2 0.177 0.286 + p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001 Model 1では、女性ダミーの係数は負であるので、女性は男性に比して賃金が低いということがわかる。 Model 2では、学歴と数的思考力スコアを追加している。高校、短大高専、大学大学院の係数はいずれも正であり、学歴が高いほど、賃金は高い傾向がある。また、数的思考力スコアも正であり、数的思考力スコアが高いほど賃金が高い傾向がある。これら学歴と数的思考力スコアを一定とすると、女性ダミーの係数は0となり、Model 1の女性の係数（0）よりも絶対値が小さくなっている（0に近づいている）ことがわかる。ただし係数はなお負で、統計的に有意である。 この結果は次のことを意味している。女性の賃金が低いことの一部は、女性は男性と比べて学歴が低いことや、数的思考力スコアが低いことによって説明できる。しかしながら同時に、これらの個人属性を一定としてもなお、男女間には大きな賃金格差が存在している。 8.4 回帰分析の実際 実際の論文では、交絡要因の統制と媒介分析の両方を考慮しながら分析されることが多い。すなわち、次のような図になる。 たとえば、学歴が高いと賃金が高い（X → Y）のはなぜなのか知りたいとする。その原因の1つとして、学歴が高いとよりスキルレベルが高い（賃金の高い）職業につくことができるから（X → M → Y）、ということが考えられる。実際、学歴別に職業の分布を比べてみると、学歴が高いほど管理職や専門職といったスキルレベルの高い職業に就いている傾向があることがわかる。 piaac %&gt;% tbl_cross(educ, occupation, percent = &quot;row&quot;) html { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif; } #xyefkuwkrd .gt_table { display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; } #xyefkuwkrd .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #xyefkuwkrd .gt_title { color: #333333; font-size: 125%; font-weight: initial; padding-top: 4px; padding-bottom: 4px; border-bottom-color: #FFFFFF; border-bottom-width: 0; } #xyefkuwkrd .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 0; padding-bottom: 6px; border-top-color: #FFFFFF; border-top-width: 0; } #xyefkuwkrd .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #xyefkuwkrd .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; } #xyefkuwkrd .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; } #xyefkuwkrd .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; } #xyefkuwkrd .gt_column_spanner_outer:first-child { padding-left: 0; } #xyefkuwkrd .gt_column_spanner_outer:last-child { padding-right: 0; } #xyefkuwkrd .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 5px; overflow-x: hidden; display: inline-block; width: 100%; } #xyefkuwkrd .gt_group_heading { padding: 8px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; } #xyefkuwkrd .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: middle; } #xyefkuwkrd .gt_from_md > :first-child { margin-top: 0; } #xyefkuwkrd .gt_from_md > :last-child { margin-bottom: 0; } #xyefkuwkrd .gt_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; } #xyefkuwkrd .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 12px; } #xyefkuwkrd .gt_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #xyefkuwkrd .gt_first_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; } #xyefkuwkrd .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; } #xyefkuwkrd .gt_first_grand_summary_row { padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; } #xyefkuwkrd .gt_striped { background-color: rgba(128, 128, 128, 0.05); } #xyefkuwkrd .gt_table_body { border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; } #xyefkuwkrd .gt_footnotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #xyefkuwkrd .gt_footnote { margin: 0px; font-size: 90%; padding: 4px; } #xyefkuwkrd .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; } #xyefkuwkrd .gt_sourcenote { font-size: 90%; padding: 4px; } #xyefkuwkrd .gt_left { text-align: left; } #xyefkuwkrd .gt_center { text-align: center; } #xyefkuwkrd .gt_right { text-align: right; font-variant-numeric: tabular-nums; } #xyefkuwkrd .gt_font_normal { font-weight: normal; } #xyefkuwkrd .gt_font_bold { font-weight: bold; } #xyefkuwkrd .gt_font_italic { font-style: italic; } #xyefkuwkrd .gt_super { font-size: 65%; } #xyefkuwkrd .gt_footnote_marks { font-style: italic; font-weight: normal; font-size: 65%; } Characteristic occupation Total 管理職 専門職 技術職・准専門職 事務補助 サービス・販売 農林漁業 技能工 設備・機械運転・組立 単純作業 educ 中学 7 (3.1%) 2 (0.9%) 12 (5.3%) 18 (8.0%) 48 (21%) 9 (4.0%) 52 (23%) 40 (18%) 38 (17%) 226 (100%) 高校 48 (5.1%) 27 (2.8%) 114 (12%) 177 (19%) 266 (28%) 7 (0.7%) 120 (13%) 125 (13%) 64 (6.8%) 948 (100%) 短大高専 31 (4.6%) 123 (18%) 114 (17%) 121 (18%) 173 (25%) 4 (0.6%) 63 (9.3%) 24 (3.5%) 28 (4.1%) 681 (100%) 大学大学院 133 (15%) 267 (31%) 199 (23%) 123 (14%) 89 (10%) 5 (0.6%) 30 (3.4%) 18 (2.1%) 9 (1.0%) 873 (100%) Total 219 (8.0%) 419 (15%) 439 (16%) 439 (16%) 576 (21%) 25 (0.9%) 265 (9.7%) 207 (7.6%) 139 (5.1%) 2,728 (100%) 先に確認したように、学歴と賃金の間には性別や年齢といった交絡要因が存在する（Z → X, Z → Y）。なので、あらかじめこれらを統制しておいたうえで、学歴による賃金の差が職業の違いによってどの程度説明されるのかというのをみる必要がある。 実際の分析結果は次のようになる。賃金については実額よりも対数を取った値のほうがよく使われるので、従属変数は対数賃金とする。また賃金を従属変数とする回帰分析の場合、年齢の2乗も考慮することが多いので、2乗項についても投入しよう。 reg_res1 &lt;- lm(data = piaac, logwage ~ educ + gender + age + I(age^2)) reg_res2 &lt;- lm(data = piaac, logwage ~ educ + gender + age + I(age^2) + occupation) modelsummary(list(reg_res1, reg_res2), stars = TRUE, coef_rename = c(&quot;(Intercept)&quot; = &quot;切片&quot;, &quot;gender男性&quot; = &quot;男性（vs. 女性）&quot;, &quot;educ高校&quot; = &quot;高校（vs. 中学）&quot;, &quot;educ短大高専&quot; = &quot;短大高専（vs. 中学）&quot;, &quot;educ大学大学院&quot; = &quot;大学大学院（vs. 中学）&quot;, &quot;age&quot; = &quot;年齢&quot;, &quot;I(age^2)&quot; = &quot;年齢2乗&quot;, &quot;occupation専門職&quot; = &quot;専門職（vs. 管理職）&quot;, &quot;occupation技術職・准専門職&quot; = &quot;技術職・准専門職（vs. 管理職）&quot;, &quot;occupation事務補助&quot; = &quot;事務補助（vs. 管理職）&quot;, &quot;occupationサービス・販売&quot; = &quot;サービス・販売（vs. 管理職）&quot;, &quot;occupation農林漁業&quot; = &quot;農林漁業（vs. 管理職）&quot;, &quot;occupation技能工&quot; = &quot;技能工（vs. 管理職）&quot;, &quot;occupation設備・機械運転・組立&quot; = &quot;設備・機械運転・組立（vs. 管理職）&quot;, &quot;occupation単純作業&quot; = &quot;単純作業（vs. 管理職）&quot;), gof_map = c(&quot;nobs&quot;, &quot;r.squared&quot;)) Model 1 Model 2 切片 5.049*** 6.153*** (0.151) (0.150) 高校（vs. 中学） 0.116*** 0.048 (0.034) (0.032) 短大高専（vs. 中学） 0.221*** 0.059+ (0.037) (0.035) 大学大学院（vs. 中学） 0.477*** 0.203*** (0.035) (0.035) 男性（vs. 女性） 0.416*** 0.345*** (0.018) (0.019) 年齢 0.079*** 0.059*** (0.007) (0.007) 年齢2乗 −0.001*** −0.001*** (0.000) (0.000) 専門職（vs. 管理職） −0.196*** (0.037) 技術職・准専門職（vs. 管理職） −0.340*** (0.036) 事務補助（vs. 管理職） −0.491*** (0.038) サービス・販売（vs. 管理職） −0.660*** (0.037) 農林漁業（vs. 管理職） −0.683*** (0.090) 技能工（vs. 管理職） −0.577*** (0.041) 設備・機械運転・組立（vs. 管理職） −0.609*** (0.043) 単純作業（vs. 管理職） −0.745*** (0.049) Num.Obs. 2728 2728 R2 0.305 0.418 + p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001 年齢と性別を統制したうえでの学歴の係数が、職業を考慮することによってどの程度変わるのかをみる。これをみると、Model 1と比べて、職業を一定としたModel 2では学歴の係数がかなり小さくなる。学歴が高いと賃金が高いという関連のかなりの部分が、職業分布の違いによって生じているようだということを、2つのモデルの学歴の係数の違いから読み取ることができる。 このように、回帰分析を使う際には、どのような効果を知りたいのかを意識して、何を交絡要因として統制すべきなのか、何を媒介要因と位置づけるのかを考えながら分析することが大事である。 従属変数に対数を用いた場合には、係数の大きさが実質的にどれくらいであるのかを\\(\\exp(\\beta) - 1\\)を計算して求めるとよい。くわしくは前章を参照のこと。broom::tidy()を用いることで、この計算をスムーズに行うことができる。先のModel 2の結果を変換してみよう。 reg_res2 %&gt;% tidy() %&gt;% mutate(estimate_exp = exp(estimate) - 1) ## # A tibble: 15 × 6 ## term estimate std.error statistic p.value estimate_exp ## &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 (Intercept) 6.15e+0 0.150 41.1 1.31e-287 469. ## 2 educ高校 4.84e-2 0.0323 1.50 1.34e- 1 0.0496 ## 3 educ短大高専 5.94e-2 0.0349 1.71 8.83e- 2 0.0612 ## 4 educ大学大学院 2.03e-1 0.0354 5.73 1.12e- 8 0.225 ## 5 gender男性 3.45e-1 0.0190 18.2 1.35e- 69 0.411 ## 6 age 5.90e-2 0.00652 9.06 2.50e- 19 0.0608 ## 7 I(age^2) -6.10e-4 0.0000729 -8.37 9.03e- 17 -0.000610 ## 8 occupation専門職 -1.96e-1 0.0366 -5.36 9.13e- 8 -0.178 ## 9 occupation技術職・准専門… -3.40e-1 0.0358 -9.51 4.24e- 21 -0.288 ## 10 occupation事務補助 -4.91e-1 0.0380 -12.9 3.85e- 37 -0.388 ## 11 occupationサービス・販売 -6.60e-1 0.0366 -18.0 1.12e- 68 -0.483 ## 12 occupation農林漁業 -6.83e-1 0.0903 -7.56 5.39e- 14 -0.495 ## 13 occupation技能工 -5.77e-1 0.0406 -14.2 3.33e- 44 -0.438 ## 14 occupation設備・機械運転… -6.09e-1 0.0430 -14.2 6.46e- 44 -0.456 ## 15 occupation単純作業 -7.45e-1 0.0489 -15.2 2.25e- 50 -0.525 この結果は、例えば学歴（とくに大学大学院卒）の結果であれば、性別・年齢・職業を一定としてもなお、大学大学院卒の人は中学卒の人と比べて22.5%賃金が高いということを意味している。 8.5 結果をファイルに書き出す 前章の結果をファイルに書き出すを参照。念のため、再確認しておくと、 flextableパッケージを読みこんでおいた状態で、上記のmodelsummary()のコードにoutput = \"xxx.docx\"というようなオプションをつけることで、wordファイルに結果を書き出すことができる。 modelsummary(list(reg_res1, reg_res2), stars = TRUE, coef_rename = c(&quot;(Intercept)&quot; = &quot;切片&quot;, &quot;gender男性&quot; = &quot;男性（vs. 女性）&quot;, &quot;educ高校&quot; = &quot;高校（vs. 中学）&quot;, &quot;educ短大高専&quot; = &quot;短大高専（vs. 中学）&quot;, &quot;educ大学大学院&quot; = &quot;大学大学院（vs. 中学）&quot;, &quot;age&quot; = &quot;年齢&quot;, &quot;I(age^2)&quot; = &quot;年齢2乗&quot;, &quot;occupation専門職&quot; = &quot;専門職（vs. 管理職）&quot;, &quot;occupation技術職・准専門職&quot; = &quot;技術職・准専門職（vs. 管理職）&quot;, &quot;occupation事務補助&quot; = &quot;事務補助（vs. 管理職）&quot;, &quot;occupationサービス・販売&quot; = &quot;サービス・販売（vs. 管理職）&quot;, &quot;occupation農林漁業&quot; = &quot;農林漁業（vs. 管理職）&quot;, &quot;occupation技能工&quot; = &quot;技能工（vs. 管理職）&quot;, &quot;occupation設備・機械運転・組立&quot; = &quot;設備・機械運転・組立（vs. 管理職）&quot;, &quot;occupation単純作業&quot; = &quot;単純作業（vs. 管理職）&quot;), gof_map = c(&quot;nobs&quot;, &quot;r.squared&quot;), output = &quot;results/regression_multiple.docx&quot;) ところで、上記の表のように独立変数が増えてくると、なんだか表が縦に長くて見にくいなあと思うかもしれない。そうした場には、次のように書くことで、標準誤差の値を係数の右側に並べて表記でき、表の縦の長さを短くできる。 modelsummary(list(reg_res1, reg_res2), estimate = &quot;{estimate} ({std.error}){stars}&quot;, # 係数（半角スペース）(標準誤差)星印、となるように表記するオプション statistic = NULL, #「2行目」の表記を省略するオプション。 coef_rename = c(&quot;(Intercept)&quot; = &quot;切片&quot;, &quot;gender男性&quot; = &quot;男性（vs. 女性）&quot;, &quot;educ高校&quot; = &quot;高校（vs. 中学）&quot;, &quot;educ短大高専&quot; = &quot;短大高専（vs. 中学）&quot;, &quot;educ大学大学院&quot; = &quot;大学大学院（vs. 中学）&quot;, &quot;age&quot; = &quot;年齢&quot;, &quot;I(age^2)&quot; = &quot;年齢2乗&quot;, &quot;occupation専門職&quot; = &quot;専門職（vs. 管理職）&quot;, &quot;occupation技術職・准専門職&quot; = &quot;技術職・准専門職（vs. 管理職）&quot;, &quot;occupation事務補助&quot; = &quot;事務補助（vs. 管理職）&quot;, &quot;occupationサービス・販売&quot; = &quot;サービス・販売（vs. 管理職）&quot;, &quot;occupation農林漁業&quot; = &quot;農林漁業（vs. 管理職）&quot;, &quot;occupation技能工&quot; = &quot;技能工（vs. 管理職）&quot;, &quot;occupation設備・機械運転・組立&quot; = &quot;設備・機械運転・組立（vs. 管理職）&quot;, &quot;occupation単純作業&quot; = &quot;単純作業（vs. 管理職）&quot;), gof_map = c(&quot;nobs&quot;, &quot;r.squared&quot;) ) Model 1 Model 2 切片 5.049 (0.151)*** 6.153 (0.150)*** 高校（vs. 中学） 0.116 (0.034)*** 0.048 (0.032) 短大高専（vs. 中学） 0.221 (0.037)*** 0.059 (0.035)+ 大学大学院（vs. 中学） 0.477 (0.035)*** 0.203 (0.035)*** 男性（vs. 女性） 0.416 (0.018)*** 0.345 (0.019)*** 年齢 0.079 (0.007)*** 0.059 (0.007)*** 年齢2乗 −0.001 (0.000)*** −0.001 (0.000)*** 専門職（vs. 管理職） −0.196 (0.037)*** 技術職・准専門職（vs. 管理職） −0.340 (0.036)*** 事務補助（vs. 管理職） −0.491 (0.038)*** サービス・販売（vs. 管理職） −0.660 (0.037)*** 農林漁業（vs. 管理職） −0.683 (0.090)*** 技能工（vs. 管理職） −0.577 (0.041)*** 設備・機械運転・組立（vs. 管理職） −0.609 (0.043)*** 単純作業（vs. 管理職） −0.745 (0.049)*** Num.Obs. 2728 2728 R2 0.305 0.418 もちろん、結果をwordファイルに出力するときには、今までと同様、outputオプションをつける。 "],["domain.html", "Chapter 9 社会学のデータ分析でよくある処理 9.1 SSM職業小分類を大分類にまとめる 9.2 旧制学歴と新制学歴の対応 9.3 年収と労働時間から時間給を作成する 9.4 都道府県変数の加工", " Chapter 9 社会学のデータ分析でよくある処理 本章では、日本の社会学業界を念頭においたときのデータ分析でよくある処理についてランダムにまとめる。ただし内容には麦山の経験と好みが反映されており、業界で標準的な手続きなのかどうかはわからない。 本章のコードを実行するためには以下のパッケージをあらかじめ読み込んでおく必要がある。 library(tidyverse) 9.1 SSM職業小分類を大分類にまとめる いくつかの調査では、調査対象者に仕事の内容を自由記述で尋ね、その回答をもとに、職業名を割り当てているものがある。このときに使われる職業分類が1995年SSM職業小分類と呼ばれるものである。1995年SSM職業小分類は約200の小分類からなり、それぞれの職業に番号が振られている。この番号を振った調査を以下に列挙する。 調査名 調査年 現職職業小分類 初職職業小分類 前職職業小分類 15歳時父親職業小分類 15歳時母親職業小分類 社会階層と社会移動調査（SSM） 1995 有 有 有（職歴変数を使えば可能、今回は省略） 有（「主な仕事」） 有（「主な仕事」） 2005 有 有 有（職歴変数を使えば可能、今回は省略） 有 有 2015 有 有 有（職歴変数を使えば可能、今回は省略） 有 有 日本版総合的社会調査（JGSS） 2000 有 有 有（無職で就業経験ある者のみ） 有 2001 有 有 有（無職で就業経験ある者のみ） 有 2002 有 有 有（無職で就業経験ある者のみ） 有 2003 有 有 2005 有 有 有 2006 有 有 有 2008 有 有 有 2010 有 有 有 2012 有 有 有（無職で就業経験ある者のみ） 有 2015 有 有 有（無職で就業経験ある者のみ） 有 東大社研パネル調査（JLPS） 2007-2020 有 有 有 有 ふつうはこうした200個近い分類をそのまま分析に使うということはなく、少数のカテゴリにまとめて使う。カテゴリへのまとめ方はいくつも種類があるが、ここでは代表的なものとして「SSM職業大分類」と「国勢調査職業分類」の2つを準備する。 なおこの2つへの割当てについては麦山が作成したが、妥当かどうかは各自確認すること。700番台、800番台にも有効なコードを振っている。また888や8888（非該当）、999や9999（無回答）はNAとなるようにしている。 9.1.1 JGSSの場合 たとえばこのようなデータフレーム（jgssとする）があったとする。 jgss %&gt;% head() ## # A tibble: 4 × 4 ## xxjob xxlstjb xxfstjb ppjbxx15 ## &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 509 888 573 531 ## 2 606 888 571 999 ## 3 554 888 558 681 ## 4 999 556 559 588 次のようなコードを実行することで、現職、初職、前職、父職のそれぞれに対して2種類の職業大分類を付与することができる。前職に関する質問項目が含まれていない場合には、前職に関わる部分のコードを削除する必要がある。 また、読み込んだデータ形式によっては変数名が大文字のことがある（xxjobではなくXXJOBというように）。このような場合は手持ちのデータの変数名を小文字に変換するか、以下のコードのxxjobなどを大文字に直すかどちらかを行う必要がある。 ssm_code &lt;- read_csv(&quot;https://raw.githubusercontent.com/mugiyama/seminar_sociology_r/master/data/ssm_occupation_code.csv&quot;) ## Rows: 206 Columns: 3 ## ── Column specification ──────────────────────────────────────────────────────── ## Delimiter: &quot;,&quot; ## dbl (3): ssm1995, ssmocc, censusocc ## ## ℹ Use `spec()` to retrieve the full column specification for this data. ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. ssm_code_current &lt;- ssm_code %&gt;% rename(xxjob = 1, ssmocc_current = 2, censusocc_current = 3) ssm_code_first &lt;- ssm_code %&gt;% rename(xxfstjb = 1, ssmocc_first = 2, censusocc_first = 3) ssm_code_last &lt;- ssm_code %&gt;% rename(xxlstjb = 1, ssmocc_last = 2, censusocc_last = 3) # 前職が含まれていないJGSSデータの場合は削除 ssm_code_father &lt;- ssm_code %&gt;% rename(ppjbxx15 = 1, ssmocc_father = 2, censusocc_father = 3) label_ssm &lt;- c(&quot;専門&quot;,&quot;管理&quot;,&quot;事務&quot;,&quot;販売&quot;,&quot;熟練&quot;,&quot;半熟練&quot;,&quot;非熟練&quot;,&quot;農業&quot;) label_census &lt;- c(&quot;専門・技術&quot;,&quot;管理&quot;,&quot;事務&quot;,&quot;販売&quot;,&quot;サービス&quot;,&quot;保安&quot;,&quot;農林漁業&quot;,&quot;運輸・通信&quot;,&quot;製造・制作&quot;,&quot;定置機関運転・建設機械運転・電気作業&quot;,&quot;採掘・建設・労務&quot;) jgss &lt;- jgss %&gt;% left_join(ssm_code_current, by = &quot;xxjob&quot;) %&gt;% left_join(ssm_code_first, by = &quot;xxfstjb&quot;) %&gt;% left_join(ssm_code_last, by = &quot;xxlstjb&quot;) %&gt;% # 前職が含まれていないJGSSデータの場合は削除 left_join(ssm_code_father, by = &quot;ppjbxx15&quot;) %&gt;% mutate(ssmocc_current_name = factor(ssmocc_current, levels = 1:8, labels = label_ssm)) %&gt;% mutate(ssmocc_first_name = factor(ssmocc_first, levels = 1:8, labels = label_ssm)) %&gt;% mutate(ssmocc_last_name = factor(ssmocc_last, levels = 1:8, labels = label_ssm)) %&gt;% # 前職が含まれていないJGSSデータの場合は削除 mutate(ssmocc_father_name = factor(ssmocc_father, levels = 1:8, labels = label_ssm)) %&gt;% mutate(censusocc_current_name = factor(censusocc_current, levels = 1:11, labels = label_census)) %&gt;% mutate(censusocc_first_name = factor(censusocc_first, levels = 1:11, labels = label_census)) %&gt;% mutate(censusocc_last_name = factor(censusocc_last, levels = 1:11, labels = label_census)) %&gt;% # 前職が含まれていないJGSSデータの場合は削除 mutate(censusocc_father_name = factor(censusocc_father, levels = 1:11, labels = label_census)) もともとの変数と作成した変数の一覧を確認しておく。 jgss %&gt;% glimpse() ## Rows: 4 ## Columns: 20 ## $ xxjob &lt;dbl&gt; 509, 606, 554, 999 ## $ xxlstjb &lt;dbl&gt; 888, 888, 888, 556 ## $ xxfstjb &lt;dbl&gt; 573, 571, 558, 559 ## $ ppjbxx15 &lt;dbl&gt; 531, 999, 681, 588 ## $ ssmocc_current &lt;dbl&gt; 1, 6, 3, NA ## $ censusocc_current &lt;dbl&gt; 1, 8, 3, NA ## $ ssmocc_first &lt;dbl&gt; 4, 4, 3, 3 ## $ censusocc_first &lt;dbl&gt; 4, 4, 3, 3 ## $ ssmocc_last &lt;dbl&gt; NA, NA, NA, 3 ## $ censusocc_last &lt;dbl&gt; NA, NA, NA, 3 ## $ ssmocc_father &lt;dbl&gt; 1, NA, 5, 4 ## $ censusocc_father &lt;dbl&gt; 1, NA, 14, 5 ## $ ssmocc_current_name &lt;fct&gt; 専門, 半熟練, 事務, NA ## $ ssmocc_first_name &lt;fct&gt; 販売, 販売, 事務, 事務 ## $ ssmocc_last_name &lt;fct&gt; NA, NA, NA, 事務 ## $ ssmocc_father_name &lt;fct&gt; 専門, NA, 熟練, 販売 ## $ censusocc_current_name &lt;fct&gt; 専門・技術, 運輸・通信, 事務, NA ## $ censusocc_first_name &lt;fct&gt; 販売, 販売, 事務, 事務 ## $ censusocc_last_name &lt;fct&gt; NA, NA, NA, 事務 ## $ censusocc_father_name &lt;fct&gt; 専門・技術, NA, NA, サービス 9.1.2 SSMの場合 たとえばこのようなデータフレーム（ssmとする）があったとする。 ssm %&gt;% head() ## # A tibble: 4 × 4 ## q02d q07f q23_1d q23_3d ## &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 608 539 601 531 ## 2 597 687 655 999 ## 3 588 631 554 681 ## 4 999 665 545 588 次のようなコードを実行することで、現職、初職、前職、父職のそれぞれに対して2種類の職業大分類を付与することができる。前職に関する質問項目が含まれていない場合には、前職に関わる部分のコードを削除する必要がある。 ssm_code &lt;- read_csv(&quot;https://github.com/mugiyama/seminar_sociology_r/raw/master/data/ssm_occupation_code.csv&quot;) ## Rows: 206 Columns: 3 ## ── Column specification ──────────────────────────────────────────────────────── ## Delimiter: &quot;,&quot; ## dbl (3): ssm1995, ssmocc, censusocc ## ## ℹ Use `spec()` to retrieve the full column specification for this data. ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. ssm_code_current &lt;- ssm_code %&gt;% rename(q02d = 1, ssmocc_current = 2, censusocc_current = 3) ssm_code_first &lt;- ssm_code %&gt;% rename(q07f = 1, ssmocc_first = 2, censusocc_first = 3) ssm_code_father &lt;- ssm_code %&gt;% rename(q23_1d = 1, ssmocc_father = 2, censusocc_father = 3) ssm_code_mother &lt;- ssm_code %&gt;% rename(q23_3d = 1, ssmocc_mother = 2, censusocc_mother = 3) label_ssm &lt;- c(&quot;専門&quot;,&quot;管理&quot;,&quot;事務&quot;,&quot;販売&quot;,&quot;熟練&quot;,&quot;半熟練&quot;,&quot;非熟練&quot;,&quot;農業&quot;) label_census &lt;- c(&quot;専門・技術&quot;,&quot;管理&quot;,&quot;事務&quot;,&quot;販売&quot;,&quot;サービス&quot;,&quot;保安&quot;,&quot;農林漁業&quot;,&quot;運輸・通信&quot;,&quot;製造・制作&quot;,&quot;定置機関運転・建設機械運転・電気作業&quot;,&quot;採掘・建設・労務&quot;) ssm &lt;- ssm %&gt;% left_join(ssm_code_current, by = &quot;q02d&quot;) %&gt;% left_join(ssm_code_first, by = &quot;q07f&quot;) %&gt;% left_join(ssm_code_father, by = &quot;q23_1d&quot;) %&gt;% left_join(ssm_code_mother, by = &quot;q23_3d&quot;) %&gt;% mutate(ssmocc_current_name = factor(ssmocc_current, levels = 1:8, labels = label_ssm)) %&gt;% mutate(ssmocc_first_name = factor(ssmocc_first, levels = 1:8, labels = label_ssm)) %&gt;% mutate(ssmocc_father_name = factor(ssmocc_father, levels = 1:8, labels = label_ssm)) %&gt;% mutate(ssmocc_mother_name = factor(ssmocc_mother, levels = 1:8, labels = label_ssm)) %&gt;% mutate(censusocc_current_name = factor(censusocc_current, levels = 1:11, labels = label_census)) %&gt;% mutate(censusocc_first_name = factor(censusocc_first, levels = 1:11, labels = label_census)) %&gt;% mutate(censusocc_father_name = factor(censusocc_father, levels = 1:11, labels = label_census)) %&gt;% mutate(censusocc_mother_name = factor(censusocc_mother, levels = 1:11, labels = label_census)) もともとの変数と作成した変数の一覧を確認しておく。 ssm %&gt;% glimpse() ## Rows: 4 ## Columns: 20 ## $ q02d &lt;dbl&gt; 608, 597, 588, 999 ## $ q07f &lt;dbl&gt; 539, 687, 631, 665 ## $ q23_1d &lt;dbl&gt; 601, 655, 554, 545 ## $ q23_3d &lt;dbl&gt; 531, 999, 681, 588 ## $ ssmocc_current &lt;dbl&gt; 2, 3, 4, NA ## $ censusocc_current &lt;dbl&gt; 8, 6, 5, NA ## $ ssmocc_first &lt;dbl&gt; 1, 7, 5, 5 ## $ censusocc_first &lt;dbl&gt; 1, 15, 11, 12 ## $ ssmocc_father &lt;dbl&gt; 8, 5, 3, 2 ## $ censusocc_father &lt;dbl&gt; 7, 12, 3, 2 ## $ ssmocc_mother &lt;dbl&gt; 1, NA, 5, 4 ## $ censusocc_mother &lt;dbl&gt; 1, NA, 14, 5 ## $ ssmocc_current_name &lt;fct&gt; 管理, 事務, 販売, NA ## $ ssmocc_first_name &lt;fct&gt; 専門, 非熟練, 熟練, 熟練 ## $ ssmocc_father_name &lt;fct&gt; 農業, 熟練, 事務, 管理 ## $ ssmocc_mother_name &lt;fct&gt; 専門, NA, 熟練, 販売 ## $ censusocc_current_name &lt;fct&gt; 運輸・通信, 保安, サービス, NA ## $ censusocc_first_name &lt;fct&gt; 専門・技術, NA, 採掘・建設・労務, NA ## $ censusocc_father_name &lt;fct&gt; 農林漁業, NA, 事務, 管理 ## $ censusocc_mother_name &lt;fct&gt; 専門・技術, NA, NA, サービス 9.2 旧制学歴と新制学歴の対応 広い年齢層を対象にした調査であったり、親の最終学歴を尋ねているような調査では、最終学歴の選択肢に戦前に卒業した人（旧制学歴保有者）が含まれていることがあり、質問項目の選択肢にも旧制学歴が含まれていることがある。こうした旧制学歴を戦後の新制学歴に合わせたい場合には、諸説あるが、たとえばもっとも教育年数の近い学歴に割り当てるという方法がある。 このような割り当てによる統合学歴の対応表を以下の3パターンにまとめた。 旧制学歴 新制学歴 統合学歴（5分類） 統合学歴（4分類） 統合学歴（3分類） 旧制尋常小学校 新制中学校 中学 中学 初等教育 旧制高等小学校 新制中学校 中学 中学 初等教育 旧制中学校・高等女学校 新制高校 高校 高校 中等教育 旧制実業学校 新制高校 高校 高校 中等教育 - 専修学校高等課程* 高校 高校 中等教育 - 専門学校（専修学校専門課程）* 専門学校 高校 高等教育** 旧制師範学校 新制短大・高専 短大高専 短大高専 高等教育 旧制高校・専門学校・高等師範学校 新制短大・高専 短大高専 短大高専 高等教育 旧制大学 新制大学 大学大学院 大学大学院 高等教育 旧制大学 新制大学院 大学大学院 大学大学院 高等教育 *専修学校高等課程は中学卒業者を対象として職業教育を実施する機関。専修学校専門課程は高校卒業者を対象として職業教育を実施する機関で、ふつう「専門学校」というときにはこちらを指すことが多い。調査票の選択肢に「専門学校」が設けられていた場合も、対象者はおそらくこちらを想定していると思われる。 **国際標準教育分類（ISCED2011）では専門学校はレベル5（Short-cycle tertiary education）に分類され高等教育相当となっている。しかし、伝統的に（？）高等教育に含まないこともある。これに関しては込み入った議論がある。例えば多喜弘文，2018，「学歴としての専門学校に関する基礎的検討」中澤渉編『2015年SSM研究報告書5 教育II』2015年SSM調査研究会，57–80．などを参照のこと。 9.3 年収と労働時間から時間給を作成する 労働から得られる報酬を測定する場合、個人年収というのは必ずしも適切な指標ではないことがある。というのも、人によって労働時間の長さは違うので、同じ年収であったとしても、労働時間が短い人のほうがよりその報酬は高いと考えられるからだ。 そこで、年収を1時間あたりの年収（時間給）に直し、それを分析に用いることがある。いま、2005年SSM調査のデータを持っているとする（数値は架空例）。 変数 説明 q02f_w 週あたり労働時間。無回答の場合には9という値が入っている。 q02f_m 月あたり労働時間（週の労働時間を回答している場合は回答しない）。無回答の場合には99という値が入っている。 q02f_d 1日の労働時間 q33a 個人年収を区間（単位：万円）で尋ねた項目 ssm %&gt;% head() ## # A tibble: 6 × 4 ## q02f_d q02f_w q02f_m q33a ## &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 8 5 99 3 ## 2 4 4 99 5 ## 3 10 99 20 12 ## 4 9 99 15 9 ## 5 12 5 99 10 ## 6 5 1 99 4 このデータに対して以下のコードを実行することで、時間あたり賃金の変数wageを計算することができる。 ssm &lt;- ssm %&gt;% mutate(income = case_when( q33a == 1 ~ 0, q33a == 2 ~ 12.5, q33a == 3 ~ 37.5, q33a == 4 ~ 62.5, q33a == 5 ~ 87.5, q33a == 6 ~ 112.5, q33a == 7 ~ 137.5, q33a == 8 ~ 175, q33a == 9 ~ 225, q33a == 10 ~ 275, q33a == 11 ~ 325, q33a == 12 ~ 375, q33a == 13 ~ 425, q33a == 14 ~ 500, q33a == 15 ~ 600, q33a == 16 ~ 700, q33a == 17 ~ 800, q33a == 18 ~ 900, q33a == 19 ~ 1000, q33a == 20 ~ 1100, q33a == 21 ~ 1200, q33a == 22 ~ 1300, q33a == 23 ~ 1400, q33a == 24 ~ 1500, q33a == 25 ~ 1600, q33a == 26 ~ 1700, q33a == 27 ~ 1800, q33a == 28 ~ 1900, q33a == 29 ~ 2000, q33a == 30 ~ 2050 * 1.4)) %&gt;% mutate(workhour = if_else(q02f_d &lt; 98, q02f_d, NA_real_)) %&gt;% mutate(workmonth = case_when( q02f_m &lt; 98 ~ q02f_m, (q02f_m == 98 | q02f_m == 99) &amp; q02f_w &lt; 8 ~ q02f_w * 4, (q02f_m == 98 | q02f_m == 99) &amp; (q02f_w == 8 | q02f_w == 9) ~ NA_real_ )) %&gt;% mutate(wage = income * 10000 / (workhour * workmonth * 12)) ssm %&gt;% head() ## # A tibble: 6 × 8 ## q02f_d q02f_w q02f_m q33a income workhour workmonth wage ## &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 8 5 99 3 37.5 8 20 195. ## 2 4 4 99 5 87.5 4 16 1139. ## 3 10 99 20 12 375 10 20 1562. ## 4 9 99 15 9 225 9 15 1389. ## 5 12 5 99 10 275 12 20 955. ## 6 5 1 99 4 62.5 5 4 2604. SSM2005では年収についての質問項目の選択肢に「2050万円以上」というカテゴリがあり、このカテゴリを選んだ回答者の年収が実際にどれくらいの値であるのかはわからない。2051万円かもしれないし、1億円かもしれない。このような場合にどのような値を振るべきなのかについては諸説あり、よくわからない。下限（この場合は2050万円）の値に1.4をかけているものもあれば、1.2をかけているものもある。あるいは、そもそもわからないのだから欠損にすべきという考え方もある。ここでは一つの方法として1.4をかけている、すなわち、2050万円以上と回答した人の年収はだいたい2870万円くらいだと考えているわけなのだが、これが正しい方法であるかどうかはわからない。 9.4 都道府県変数の加工 たとえば居住都道府県や15歳時居住都道府県などの情報を使って、居住都道府県によって進学機会が異なるといったことを分析したいとする。データには次のように都道府県を示す変数prefが含まれているとする。 df %&gt;% head() ## # A tibble: 6 × 1 ## pref ## &lt;int&gt; ## 1 1 ## 2 2 ## 3 3 ## 4 4 ## 5 5 ## 6 6 9.4.1 都道府県にラベルをつける 上記の番号にラベルをつけるとそれぞれがどの都道府県を指すのか分かるのでより便利だろう。以下のように、ラベルをつけた変数pref_labを作成する。 df &lt;- df %&gt;% mutate(pref_lab = factor(pref, levels = 1:47, labels = c(&quot;北海道&quot;,&quot;青森&quot;,&quot;岩手&quot;,&quot;宮城&quot;,&quot;秋田&quot;,&quot;山形&quot;,&quot;福島&quot;,&quot;茨城&quot;,&quot;栃木&quot;,&quot;群馬&quot;,&quot;埼玉&quot;,&quot;千葉&quot;,&quot;東京&quot;,&quot;神奈川&quot;,&quot;新潟&quot;,&quot;富山&quot;,&quot;石川&quot;,&quot;福井&quot;,&quot;山梨&quot;,&quot;長野&quot;,&quot;岐阜&quot;,&quot;静岡&quot;,&quot;愛知&quot;,&quot;三重&quot;,&quot;滋賀&quot;,&quot;京都&quot;,&quot;大阪&quot;,&quot;兵庫&quot;,&quot;奈良&quot;,&quot;和歌山&quot;,&quot;鳥取&quot;,&quot;島根&quot;,&quot;岡山&quot;,&quot;広島&quot;,&quot;山口&quot;,&quot;徳島&quot;,&quot;香川&quot;,&quot;愛媛&quot;,&quot;高知&quot;,&quot;福岡&quot;,&quot;佐賀&quot;,&quot;長崎&quot;,&quot;熊本&quot;,&quot;大分&quot;,&quot;宮崎&quot;,&quot;鹿児島&quot;,&quot;沖縄&quot;))) 確認してみると、各値にラベルをつけた変数を作成できたことがわかる。 df %&gt;% head() ## # A tibble: 6 × 2 ## pref pref_lab ## &lt;int&gt; &lt;fct&gt; ## 1 1 北海道 ## 2 2 青森 ## 3 3 岩手 ## 4 4 宮城 ## 5 5 秋田 ## 6 6 山形 9.4.2 都道府県レベルの指標を外挿する たとえば、都道府県ごとの大学卒業者割合を用いて、大卒割合が高い都道府県ほど、大学進学率が高いという仮説を検証したいとする。このような場合には、都道府県番号ごとに大学進学率を記載したExcelファイルを別に作成して、そのファイルを読み込み、left_join()を使ってもとのデータにくっつけるとよい。たとえば、以下のような形式のExcelファイルを作るとする15。 df_indicator %&gt;% head() ## # A tibble: 6 × 2 ## pref univrate ## &lt;int&gt; &lt;dbl&gt; ## 1 1 11.3 ## 2 2 9.1 ## 3 3 9.7 ## 4 4 14.3 ## 5 5 9 ## 6 6 10.5 このデータにたとえば「df_indicator.xlsx」と名前をつけて保存し、dataフォルダに入れる。このデータを読み込む。 library(readxl) # Excelファイルを読み込むために使うパッケージ df_indicator &lt;- read_excel(&quot;data/df_indicator.xlsx&quot;) 読み込んだデータをもとのデータにくっつける。 df &lt;- df %&gt;% left_join(df_indicator, by = &quot;pref&quot;) くっつけたデータは次のようになり、たしかに作成した変数をうまく結合することができているとわかる。 df %&gt;% head() ## # A tibble: 6 × 3 ## pref pref_lab univrate ## &lt;int&gt; &lt;fct&gt; &lt;dbl&gt; ## 1 1 北海道 11.3 ## 2 2 青森 9.1 ## 3 3 岩手 9.7 ## 4 4 宮城 14.3 ## 5 5 秋田 9 ## 6 6 山形 10.5 "],["writepaper.html", "Chapter 10 論文のまとめ方 10.1 全体の構成 10.2 タイトル 10.3 要約 10.4 序論 10.5 先行研究・理論枠組み・仮説 10.6 方法 10.7 結果 10.8 結論 10.9 謝辞 10.10 参考文献 10.11 形式上の注意事項", " Chapter 10 論文のまとめ方 本章では、データ分析の結果をもとに論文をまとめる際の構成や注意事項を説明する。 もちろん、ここで紹介する形式は絶対というわけではなく、標準的な構成の一例に過ぎない。しかし、標準的な構成がどのようなものであるのかを押さえておくと、論文を書く上で何を考えればよいのか、いったい何をどのように書けばよいのか、といったことが明確になるというメリットがある。 なお、期末レポートの分量は、Microsoft Wordの左下の文字数（単語数）表記で12,000字以上〜20,000字以内とする。ただし、タイトル・名前・要約部分は文字数に含まない。参考文献は字数に含む。図表内の文字は文字数に含まないが、図表1点につき400字と換算して文字数に含める。 10.1 全体の構成 おおまかにいって、実証研究論文はIMRaD（Introduction, Methods, Results, and Discussion）とよばれる形式をとる。社会学の場合は先行研究や理論を長めに検討するため、IntroductionとMethodの間にLiterature review（先行研究の検討）あるいは、Theoretical framework（理論枠組み）といった章が入り、全部で5章の構成を標準とすることが多い。 よくある構成は次のようなものである。 タイトル 要約 序論 先行研究・理論枠組み・仮説 方法 データと分析対象 変数 分析手法 結果 記述的分析（クロス表、平均値の比較など） 回帰分析など 結論 謝辞 参考文献 以下では、一つひとつについてくわしくみていく。 一点、論文のまとめ方について注記しておく。上記のように論文の標準的な構成を示したが、これは上から順番に書いていくものではまったくない16。書けるところは先に書いてしまってもよい。また、結果を修正したり結論に変更が生じれば、それに対応して序論や先行研究の部分も変わることは普通である。執筆の過程で、さらに調べるべき先行研究が出てくることもある。何度も行き来しながら、少しずつ全体を完成させていくものである。 10.2 タイトル タイトルは、その論文が何の論文であるのかを示す最も重要な箇所となる。そのため、何をやっているのかがひと目でわかるタイトルを付けることが大事である。「期末レポート」はタイトルではない。 たとえば「XがYに与える影響」とか、「X1とX2の間にYの格差が生まれる要因」とか、そういったタイトルがつくことが多い。具体的にどのようなタイトルがついているかは、先行研究を参考にしよう。 10.3 要約 400字以内の要約をつける。要約は論文全体の内容をコンパクトにまとめたもので、要約を読めば論文の概要がわかる、というものになっている必要がある17。標準的には、次のように構成することが多い。字数がもっと長い場合には、今後の課題を加えたり、結果についてよりくわしく書く。 問題背景と先行研究の限界（1–2文） 目的・問い（1文） 方法（1文） 結果（2–3文） 結論（1文） 10.4 序論 序論は読者の関心を引きつけて自分の問いへと導く章であると同時に、論文全体の見取り図を示す章である。次の全3〜5段落程度で構成する。ちょうど、研究計画書について説明した第1章のうち、「研究背景」「研究目的・問い」で言及した内容と意識することは同じである。もちろん、データ分析を経て多かれ少なかれ研究背景や問いを修正したり発展させたり、先行研究のリサーチを進めて再検討した部分もあるだろうから、研究計画書とまったく同じに書く必要はない。 10.4.1 問題背景（1段落） 研究で扱うトピックが社会問題としてand/or社会学的に重要であることを述べる。 もちろん、「自分が関心を持った」というのは最初のモチベーションとして大事だが、「自分が関心をもった」というだけでは、他の人にとっては説得的できない。他の人にとって関心をもってもらえるような理由を述べることが大事である。 10.4.2 先行研究の検討（1–2段落） 先に述べた問題に関連して、先行研究がこれまでに何を明らかにし、何を明らかにしていないのか、あるいは先行研究に存在する限界点を提示する。 ここでは、先行研究の内容を一つひとつ詳しく述べるのではなく、調べた先行研究をまとめた全体像を示す。この全体像から、（重要であるにもかかわらず）明らかになっていないこと・解決されていない課題が何であるのかを示す。 10.4.3 研究目的と方法（1–2段落） 研究目的（問い）を提示する。「本稿では、xxxを明らかにする」「どの程度yyyなのか？」など、何をやるのかが明確になるような具体的な目的や問いを提示する。 さらに、上記の問いに答えるための方法、具体的には用いる社会調査データについて述べる。 10.5 先行研究・理論枠組み・仮説 この章では、序論で述べた背景および研究目的に照らして、必要となる情報をよりくわしくまとめ、分析への橋渡しをする。便宜的にこれを「第2章」とよぼう。通常、章の下に2–3程度の節を設ける。論文によって分け方は様々なので、これと決まった形式はない。しかし、なんでも書けばよいということではない。ここでは、いくつかの例を紹介して、どのようにこの章が構成されているのかを見ていこう。 Mugiyama, Ryota and kohei Toyonaga. 2021. “Role of Cohort Size in Trends in Class and Occupational Returns to Education at First Job: The Case of Japan.” European Sociological Review. 論文の背景と目的：高学歴化が進むと学歴（大卒資格）の価値が低下し、大卒であったとしてもよい職業には就けなくなるとされている。しかし、実は高学歴化が進んでもあまりそうした傾向が見られない社会がある。こうした社会では、高学歴化（大卒割合の増加）と並行して少子化（若いコーホートの人数の減少）が進んだために、大卒者が就くことのできるよい職業が足りなくなるといった変化が起こらなかったのではないだろうか？そこで、高学歴化と並行して少子化が進んだ社会である日本のデータを分析して、この仮説を検証する。 この論文の「第2章」は、上記の背景と問いに対応する、次の内容から構成されている。 先行研究における学歴と職業の関係に対する説明 なぜ少子化（コホートの人数の減少）が起こると大卒は有利になるのか 日本における高学歴化と少子化のトレンド（および仮説） 麦山亮太，2017，「職業経歴と結婚への移行：雇用形態・職種・企業規模と地位変化の効果における男女差」『家族社会学研究』29(2): 129-141． 論文の背景と目的：不安定な雇用は日本をはじめ先進諸国における家族形成、とりわけ結婚の遅れの原因と目されており、これは日本でも例外ではない。しかしながら、雇用形態以外の労働市場における地位は結婚への移行とどのように関係しているのか、および、地位が変わることがどのように関係しているのかといった点については十分に明らかになっていない。そこで、雇用形態だけでなく職種・企業規模がどのような効果を持つのか、および、地位の（非）変化がそれぞれ結婚に対してどのような効果を持つのかを明らかにする。 この論文の「第2章」は次の内容から構成されている。 地位と結婚への移行の関係を説明する理論 職種と企業規模はなぜ・どのように結婚への移行と関係をもつと考えられるか 地位の（非）変化はなぜ・どのように結婚への移行と関係をもつと考えられるか 上記のように、いずれも序論で提示した背景と目的から自然と論理的に導かれる疑問点に合わせて、その内容を詳述するかたちで書かれるのが理想である18。一般的にいって、「第2章」には次のような内容が書かれる傾向がある（すべて書く必要はない）。 先行研究における（現象を説明する）理論 先行研究における知見 先行研究の問題点 先行研究の問題点の克服方法 仮説とその根拠 もちろん、すぐにこのような構成を導くのはとても難しいので、はじめはお手本となる論文をみつけて、その構成をまねたりしてみるのがよい。 10.6 方法 方法では、用いるデータと分析対象、分析に使用した変数、分析手法を書く。 10.6.1 データと分析対象 第1段落では、何の調査データを使用するのか、そのデータがいつ、どのような人を対象にして、どのように収集されたのかを書く。また、このデータが研究目的に照らして適切なデータであること、その理由を書く。 第2段落では、上記調査データのうち誰を分析の対象とするのかを書く（例:25–64歳の有業の男女、ひとり親世帯のみ、etc）。可能であれば、もともとの分析対象者の人数と、欠損値（NA）を除いた後の人数とを書く。 10.6.2 変数 分析に使用する変数について書く。それぞれ、変数が何を指していて、どのように定義されたのかを正確に説明する19。「他の人が読んだら自分と同じように理解できるか」というのを意識しながら書くとよい。おおむね、このような順番で変数を説明していくことが多い： 第1段落では、従属変数について書く。変数の説明については、たとえばたんに「最終学歴」とだけ書くのではなく、どのようなカテゴリに分けたのかといったことまで書く。いくつかの変数を組み合わせて加工する場合（例：年収と労働時間を組み合わせて時間あたり賃金の変数を作成した場合）には、その手続きについても書く。一般的でない変数については、どのような質問項目でそれを尋ねているのかということについても書く。 第2段落では、独立変数について書く。とくに、最も主眼となる変数を一番はじめに書く。男女で賃金がどの程度異なるのかを分析するという場合であれば性別、ひとり親世帯出身者とふたり親世帯出身者で教育達成がどの程度異なるのかを分析するという場合であれば世帯構成（ひとり親か、ふたり親か）が、ここに書くべき変数ということになる。 第3段落では、媒介変数や交互作用の検討に使う変数について書く。男女の賃金格差が職業の違いによってどの程度説明できるのかを分析するという論文であれば、職業に関する説明がここに書くべき内容になる。 最後に、その他の統制変数について書く。ない場合は書かなくてもよい。第2段落や第3段落が極端に短いようであれば、合わせてもよい。 なお変数については見出しをつけて（箇条書きにして）、一つひとつ説明していくというスタイルもあるので、好きな書き方で書くと良い。もちろんその場合であっても、その変数がどのように作成されたのかを丁寧に説明する。 10.6.3 分析手法 どのように分析を行うかを書く。 一般的でない分析手法を使う場合には、その手法についての具体的な説明が必要。説明が必要かどうかは、聞く人の理解度によって異なる。この授業では、度数分布、クロス集計、相関係数、平均値の比較、回帰分析くらいであれば、説明は不要。それ以外の手法を使う場合には、説明を書く。 10.7 結果 結果では、どのような分析をしたのか、その結果について記述する。自身の提示した問いに関係するものだけを書き、そうでないものについては（たとえそれがどんなに興味深い内容であったとしても）書く必要はない。 表や図を使う場合、細かい数字を一つひとつ確認する必要はない。しかし、仮に読者が表や図を見なかったり、あるいはそれを読むことができる知識を持っていなかったとしても、どのような結果なのか本文だけを読めば理解できるような記述が望ましい。「もしこの授業を取っていない（=統計や社会学を勉強していない）大学の友だちがこのレポートを読んだとしたら、理解できるだろうか？」というのが一つの目安になるだろう。 原則として「結果」の部分では考察や解釈には大きく踏み込まず、結果が表すことの意味については「結論」の部分で論じる。 「第2章」の部分と同じく、結果の構成は比較的自由度が高く、必ずしも以下のように分ける必要はない。ただし、基本的には単純な分析から難しい分析へと展開していくことが多く（たとえば平均値の比較→重回帰分析）、その逆はほとんどない。 10.7.1 記述的分析 分析結果について述べる場合、まずはじめに記述的な（2変量の）分析が置かれることが多い。次項で回帰分析など他の要因を統制した分析を行う場合には、それにつながるような分析をするに留める。 10.7.2 回帰分析 前項の記述的分析を踏まえて、回帰分析などを行う。 10.8 結論 結論は研究でわかったことをまとめたうえで、考察と議論を展開し、そのインパクトについて論じる章である。以下のような内容から構成される。 10.8.1 背景と目的の再確認（1段落） 研究の背景を再確認する。 先行研究でわかっていなかったこと・不十分な点を再確認する。 研究目的あるいは問いを再確認する。 読者は論文をさかのぼって読まない。なので、改めて「序論」で示した内容を簡潔に確認し、論文で提示した問いに対する答えを述べるための準備をする。 10.8.2 分析結果の要約と解釈（2–3段落） 分析の結果を要約する。そのうえで、その結果がどのようなことを意味しているのか、考察や議論を展開する。 事前の仮説を立てたのだとしたら、それが当てはまったか、当てはまらなかったかについて書く。当てはまったとしたら、その仮説を導いたときの根拠に照らしながら、考察や議論を述べる。当てはまらなかったとしたら、なぜ当てはまらなかったのか、その原因について考察する。 10.8.3 示唆（1–2段落） 分析結果を受けて、さらに広い議論を展開する。たとえば、次のようなものが挙げられる。 政策的示唆：本研究の分析結果を踏まえれば、論文冒頭で掲げた社会問題を解決するためには、このような政策が有効なのではないか？従来は見落とされてきた、このような層への支援が必要なのではないか？etc. 学術的示唆：先行研究は主としてこのような点に焦点を当ててきたが、それでは不十分なのではないか？先行研究が提示してきた説明というのは、必ずしも正しくないのではないか？etc. もちろん、研究目的から大きく外れた議論を展開してはいけない。あくまで、分析結果（や先行研究）をもとにした自分なりの示唆・考察を述べる。 10.8.4 課題・限界（1段落） 本論文に残る課題、限界について書く。ただし、反省文ではなく、今後の研究では、このようなことを分析すると良いのではないかというような方向性を提示する。そうすると、この論文を読んだ他の人が研究を進めやすくなる。 課題や限界は、あまり長く書き過ぎないように20。できなかったことよりもできたことに目を向けよう。 10.8.5 まとめ（1段落、任意） 最後が課題で終わるとなんだか後ろ向きの印象を残してしまう。そこで最後に、「こうした課題はあるけれど、でも本論文はとても重要な貢献をしたんだよ！」ということを書く。 10.9 謝辞 社会調査データは回答者、調査の企画・実施者を含めたくさんの人の協力があってはじめて成り立っていることを忘れてはいけない。また多くの場合、既存社会調査データを二次分析する際には、謝辞の記載が求められる。既存社会調査データを借り出して論文を書いた場合には、必ずデータを利用した旨の謝辞を書く。 JGSSの場合は、こちらのページを参照して謝辞を書く。たとえばJGSS2015を利用した場合には次のような謝辞を書くことになっている： 日本版General Social Surveys（JGSS）は、大阪商業大学JGSS研究センター（文部科学大臣認定日本版総合的社会調査共同研究拠点）が、大阪商業大学の支援を得て実施している研究プロジェクトである。JGSS-2015は、JSPS科研費JP26245060、JP15H03485、JP24243057、大阪商業大学アミューズメント産業研究所、日本経済研究センター研究奨励金2014年度（岩井紀子）、労働問題に関する調査研究助成金2015年度（岩井八郎ほか）の支援を受けた。 SSJDA経由でデータを取得した場合は、次のように書く（「2005年SSM日本調査，2005」の例）： 二次分析にあたり、東京大学社会科学研究所附属社会調査・データアーカイブ研究センターSSJデータアーカイブから「2005年SSM日本調査，2005」（2015SSM調査管理委員会）の個票データの提供を受けた。 謝辞の記載方法については、データ利用の際の規約などをよく確認すること。 10.10 参考文献 本文中で引用した参考文献を記載する。参考文献は著者名のアルファベット順に並べる。引用していないものは書かない。形式については次項を参照のこと。 10.11 形式上の注意事項 形式上の注意事項は以下のとおり。なお、以下の形式を全体としてまとめたWordのテンプレートファイルを作成している。こちらにアップロードしているので、ダウンロードして上書きするかたちで使ってよい。 10.11.1 推奨するWordの設定 タイトルのフォントサイズは16pt, サブタイトルは14pt, 章タイトルは12pt, 節タイトルは11pt, その他本文は10.5ptを目安とする。 章タイトルや節タイトルのフォントはゴシック体（游ゴシック、ヒラギノ角ゴシックなど）、それ以外は明朝体（游明朝、ヒラギノ明朝など）とする。 本文中のアルファベットや半角数字、表中のフォントはTimes New Romanを推奨する。 余白は上下左右いずれも30mmとし、1行あたりの文字数は40、1ページあたりの行数は35とする。 フッターにはページ数を記載する。ページ数の位置は中央揃えとする。 10.11.2 引用の形式 原則としてauthor-date方式とする。つまり、脚注で引用文献などを示すのではなく、該当する記述の後に（筆者 出版年）を付け、末尾に参考文献としてその書誌情報を記載する方式。何らかの書籍、論文、新聞、雑誌、ウェブサイト、等々、何らかの先行研究や資料を引用するときには必ず引用を記載し、自分の主張や記述とは区別する。より細かい記載方法については「社会学評論スタイルガイド」におおむね準拠する。 本文中の記載例： 近年では男性と女性ともに非正規雇用者は正規雇用者と比べて結婚しにくいことが示されている（佐々木 2012; 麦山 2017）。 Blau and Duncan (1967)が提示した地位達成モデルでは… 10.11.3 図表の形式 原則として、表と図はそれぞれ別々の通し番号をつける。 表や図には一見してわかりやすいタイトルをつける。表や図の下には、必要に応じて出所や注をつける。 カテゴリや軸はたんにRの変数名ではなく、それが何を表しているかがわかるような名前がついている状態にする。たとえば1, 2, というふうな数値であれば「そう思う」「どちらかといえばそう思う」…などといった値が入っているほうが良いし、クロス表であれば、行と列がそれぞれ何の変数であるのかわかるようにする、といったような具合である。 表は以下のようにWord上の表機能を使ってきれいな状態にすることが好まれることが多い。表を作成する場合、罫線はできるだけ少なくし、かつ、横の罫線のみ使うというのが一般的。本資料第5–9章の各章で紹介したように、gtsummary::tbl_summary()やgtsummary::tbl_cross()、modelsummary::modelsummary()を使うことである程度きれいな表を出力することができるので、活用するとよい。 図であれば、文字が小さくなりすぎないようにする。 図表の例は先に示したテンプレート上に記載している。 10.11.4 脚注 本文の流れのうえでは不要であるが、より詳細な情報などを記載したいときには脚注を使用する21。Wordの脚注機能を使ってつける。 10.11.5 参考文献の記載例 社会学評論スタイルではサブタイトルは——（2倍ダッシュ）で表記しているが、この授業では、：（コロン）で構わない。『理論と方法』スタイル。 また英語論文のスタイルは、社会学評論スタイルではなく、American Sociological Associationスタイルにしている。これはたんに自分の好みの問題なので、統一的な形式が取られていれば別のものでも構わない。 参考文献リストはアルファベット（ABC）順で記載し、書籍とウェブサイト、日本語と英語といったふうに分けることはしない。 10.11.5.1 書籍の場合 岩間暁子，2008，『女性の就業と家族のゆくえ：格差社会のなかの変容』東京大学出版会． 浅野正彦・矢内勇生，2018，『Rによる計量政治学』オーム社． 10.11.5.2 編著書籍中の論文の場合 松浦司，2021，「有配偶者の出産意欲の日台比較」寺村絵理子編『日本・台湾の高学歴女性』晃洋書房，54–72． 10.11.5.3 雑誌論文の場合 余田翔平，2012，「子ども期の家族構造と教育達成格差」『家族社会学研究』24(1): 60–71． 永吉希久子，2012，「日本人の排外意識に対する分断労働市場の影響：JGSS-2006の分析から」『社会学評論』19–35． 10.11.5.4 英語論文の場合 Torche, Florencia. 2011. “Is a College Degree Still the Great Equalizer? Intergenerational Mobility across Levels of Schooling in the United States.” American Journal of Sociology 117(3):763–807. 10.11.5.5 英語の書籍の場合 Blau, Peter M. and Otis Dudley Duncan. 1967. The American Occupational Structure. Free Press. 10.11.5.6 翻訳書の場合 Watts, Duncan J. 2011. Everything is Obvious *Once You Know the Answer: Why Common Sense is Nonsense. Atlantic Books.（青木創訳，2014，『偶然の科学』早川書房．） 10.11.5.7 ウェブサイトの場合 内閣府，2021，「令和3年版 男女共同参画白書」内閣府男女共同参画局ホームページ．（2021年11月22日閲覧，https://www.gender.go.jp/about_danjo/whitepaper/r03/zentai/index.html） "],["reference.html", "Chapter 11 さらなる学習のための参考文献 11.1 実証研究の基礎スキル 11.2 Rの使い方 11.3 ggplotの解説 11.4 統計学・計量分析を学ぶ", " Chapter 11 さらなる学習のための参考文献 11.1 実証研究の基礎スキル 社会学（あるいは社会科学）の実証研究論文とはどのようなものか、ということについては、以下の書籍が参考になる。 明石芳彦，2018，『社会科学系論文の書き方』ミネルヴァ書房． 小熊英二，2022，『基礎からわかる論文の書き方』講談社現代新書． また、経済セミナーのシリーズは経済学を念頭に置いているもののとてもわかりやすく、参考になる部分も多いのでおすすめ。下に行くほど論文執筆の段階としてより進んだ段階にフォーカスしている。 経済セミナー編集部編，2022，『経済セミナー 2022年8・9月号：経済論文の読み方』日本評論社． 経済セミナー編集部編，2021，『経済セミナー 2021年8・9月号：経済論文の書き方［はじめの一歩編］』日本評論社． 経済セミナー編集部編，2020，『経済セミナー 2020年8・9月号：経済論文の書き方［実証編］』日本評論社． 11.2 Rの使い方 Rはtidyverseパッケージの普及以前と以後で望ましいとされる文法が大きく変わっているため、tidyverseの使用を前提としたものを使うことを強くおすすめする。また、良書ではあるのだけれど、機械学習など社会学の関心とはやや離れた内容を念頭に置いたものも多く、ぴったりの書籍は少ない。こうしたなかで、日本語で読める書籍としては、以下の書籍がとくにおすすめできる。 浅野正彦・矢内勇生，2018，『Rによる計量政治学入門』オーム社． 松村優哉・湯谷啓明・紀ノ定保礼・前田和寛，2021，『改訂2版 Rユーザのための RStudio［実践］入門：tidyverseによるモダンな分析フローの世界』技術評論社． そのほか、ウェブページでRの使い方を紹介してくれている方も多い。以下に挙げたウェブページはいずれも参考になる。 RとRStudioのインストール方法の解説 卒業論文のためのR入門 私たちのR：ベストプラクティスの探求 11.3 ggplotの解説 本資料では基本的にすべてggplot2を使って図（グラフ）を作成しているが、ggplot2による可視化は非常に優れており、さまざまな図を作ることができる。本資料で扱ったものにさらに工夫を重ねれば、より見やすい図を作ることができる。ggplot2の使い方に特化した参考文献としては以下のものが挙げられる： Chang, Winston. 2019. R Graphics Cookbook: Practical Recipes for Visualizing Data. Second Edition. O’Reilly（石井弓美子・川内崇・瀬戸山雅人訳，『Rグラフィックスクックブック：ggplot2によるグラフ作成のレシピ集』オライリー・ジャパン）． Healy, Kieran. 2019. Data Visualization: A Practical Introduction. Princeton University Press.（瓜生真也・江口哲史・三村喬生訳，『データ分析のためのデータ可視化入門』講談社．）→著者により原著のドラフトが公開されている。 11.4 統計学・計量分析を学ぶ 統計ソフトの使い方を学ぶだけではなくて、統計学や計量分析の方法についての理論的な側面も学ぶと、より適切な分析をすることにつながるだろう。 社会学の実証分析でもっともよく分析される社会調査データというのがどのような性質をもち、どのような方法で収集されているのかを知っておくと、その意味をより理解できるようになるだろう。最近だと以下の書籍はよい教科書だと思う。 轟亮・杉野勇・平澤和司編，2021，『入門・社会調査法［第4版］：2ステップで基礎から学ぶ』法律文化社． 毛塚和宏，2022，『社会科学のための統計学入門：実例からていねいに学ぶ』講談社． 計量分析にはさまざまな方法があるが、そのほとんどで基礎になっているのが回帰分析であり、回帰分析をもっともきちんと説明しているのが計量経済学の教科書である。なので、計量経済学の入門書を読むのがいろいろな計量分析の方法を学ぶ上で有益だろう。 田中隆一，2015，『計量経済学の第一歩：実証分析のススメ』有斐閣． 山本勲，2015，『実証分析のための計量経済学：正しい手法と結果の読み方』中央経済社． 西山慶彦・新谷元嗣・川口大司・奥井亮，2019，『計量経済学』有斐閣．（注：数学をやるぞという覚悟が必要です） また、最近は研究の世界でもそうでない世界でも因果推論が重要だといわれはじめて久しい。因果推論について勉強することは、仮に因果推論を使わないとしても自分が何を行っているのか、分析する際に何を考える必要があるのかを明確にする上で役に立つ。以下の書籍は内容もそこまで難しくすぎないのでおすすめできる。 中室牧子・津川友介，2017，『原因と結果の経済学』ダイヤモンド社． 松林哲也，2021，『政治学と因果推論：比較から見える政治と社会』岩波書店． 安井翔太・株式会社ホクソエム，2020，『効果検証入門：正しい比較のための因果推論／計量経済学の基礎』技術評論社． Mills, C. Wright. 1959. The Sociological Imagination. Oxford University Press.↩︎ 日本の社会調査データを合併して分析している例としてたとえば Mugiyama, Ryota &amp; Kohei Toyonaga. 2021. “Role of Cohort Size in Trends in Class and Occupational Returns to Education at First Job: The Case of Japan.” European Sociological Review. Advance Access.、打越文弥，2016，「学歴同類婚の世代間連鎖とその趨勢：大規模調査データの統合による計量分析」『家族社会学研究』28(2): 136–147．など。↩︎ 大学院生の場合は教育目的利用不可のデータであっても、研究目的でデータの利用申請を行うことができる。ただし、利用申請を行う前に必ず指導教員の了解を得ること。↩︎ Schilt, Kristen, and Matthew Wiswall. 2008. “Before and After:Gender Transitions, Human Capital, and Workplace Experiences.” The B.E.Journal of Economic Analysis &amp; Policy 8(1).↩︎ ただし日本の学術雑誌の場合は査読付きの投稿論文ではなく、特集論文などがかなりの紙幅を占めていることが多い。↩︎ たとえば日本語のレビュー論文の典型的な例としては以下のような論文がある： 平沢和司・古田和久・藤原翔，2013，「社会階層と教育研究の動向と課題：高学歴化社会における格差の構造」『教育社会学研究』93: 151–91． 後述するように、Annual Review of Sociologyというレビュー論文だけを掲載した学術雑誌もある。↩︎ レビュー論文のみを掲載している雑誌である。噂によるとこの雑誌を購読している大学は日本だとかなり少ないようだ。おそらく本学も購読していない。。↩︎ テキストによっては前者を「質的変数」、後者を「量的変数」と表記しているものもある。しかしこの呼び方は「質的研究」「量的研究」などと混同しやすいうえ、その数を数えられるという意味では「質的変数」を「量的」に扱えるというよくわからない事態が生じる。そこでここでは一貫して「カテゴリ変数」「連続変数」と表記する。また、尺度水準（比例尺度、間隔尺度、順序尺度、名義尺度）について紹介しているテキストもあるが、これらを区別しても分析上あまり意味はないのでここでは扱わない。↩︎ 実際、ある査読付き雑誌に掲載された論文が、売上高がわからないケースに対して付されていた88,888,888,888という値をNAにすることなく分析していたのではないか（実際、それをNAにすると分析の結果はまったく違うものになる）という指摘がなされたことがある。院生のころは「先行研究で言われていないような意外な結果が出たら、たいていはプログラムが間違っているものだ（だからちゃんとチェックしなさい）」とよく言われたものだった。↩︎ p-valueは「2.2e-16」という値である。後ろについているe-16というのは、「10のマイナス16乗」を意味する表記である。なので、「2.2e-16」というのは「0.000000000000000022」ということを表している。なお、大きな数字を表記するときには「2.2E+16」という表記をすることもあり、「E+16」という箇所は「10の16乗」を意味する。↩︎ たとえばshape = 20とすると、小さめの黒丸となる。shapeの種類はとてもたくさんあるので、いろいろなものを試してみるとよいだろう。↩︎ 今回のような場合を線形回帰分析 Linear regressionということもある。↩︎ 正確には、係数 - 0を標準誤差で割ることでt値を求める。自由度df（N - 推定した係数の個数）のt分布のもとで、t値の絶対値が得られたt値よりも極端な値になる確率を計算したものがここで表示されているp値である。↩︎ たとえば女性は男性と同等の数学能力を持っていたとしても、男性と比べて数学を使う分野（理系など）に進みにくい傾向がある。このような傾向があると、小中学校の間は男女で数的思考力に違いがなかったとしても、高校、大学と段階が進むにつれて数学に触れる時間に差が生じ、結果、男女の数的思考力に差が生じる。こうした傾向については数多くの研究がある（たとえば、Xie, Yu and Kimberlee A. Shauman. 2005. Women in Science: Career Processes and Outcomes. Harvard University Press.など）。↩︎ なおここでの都道府県ごとの大学卒業者割合は2010年国勢調査より取得した。卒業者に占める大学・大学院卒割合を意味する。↩︎ 締切間際に書く大学の授業のレポートはまさに上から下へと順番に書いていって見直さないものの典型かもしれないが。。。↩︎ つまり、映画の予告や小説の裏表紙のあらすじみたいに「さわりだけ触れている」ようなものはよくない。↩︎ もちろんこれは理想であって、実際に実現するのはプロの研究者であっても難しい。↩︎ ただし、論文の読者にとって自明な変数の場合はわざわざその定義までくわしく説明しないことは多い。たとえば、性別など。年齢については、年齢を連続変数として使う場合もあれば、10歳区切りなどの年齢層に区切って使う場合もあるので、どのように使うかについては説明が必要。学歴も、「最後に卒業した学校」なのか「最後に通った学校」なのか、また学歴のカテゴリ分けについても研究によって異なっているため、説明が必要。↩︎ 個人的には、結論での議論や考察に比べて課題が極端に長いと、せっかく行った研究のアピールポイントが削がれてしまうように感じてしまう。ただし、これについては課題を長々書くのが科学的に誠実な態度だと言う人もいて、好みがあると思う。↩︎ たとえばこんなふうに。↩︎ "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
