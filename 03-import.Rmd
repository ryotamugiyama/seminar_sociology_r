# データの読み込み {#import}

```{r, eval = FALSE}
library(tidyverse)
library(readxl)
library(haven)
```

## Rのサンプルデータの読み込み

Rにはいくつかのサンプルデータがあらかじめ入っており、これを読み込んで試しに分析することもできる。ここでは例としてAnscombe's Quartetのデータをみてみよう：

```{r}
anscombe
```

このデータに`df`という名前をつけて格納する。

```{r}
df <- anscombe
```

## 作業ディレクトリ上のデータの読み込み

### データを置く場所を作る{#import_dir}

前章では[プロジェクトを作成](#preparation_project)して、Rに作業を行う場所（作業ディレクトリ, working directory）を教えてあげた。この場所に、データを置くためのフォルダを別途作成しておくとよい。作成する方法は以下の2つである。

- 作業ディレクトリとして設定したフォルダを開き、右クリック→「新規フォルダ」（Mac）または「新規作成」→「フォルダ」を選択（Windows）。フォルダの名前は「data」としよう。
- 以下のコードを実行。

```{r, eval = FALSE}
dir.create("data")
```



```{r, eval = FALSE, echo = FALSE}
#githubにアップロードする用のデータを準備
download.file(url = file_url, destfile = "data/census_pop_original.csv")

df <- read_csv("data/census_pop_original.csv", locale = locale(encoding = "shift-jis")) %>% 
  select(year = 3, age_temp = 4, pop = 5, pop_male = 6, pop_female = 7) %>% 
  filter(age_temp != "総数") %>% 
  group_by(year) %>% 
  mutate(age = 1:n()) %>% 
  ungroup() %>% 
  mutate(age = factor(age, levels = 1:23, labels = c(
    "0-4", "5-9",
    "10-14", "15-19",
    "20-24", "25-29",
    "30-34", "35-39",
    "40-44", "45-49",
    "50-54", "55-59",
    "60-64", "65-69",
    "70-74", "75-79",
    "80-84", "85+", 
    "85+", "85+", 
    "85+", "85+", 
    "85+"))) %>% 
  select(-age_temp) %>% 
  group_by(year, age) %>% 
  summarize(pop = sum(pop),
            pop_male = sum(pop_male),
            pop_female = sum(pop_female))

write_excel_csv(df, "data/census_pop.csv")
write.xlsx(df, "data/census_pop.xlsx")
write_rds(df, "data/census_pop.rds")
write_dta(df, "data/census_pop.dta")
write_sav(df, "data/census_pop.sav")
```

```{r, eval = FALSE}
download.file("https://github.com/mugiyama/seminar_sociology_r/raw/master/data/census_pop.csv", destfile = "data/census_pop.csv")
download.file("https://github.com/mugiyama/seminar_sociology_r/raw/master/data/census_pop.xlsx", destfile = "data/census_pop.xlsx")
download.file("https://github.com/mugiyama/seminar_sociology_r/raw/master/data/census_pop.rds", destfile = "data/census_pop.rds")
download.file("https://github.com/mugiyama/seminar_sociology_r/raw/master/data/census_pop.sav", destfile = "data/census_pop.sav")
download.file("https://github.com/mugiyama/seminar_sociology_r/raw/master/data/census_pop.dta", destfile = "data/census_pop.dta")

```

### csv形式のファイル

`example.csv`というふうに、末尾に.csvとついているのはcsv形式といって、一つひとつの値をカンマで区切った形式である。`readr::read_csv()`でcsv形式のファイルを読み込むことができる。`readr`というのは`tidyverse`パッケージを読み込むと読み込まれるパッケージの一つである。

```{r, eval = FALSE}
df <- read_csv("data/census_pop.csv")
```

### xlsx形式のファイル

`census_pop.xlsx`というふうに、末尾に.xlsxとついている（古いExcel形式だと.xls）のはMicrosoft Excelのデータ形式である。`readxl::read_excel()`でxlsx形式のファイルを読み込むことができる。

```{r, eval = FALSE}
df <- read_excel("data/census_pop.xlsx")
```

### rds形式のファイル {#import_rds}

`census_pop.rds`というふうに、末尾に.rdsとついているのはRびデータ形式である。rds形式で保存されたデータは、Rで読み込むうえではもっとも便利な形式である（が、rds形式で社会調査の個票データが提供されることはまれ）。`readr::read_rds()`でrds形式のファイルを読み込むことができる。

```{r, eval = FALSE}
df <- read_rds("data/census_pop.rds")
```

### sav形式のファイル

`census_pop.sav`というふうに、末尾に.savとついているのはSPSSという統計ソフトのデータ形式である。SSJDAなどからデータを借りた場合にはSPSS形式であることがほとんどである。`haven::read_sav()`でsav形式のファイルを読み込むことができる。

```{r, eval = FALSE}
df <- read_sav("data/census_pop.sav")
```

### dta形式のファイル

`example.dta`というふうに、末尾に.dtaとついているのはStataという統計ソフトのデータ形式である。`haven::read_dta()`でdta形式のファイルを読み込むことができる。

```{r, eval = FALSE}
df <- read_dta("data/census_pop.dta")
```

### 文字コードに関わる問題

ファイルを読み込む際に、ファイルのなかに日本語が含まれていたりすると、エラーが起こることがある。このあたりの問題への詳しい対処は[土井翔平先生のページ](https://shohei-doi.github.io/quant_polisci/encoding-r.html)に記載されているので、参考にするとよい。

## ウェブ上のデータの読み込み

ウェブサイト上にExcel形式のファイルやcsv形式のファイルがアップロードされている場合、それを直接読み込んでくることができる。たとえば、[e-Stat上にアップロードされている国勢調査の主要時系列データ](https://www.e-stat.go.jp/stat-search/files?page=1&layout=datalist&toukei=00200521&tstat=000001011777&cycle=0&tclass1=000001094741&result_page=1&tclass2val=0)のうち、「年齢（５歳階級），男女別人口－全国（大正９年～平成27年）」のデータを読み込んでみよう。先ほどの文字コード絡みの問題があるため、`read_csv()`に少しくふうを加えている。

```{r}
file_url <- "https://www.e-stat.go.jp/stat-search/file-download?statInfId=000031524030&fileKind=1"

df <- read_csv(file_url, locale = locale(encoding = "shift-jis"))
```

Windowsユーザーの場合は以下かもしれない（未確認）

```{r, eval = FALSE}
df <- read_csv(file_url)
```

以下のようにちゃんと読み込めていることがわかる。

```{r}
df %>% head()
```

ただし、何度もアクセスするのは当該ウェブサイトのサーバーに負荷をかけてしまう。頻繁に更新されるようなファイルでなければ、自分のパソコン上にダウンロードしたほうがよいだろう。`download.file()`でファイルをダウンロードできる。

```{r}
download.file(url = file_url, destfile = "data/census_pop_original.csv")
```

ダウンロードしたデータは、これまでと同じように、csvやexcelなどの形式に対応するかたちで読み込んでやればよい。

```{r}
df <- read_csv("data/census_pop_original.csv", locale = locale(encoding = "shift-jis"))
```

Windowsユーザーの場合は以下かもしれない（未確認）

```{r, eval = FALSE}
df <- read_csv(file_url)
```

なお、先ほど紹介した各種形式の「census_pop」のデータは、今ダウンロードしてきたデータに少し手を加えて作成した練習用データである。
